# =============================================================================
# Sentry Auto-Fix with GitHub Copilot
# =============================================================================
#
# When Sentry creates a GitHub issue, this workflow assigns it to Copilot.
# Copilot coding agent then investigates the error and opens a draft fix PR.
#
# Prerequisites:
#   1. Sentry GitHub integration enabled (auto-creates issues with stack traces)
#   2. GitHub Copilot subscription (Pro, Pro+, Business, or Enterprise)
#   3. Copilot coding agent enabled in repo settings
#
# How it works:
#   Sentry error → alert fires → GitHub issue created → workflow assigns
#   Copilot via REST API → Copilot agent reads issue → creates draft fix PR
# =============================================================================

name: Sentry Auto-Fix

on:
  issues:
    types: [opened]

jobs:
  trigger-copilot:
    # Trigger on issues that look like they came from Sentry
    if: >
      contains(github.event.issue.body, 'sentry.io') ||
      contains(github.event.issue.labels.*.name, 'sentry')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Assign Copilot to issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            await github.request(
              'POST /repos/{owner}/{repo}/issues/{issue_number}/assignees',
              {
                owner,
                repo,
                issue_number,
                assignees: ['copilot-swe-agent[bot]'],
                agent_assignment: {
                  target_repo: `${owner}/${repo}`,
                  base_branch: 'master',
                  custom_instructions: 'Read CLAUDE.md for project conventions. If the fix requires a code change, follow the PR workflow: bump version in pyproject.toml, run uv lock, update CHANGELOG.md. If this is a transient infrastructure issue (network timeout, DB connection lost), just explain why no code fix is needed and close the issue.'
                }
              }
            );
