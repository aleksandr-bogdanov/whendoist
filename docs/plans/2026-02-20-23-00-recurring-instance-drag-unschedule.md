---
version:
pr:
created: 2026-02-20
---

# Recurring Instance Drag & Unschedule

## Context

Three related issues with recurring task instances in the calendar view:

1. **Instances not draggable** — `InstanceCard` has no `useDraggable` hook, so recurring
   task instances can't be repositioned via drag-and-drop (regular tasks can).
2. **No "Unschedule" in context menu** — Instance RMB menu only has Skip/Complete/Edit Series.
   Regular task cards have Unschedule.
3. **Series time change doesn't regenerate instances** — When editing a recurring task's
   `scheduled_time` (without changing the recurrence rule), existing pending instances keep
   their old `scheduled_datetime`. This means "Edit series → remove time" doesn't work.

## Design

- **Drag to time slot** → calls `schedule_instance(id, datetime)` — reschedules this instance
- **Drag to anytime section** → calls `schedule_instance(id, null)` — clears time, shows on natural day
- **RMB → "Unschedule"** → same as drag-to-anytime — clears `scheduled_datetime`
- **RMB → "Skip"** → unchanged, marks instance as skipped (removes it entirely)
- **Edit series → change time** → regenerates all pending instances with new time

Unscheduling an instance means: "remove the specific time, show it as anytime on its
natural `instance_date`." It never removes the instance from the calendar (that's Skip).

## Changes

### 1. Backend: Accept nullable `scheduled_datetime`

**`app/routers/instances.py`** (line 30):
```python
# Change from:
scheduled_datetime: datetime
# To:
scheduled_datetime: datetime | None
```

**`app/services/recurrence_service.py`** (line 318):
```python
# Change from:
scheduled_datetime: datetime,
# To:
scheduled_datetime: datetime | None,
```

### 2. Backend: Regenerate instances when `scheduled_time` changes

**`app/routers/tasks.py`** (lines 533, 567-570):
- Track `old_scheduled_time = current.scheduled_time` alongside `old_rule`
- Extend the regeneration condition:
```python
if task.is_recurring and (
    task.recurrence_rule != old_rule
    or task.scheduled_time != old_scheduled_time
):
```

### 3. Frontend: Regenerate API types

Run `cd frontend && npx orval` to pick up the nullable `scheduled_datetime` schema change.

### 4. Frontend: Make `InstanceCard` draggable

**`frontend/src/components/calendar/day-column.tsx`** — InstanceCard component (~line 398):
- Import `useDraggable` from `@dnd-kit/core`
- Add `useDraggable({ id: \`instance-\${instance.id}\`, data: { type: "instance", instanceId: instance.id } })`
- Apply `ref={setNodeRef}`, `{...listeners}`, `{...attributes}` to the card element
- Add `opacity-50` when `isDragging` (same pattern as `ScheduledTaskCard`)

### 5. Frontend: Add "Unschedule" to instance context menu

**`frontend/src/components/calendar/day-column.tsx`** — InstanceCard context menu (~line 507):
- Add "Unschedule" menu item (only when `instance.scheduled_datetime` is set)
- Handler calls `scheduleInstance.mutate({ instanceId, data: { scheduled_datetime: null } })`
- Optimistic update: remove from calendar, invalidate instance queries
- Toast with undo (restore previous `scheduled_datetime`)

### 6. Frontend: Handle instance drops in drag context

**`frontend/src/components/task/task-dnd-context.tsx`**:
- Add `parseInstanceId()` to extract instance ID from drag IDs like `instance-{id}`
- In `handleDragEnd`:
  - **Calendar overlay drop**: detect `instance-*` active ID → call `scheduleInstance` with computed datetime
  - **Anytime section drop**: detect `instance-*` active ID → call `scheduleInstance` with `null`
  - Optimistic updates + toast with undo for both cases

## Files Modified

| File | Change |
|------|--------|
| `app/routers/instances.py` | Make `scheduled_datetime` nullable in schema |
| `app/services/recurrence_service.py` | Make `scheduled_datetime` param nullable |
| `app/routers/tasks.py` | Regenerate instances on `scheduled_time` change |
| `frontend/src/api/` | Regenerated by orval |
| `frontend/src/components/calendar/day-column.tsx` | Draggable InstanceCard + Unschedule menu |
| `frontend/src/components/task/task-dnd-context.tsx` | Instance drop handling |

## Verification

1. Backend: `uv run ruff format . && uv run ruff check . && uv run pyright app/ && just test`
2. Frontend: `cd frontend && npx tsc --noEmit && npx biome check . && npm run build`
3. Manual testing:
   - Drag an instance to a different time slot → instance moves, shows at new time
   - Drag an instance to anytime section → instance moves to anytime
   - RMB → Unschedule on a scheduled instance → moves to anytime
   - Edit series → change/remove time → all pending instances update
