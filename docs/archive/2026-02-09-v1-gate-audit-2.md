# V1.0 Gate Audit — Second Pass

> Opus investigation, February 9 2026. Full codebase verification after 8 PRs merged (v0.42.3-v0.42.10).
> Method: 13 parallel code investigations across all subsystems.

---

## Scope

Verified: all 8 merged PRs, authentication, sessions, CSRF, encryption, backup/import, analytics, thought cabinet, rate limiting, middleware, background tasks, migrations, onboarding wizard, safeFetch coverage, merge regressions.

First audit: `2026-02-09-recurring-task-audit.md`, `2026-02-09-gcal-sync-audit.md`, `2026-02-09-pwa-offline-investigation.md`

---

## 1. Fix Verification — All 5 PRs Confirmed

### PR #80 (v0.42.8) — Recurring Task Race & Orphan Fixes ✅

| Fix | Status | Location |
|-----|--------|----------|
| `get_or_create_instance_for_date` catches `IntegrityError` | Confirmed | `recurrence_service.py:488-505` |
| `materialize_instances` skips duplicates | Confirmed | `recurrence_service.py:179-186` |
| `update_task` cleans up orphaned instances | Confirmed | `routers/tasks.py:537-549` (router layer, not service) |

### PR #82 (v0.42.9) — GCal Token Revocation & Crash Safety ✅

| Fix | Status | Location |
|-----|--------|----------|
| `bulk_sync()` catches `TokenRefreshError` | Confirmed | `gcal_sync.py:767-774` |
| Periodic `db.flush()` every 50 events | Confirmed | 4 locations: lines 579, 626, 696, 742 |
| `sync_task()` catches `TokenRefreshError` | Confirmed | `gcal_sync.py:276-280` |
| `sync_task_instance()` catches `TokenRefreshError` | Confirmed | `gcal_sync.py:379-383` |
| Fire-and-forget wrappers handle it | Confirmed | `routers/tasks.py:38-58, 76-102` |

### PR #81 (v0.42.10) — Offline Mutation Blocking ⚠️ Partial

| Fix | Status | Location |
|-----|--------|----------|
| `task-complete.js` blocks offline | Confirmed | Lines 85-92, 422-428 |
| `task-swipe.js` blocks offline | Confirmed | Lines 241-247, 291-297 |
| `task-dialog.js` blocks offline (save) | Confirmed | Lines 1404-1410 |
| `drag-drop.js` blocks offline (drop) | Confirmed | Lines 711-717 |

**11 secondary mutation paths still unprotected** — see New Findings H1.

### PR #76 (v0.42.4) — Service Worker Cache TTL ✅

| Fix | Status | Location |
|-----|--------|----------|
| `X-SW-Cached-At` stamped on cache writes | Confirmed | `sw.js:173` |
| 5-min TTL check on reads | Confirmed | `sw.js:186-202` (maxAge=300000) |
| `CLEAR_API_CACHE` on online event | Confirmed | `mobile-core.js:370-372` → `sw.js:346-351` |

### PR #77 (v0.42.5) — Accessibility ✅

| Fix | Status | Location |
|-----|--------|----------|
| `aria-live` announcer in base.html | Confirmed | `base.html:143` |
| `aria-roledescription` on task items | Confirmed | `_task_list.html:9` |
| `.sr-only` utility class | Confirmed | `app.css:373-383`, `tokens.css:434-444` |

---

## 2. New Findings

### HIGH

**H1. Offline mutation blocking covers 7 of 18 paths**

PR #81 blocked the 4 primary files but missed secondary mutation paths:

| Missing Check | File:Line | Risk |
|---|---|---|
| `handleComplete()` button in dialog | `task-dialog.js:1323` | Optimistic UI, then revert |
| `handleDragEnd()` unschedule | `drag-drop.js:602` | DOM removal before API |
| `executePlan()` batch scheduling | `plan-tasks.js:926` | N tasks, no network check |
| `placeTaskOnCalendar()` | `plan-tasks.js:1276` | Each placement optimistic |
| `_skipInstance()` mobile | `mobile-sheet.js:377` | Marks skipped optimistically |
| `handleAnytimeDrop()` | `drag-drop.js:1037` | Appends before API |
| `handleToggle()` preferences | `task-list-options.js:142` | UI before save |
| `handleSegmentedClick()` prefs | `task-list-options.js:171` | UI before save |
| `restoreTask()` | `task-list-options.js:353` | No check |
| `handleDelete()` dialog | `task-dialog.js:1211` | Low risk (5s delay) |
| `undoLastPlan()` | `plan-tasks.js:1034` | Low risk |

**H2. Import/wipe endpoints have NO rate limiting**

- `POST /api/v1/import/wipe` — Deletes ALL user data, callable at default 100/min
- `POST /api/v1/import/todoist` — Resource-intensive import, no limit
- `GET /api/v1/import/todoist/preview` — External Todoist API call, no limit

All in `app/routers/import_data.py`. Require auth but could be abused by compromised session.

**H3. GCal sync endpoints have NO rate limiting**

- `POST /api/v1/gcal-sync/enable` — Creates calendar in Google account
- `POST /api/v1/gcal-sync/disable` — Deletes potentially 1000s of events
- `POST /api/v1/gcal-sync/sync` — Bulk sync, expensive API calls

All in `app/routers/gcal_sync.py`.

**H4. No file upload size limit on backup import**

`POST /api/v1/backup/import` in `backup.py:79` calls `await file.read()` with no size guard. Relies on Starlette defaults which vary by version. A large payload could OOM the process.

### MEDIUM

**M1. Analytics aging stats loads ALL completed tasks**

`analytics_service.py:558-617` — `_get_aging_stats()` has no date range filter. User with 10k+ completed tasks: 5-10MB memory, 1-2s processing.

**M2. Passkey deletion has no rate limit**

`DELETE /api/v1/passkeys/{id}` at `passkeys.py:326`. Attacker could delete all passkeys, locking user out of encryption unlock.

**M3. No session.clear() before OAuth login**

`auth.py:261, 320` — Session set without clearing old session. Starlette auto-regenerates (implicitly safe) but explicit clear is defense-in-depth.

**M4. Client-side encryption timing oracle**

`crypto.js:294-302` — `decrypted !== TEST_VALUE` is not constant-time. Exploitation requires measuring client JS execution, so theoretical only.

**M5. No encryption passphrase change flow**

Users cannot change passphrase without disable→re-enable (loses all passkeys). Documented but surprising.

### LOW

**L1. Clarity migration not fully reversible** — Downgrade merges NULL-backfilled values with 'defined'.

**L2. Instance cleanup has no audit trail** — `cleanup_old_instances` permanently deletes 90+ day instances silently.

**L3. Background GCal bulk_sync has no timeout** — Unlike materialization (5-min `asyncio.wait_for`), can run indefinitely.

**L4. Wizard connection status can go stale** — Only synced on init, not polled. Multi-window edge case.

### POSITIVE

**P1. safeFetch() coverage is 100%** — Zero raw `fetch()` calls in application JS. Comprehensive grep confirmed.

**P2. Authentication & sessions solid** — CSRF on all state-changing endpoints, constant-time comparison, signed session cookies, OAuth state with 10-min timeout and cryptographic verification, rate limits on auth/demo/encryption.

**P3. Multitenancy bulletproof** — 28+ queries verified, all filter by user_id. Backup import creates records with authenticated user's ID. No cross-tenant leaks.

**P4. Security headers complete** — CSP, X-Frame-Options: DENY, X-Content-Type-Options: nosniff, Referrer-Policy all configured.

---

## 3. Deferred Item Reassessment

### Safe to Defer

All items in the Post-v1.0 Backlog are genuinely safe except one — see below.

### Should NOT Have Been Deferred

**`scheduled_time` timezone issue — ACTIVE BUG**

`recurrence_service.py:175`:
```python
scheduled_datetime=datetime.combine(occ_date, default_time, tzinfo=UTC)
```

If EST user sets 9:00 AM task, `scheduled_time` = bare `09:00:00`. Materialized as `09:00 UTC` = `04:00 EST`. Every recurring task instance is wrong by the user's UTC offset.

Reclassified from MEDIUM/deferred to **HIGH — fix before v1.0 or clearly document as known limitation**.

### Confirmed Safe to Defer

- `recurrence_rule` validation — UI always sends valid JSON. API-only risk with empty results (not corruption).
- Rapid GCal toggle — Recoverable via "Full Re-sync".
- All other recurring/GCal items — Edge cases with workarounds.

---

## 4. Regression Check — Clean

- **Version:** `pyproject.toml` = 0.42.10. Correct.
- **CHANGELOG:** All 8 entries (0.42.3–0.42.10) present, correct order, correct version numbers.
- **Merge conflicts:** No conflict markers in any file. `mobile-core.js` clean.
- **Code consistency:** All network checks use identical pattern. No duplicate functions.
- **Git history:** All 8 merge commits clean, linear history.

**No regressions from the merge process.**

---

## 5. V1.0 Gate Recommendation

### Fix-Then-Ship

**Must fix (small, high-impact):**

1. Rate limit import/wipe/GCal endpoints (6 one-line decorator additions)
2. Add file upload size check in backup import (1 guard line)
3. Document or fix `scheduled_time` timezone limitation

**Should fix (low effort, nice to have):**

4. Offline checks on `executePlan()` and `handleComplete()` (2 highest-traffic missing paths)
5. `request.session.clear()` before OAuth login (2-line change)

**Everything else is safe to defer.** Security foundations are solid. Deferred items are edge cases with documented workarounds.
