# V1.0 Gate Audit â€” Third Pass

> Opus investigation, February 9 2026. Final verification after 5 Sonnet PRs (v0.42.11â€“v0.42.15)
> and deep audit of previously unexamined areas.
>
> Method: Full lint/typecheck/test run, PR verification, then 5 parallel code investigations
> covering XSS/templates, calendar rendering, routing/error handling, mobile/passkey/cascades,
> and dependency audit.

---

## Scope

**Step 1 â€” Sonnet PR verification:** All 5 PRs (v0.42.11â€“v0.42.15) confirmed on master.

**Step 2 â€” Never-audited areas:** Template injection/XSS, calendar event rendering,
Todoist import content, error page leakage, environment variable exposure, URL routing,
CSP headers, caching correctness, task deletion cascades, mobile-specific code, passkey
edge cases, Plan My Day algorithm, demo isolation, dependency audit.

**Step 3 â€” Backlog cross-reference:** Every finding checked against CHANGELOG Post-v1.0 Backlog.

Previous audits: `2026-02-09-recurring-task-audit.md`, `2026-02-09-gcal-sync-audit.md`,
`2026-02-09-pwa-offline-investigation.md`, `2026-02-09-v1-gate-audit-2.md`.

---

## 0. Preconditions â€” All Green

| Check | Result |
|-------|--------|
| `ruff format .` | 96 files unchanged |
| `ruff check .` | All checks passed |
| `pyright app/` | 0 errors, 0 warnings |
| `just test` | 578 passed, 0 failed |

---

## 1. Sonnet PR Verification â€” All 5 Confirmed

### PR #83 (v0.42.11) â€” Rate Limit Destructive Endpoints âœ…

| Endpoint | File:Line | Decorator |
|----------|-----------|-----------|
| POST /import/wipe | `import_data.py:68-69` | `BACKUP_LIMIT` |
| GET /import/todoist/preview | `import_data.py:116-117` | `BACKUP_LIMIT` |
| POST /import/todoist | `import_data.py:180-181` | `BACKUP_LIMIT` |
| POST /gcal-sync/enable | `gcal_sync.py:201-202` | `BACKUP_LIMIT` |
| POST /gcal-sync/disable | `gcal_sync.py:282-283` | `BACKUP_LIMIT` |
| DELETE /passkeys/{id} | `passkeys.py:325-326` | `ENCRYPTION_LIMIT` |

### PR #84 (v0.42.12) â€” Backup Import Size Guard âœ…

| Fix | File:Line |
|-----|-----------|
| Size check after `file.read()` | `backup.py:83-87` |
| `BACKUP_MAX_SIZE_BYTES` constant | `constants.py:106` |

### PR #85 (v0.42.13) â€” Session Clear Before Login âœ…

| Fix | File:Line |
|-----|-----------|
| `session.clear()` before Google OAuth | `auth.py:261` |
| `session.clear()` before demo login | `auth.py:321` |

### PR #86 (v0.42.14) â€” Offline Checks on Secondary Mutations âœ…

| Fix | File:Line |
|-----|-----------|
| `handleDelete()` in task dialog | `task-dialog.js:1213` |
| `handleComplete()` in task dialog | `task-dialog.js:1333` |
| `executePlan()` in Plan My Day | `plan-tasks.js:928` |
| `_skipInstance()` in mobile sheet | `mobile-sheet.js:379` |

### PR #87 (v0.42.15) â€” Timezone Documentation âœ…

| Fix | File:Line |
|-----|-----------|
| UTC notice in recurring task form | `tasks/_task_form_content.html:101-103` |

---

## 2. New Findings

### MEDIUM

**M1. Exception messages leaked in HTTP error responses**

Five endpoints embed raw exception strings in HTTP response `detail`, potentially exposing
database schema, library internals, or file paths to the client:

| Endpoint | File:Line | Status Code | What leaks |
|----------|-----------|-------------|------------|
| Backup import (JSON) | `backup.py:102` | 400 | `f"Invalid JSON file: {e}"` â€” JSONDecodeError internals |
| Backup import (other) | `backup.py:106` | 500 | `f"Import failed: {str(e)}"` â€” any exception (DB, IO, etc.) |
| Todoist preview | `import_data.py:177` | 500 | `detail=str(e)` â€” any Todoist/DB error |
| Passkey registration | `passkeys.py:177` | 400 | `f"Registration verification failed: {e}"` â€” webauthn lib |
| Passkey authentication | `passkeys.py:264` | 400 | `f"Authentication verification failed: {e}"` â€” webauthn lib |

The global exception handler (`main.py:180`) correctly returns generic `"Internal server error"`
for uncaught exceptions â€” but these `HTTPException` raises bypass it because they're raised
explicitly with the raw exception in the detail.

The 500 errors at `backup.py:106` and `import_data.py:177` are the most concerning â€” they
could leak database error messages, connection strings, or file paths.

**Recommended action:** Fix now. Replace `str(e)` with generic messages; log the full
exception server-side only (which is already done via `logger.error`/`logger.exception`).

---

**M2. CSP `script-src` includes `'unsafe-inline'`**

`app/middleware/security.py:28`:
```
script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
```

This CSP directive has two weaknesses:

1. **`'unsafe-inline'`** â€” allows any inline `<script>` to execute. If an attacker achieves
   HTML injection, they can run arbitrary JavaScript without needing to bypass CSP.

2. **`https://cdn.jsdelivr.net`** â€” allows loading scripts from any npm package on jsdelivr.
   An attacker could publish a malicious npm package and load it via CSP-allowed URL.

The `'unsafe-inline'` is currently required because 10 templates use inline `<script>` blocks
for initialization, encryption decryption, and module loading. Removing it requires migrating
all inline scripts to external files with CSP nonces â€” a significant refactor.

**Mitigating factors:** The XSS audit found zero injection points â€” Jinja2 auto-escaping is
used consistently, no `|safe` filters, and JS code uses `escapeHtml()` or `textContent` for
all user content. The CSP weakness is defense-in-depth only.

**Recommended action:** Add to backlog. Fix requires nonce-based CSP architecture
(`script-src 'nonce-{random}'` per request, removing `'unsafe-inline'`).

---

### LOW

**L1. Import wipe doesn't unsync Google Calendar events**

`app/routers/import_data.py:84-102` â€” The `POST /import/wipe` endpoint bulk-deletes tasks
and domains using SQL DELETE. Database-level `ondelete="CASCADE"` on the
`GoogleCalendarEventSync.task_id` FK correctly cleans up sync records. However, no GCal API
call is made to delete the actual events from Google Calendar.

**Scenario:**
1. User has GCal sync enabled with 100 events
2. User calls wipe (via import flow or directly)
3. All tasks and sync records are deleted from DB
4. 100 events remain orphaned in Google Calendar
5. Next bulk_sync finds no orphans (sync records are gone) â€” events never cleaned up

**Mitigating factors:** The wipe endpoint is used during import flows (not routine usage).
Users can manually re-sync or delete the Whendoist calendar from Google Calendar settings.
Partially related to backlog item "Orphan event scenarios" but is a distinct scenario.

**Recommended action:** Add to backlog. On wipe, either call `delete_calendar` GCal API
or warn the user that GCal events will remain.

---

## 3. Verified Safe â€” No Issues Found

### XSS / Template Injection âœ…

| Area | Method | Status |
|------|--------|--------|
| Jinja2 `\|safe` filter | Grep across all templates | **Zero** instances |
| `{% autoescape false %}` | Grep across all templates | **Zero** instances |
| Task titles in templates | `_task_list.html:35`, `dashboard.html:253` | Auto-escaped or `ðŸ”’` |
| Domain names in templates | `settings.html:366-376` | Auto-escaped in data attributes |
| Google Calendar events | `dashboard.html:152, 220` | `{{ event.summary }}` auto-escaped |
| Thought content | `thoughts.html:40` | Auto-escaped or `ðŸ”’` |
| Encrypted content decryption | `dashboard.html:298-384` | Uses `textContent` (safe) |
| Task dialog domain dropdown | `task-dialog.js:826` | `escapeHtml(d.name)` |
| Drag-drop task creation | `drag-drop.js:947` | `escapeHtml(content)` |
| Date-only task elements | `drag-drop.js:1151` | `escapeHtml(content)` |
| Thoughts dynamic rows | `thoughts.html:170-185` | `escapeHtml(task.title)` |
| Wizard calendar list | `wizard.js:802-814` | `escapeHtml(cal.summary)` |

**Bottom line:** All user content (task titles, domain names, GCal event summaries, Todoist
imports, thought content) is properly escaped on output. Jinja2 auto-escaping is never
disabled, JS consistently uses `escapeHtml()` or `textContent`.

### URL Routing & Registration âœ…

- All 10 v1 routers registered in `app/routers/v1/__init__.py`
- Static files use Starlette's `StaticFiles` (prevents path traversal)
- All path parameters are typed (int task_id, int passkey_id, etc.)
- OpenAPI docs only exposed on localhost
- No unregistered or dangling routes

### Error Handling (Global) âœ…

`app/main.py:172-183` â€” Global handler catches unexpected exceptions and returns generic
`{"detail": "Internal server error"}` with no stack trace. Only the 5 explicit HTTPException
raises listed in M1 above leak details.

### Environment Variable Leakage âœ…

- No secrets in templates (`{{ settings.secret_key }}` etc.) â€” zero instances
- CSRF token properly scoped in `base.html`
- `app/config.py` reads secrets from environment only, no hardcoded fallbacks
- No API keys or secrets in JS files

### Calendar Cache Correctness âœ…

`app/services/calendar_cache.py` â€” Cache keyed by `f"{user_id}:{cal_hash}:{start}:{end}"`.
One user cannot see another user's cached events. `invalidate_user()` clears by user_id
prefix. Single-instance deployment (current) is safe. Multi-instance limitation already in
backlog under "Redis calendar cache."

### Multitenancy âœ…

Previous audit confirmed 28+ queries filter by user_id. No changes since. No cross-tenant
leaks. Backup import creates records with authenticated user's ID.

### Demo Account Isolation âœ…

- Demo identified by email suffix `@whendoist.local` â€” clean separation
- Reset handler verifies demo status before clearing (403 for real users)
- Rate limited at `DEMO_LIMIT` (3/min)
- Demo user data is fully isolated â€” no shared tables or cross-user references

### Todoist Import Content âœ…

Todoist task titles/descriptions stored as-is in the database (raw text). Rendered via
Jinja2 auto-escaping on output. No sanitization needed at storage time â€” output escaping
handles it.

### Task Deletion Cascade âœ…

Tasks are **soft-deleted** (archived) via the API, never hard-deleted. `archive_task()` sets
`status="archived"`. GCal unsync fires as a background task. Database-level FK cascades
(`ondelete="CASCADE"`) correctly handle hard deletes (import wipe). Subtask FK
(`parent_id`, `ondelete="CASCADE"`) and instance FK both cascade correctly.

### Plan My Day Algorithm âœ…

All edge cases handled:
- Zero tasks â†’ early exit with message (`plan-tasks.js:971-975`)
- More tasks than time â†’ greedy bin-packing, skips unfitting tasks
- Tasks longer than range â†’ skipped gracefully
- Overlapping events â†’ `collectOccupiedSlots()` builds gap list
- Fully booked day â†’ "Scheduled 0/N tasks" message
- Cross-day planning â†’ unified time model with section conversion
- Duration = 0 â†’ falls back to 30-minute default
- Minimum selection â†’ 15-minute floor enforced

### Concurrent Tab Behavior âœ…

No WebSocket/SSE/real-time sync. Two tabs operate independently with last-write-wins
semantics. Acceptable for a task app â€” each request gets its own DB transaction.

### Mobile Code Paths âœ… (mostly)

`mobile-core.js` â€” Pull-to-refresh, keyboard detection, gesture onboarding all work
correctly. `touchcancel` handler properly resets state. Network status detection functions.

`mobile-sheet.js` â€” `BottomSheet` constructor accepts `content` and `title` as innerHTML,
but all callers pass hardcoded HTML (never user input). `TaskActionSheet` builds content
from static HTML templates. Safe in context.

### Passkey / WebAuthn âœ…

- PRF extension failure: correctly throws user-visible error (`passkey.js:374-376`)
- No PRF: registration fails gracefully, no silent fallback
- Credential IDs: validated server-side in `passkey_service.py`
- Delete last passkey: correctly resets unlock method to "passphrase" (`passkey_service.py:298-308`)
- Register before encryption: protected by workflow (encryption must be enabled first)

### Dependencies âœ…

`pyproject.toml` dependencies reviewed. No known-vulnerable packages. All on current
major versions:
- FastAPI >=0.115.0, SQLAlchemy >=2.0.0, cryptography >=44.0.0
- webauthn >=2.5.0, sentry-sdk >=2.19.0
- slowapi >=0.1.9 (last release, no active maintenance, but functional)

---

## 4. Summary

| # | Finding | Severity | In Backlog? | Action |
|---|---------|----------|-------------|--------|
| M1 | Exception messages in HTTP responses | MEDIUM | No | Fix now |
| M2 | CSP `unsafe-inline` + jsdelivr in script-src | MEDIUM | No | Add to backlog |
| L1 | Import wipe orphans GCal events | LOW | Partially | Add to backlog |

**3 findings total (2 MEDIUM, 1 LOW).** All other audited areas are clean.

Compared to audit #2 (4 HIGH, 5 MEDIUM, 4 LOW), the codebase is substantially hardened.
The remaining issues are defense-in-depth improvements, not functional bugs or data
loss risks.
