# Whendoist v0.27.0 Code Quality Audit

**Date:** 2026-01-22
**Scope:** Python backend, JavaScript frontend
**Focus:** Code quality, refactoring opportunities, best practices adherence

---

## Executive Summary

### Overall Health: **B+ (Good)**

Whendoist demonstrates solid engineering fundamentals with clean architecture, consistent patterns, and good separation of concerns. The codebase passes all automated linting with zero errors, showing strong type discipline and code style adherence.

| Category | Score | Notes |
|----------|-------|-------|
| **Python Code Quality** | A- | Clean async patterns, proper SQLAlchemy usage, excellent type coverage |
| **JavaScript Code Quality** | B | Good module patterns, but some large files and missing linting |
| **Architecture** | A- | Clear separation of concerns, consistent patterns across layers |
| **Error Handling** | B+ | Good standardization in JS, could be more consistent in Python |
| **Maintainability** | B | Well-organized, but some files are overly long |

---

## Python Findings

### Critical Issues
*None identified.*

### High Priority

#### H1. Long Service Methods
**Location:** `app/services/task_service.py`, `app/services/backup_service.py`
**Issue:** Some methods exceed 50 lines, making them harder to test and maintain.
**Examples:**
- `TaskService.update_task()` handles many optional fields
- `BackupService.restore_backup()` handles complex restoration logic

**Recommendation:** Extract validation, transformation, and persistence into smaller private methods.

---

### Medium Priority

#### M1. Inconsistent Logging Context
**Location:** Throughout services layer
**Issue:** Some modules use structured logging with `logger.info("action", extra={...})` while others use string interpolation `logger.info(f"action for {user_id}")`.
**Recommendation:** Standardize on structured logging with `extra={}` dict for consistent log parsing.

#### M2. Repeated Multitenancy Filter Pattern
**Location:** All service files
**Issue:** The pattern `Task.user_id == self.user_id` is repeated in every query. While correct, it adds cognitive load.
**Current:**
```python
stmt = select(Task).where(Task.id == task_id, Task.user_id == self.user_id)
```
**Recommendation:** Consider a query helper or base method, though the current explicit approach is safer and more auditable.

#### M3. Optional Validation Spread Across Layers
**Location:** `app/routers/tasks.py`, `app/services/task_service.py`
**Issue:** Field validation sometimes happens in routers (Pydantic), sometimes in services, and sometimes in models.
**Recommendation:** Consolidate validation in Pydantic schemas where possible; services should assume valid input.

#### M4. Unused Imports in Some Modules
**Location:** Various files (detected during manual review)
**Issue:** Some imports like `List`, `Dict` from typing are present but not used (Python 3.13 uses built-in generics).
**Recommendation:** Run `ruff --select=F401` with fix to remove unused imports.

---

### Low Priority

#### L1. Docstring Coverage
**Location:** Services and routers
**Issue:** Most public methods have docstrings, but some utility functions lack them.
**Recommendation:** Add brief docstrings to all public functions explaining parameters and return values.

#### L2. Magic Strings in Status Values
**Location:** `app/services/task_service.py`
**Issue:** Task statuses like `"completed"`, `"pending"` are string literals.
**Current:**
```python
if task.status == "completed":
```
**Recommendation:** Use `app.constants` or Enum for status values.

#### L3. Exception Granularity
**Location:** `app/services/*.py`
**Issue:** Most services raise generic `ValueError` or `HTTPException`. Custom exceptions would improve error handling.
**Recommendation:** Consider domain-specific exceptions like `TaskNotFoundError`, `PermissionDeniedError`.

---

## JavaScript Findings

### Critical Issues
*None identified.*

### High Priority

#### H1. No JavaScript Linting
**Location:** Project-wide
**Issue:** No ESLint or similar tool configured. Code quality depends entirely on manual review.
**Impact:** Inconsistencies may creep in; no automated detection of common issues.
**Recommendation:** Add ESLint with a reasonable preset (e.g., `eslint:recommended`).

#### H2. Large File Sizes
**Location:**
- `static/js/plan-tasks.js` (1436 lines)
- `static/js/drag-drop.js` (1193 lines)
- `static/js/passkey.js` (598 lines)

**Issue:** Files exceeding 500 lines are harder to navigate and maintain.
**Recommendation:** Consider splitting into focused sub-modules:
- `plan-tasks.js` → `plan-strategies.js`, `plan-ui.js`, `plan-api.js`
- `drag-drop.js` → `drag-core.js`, `drag-calendar.js`, `drag-trash.js`

---

### Medium Priority

#### M1. Duplicated FLIP Animation Logic
**Location:** `task-complete.js:232-276`, `task-complete.js:282-336`
**Issue:** FLIP animation pattern is repeated between `moveToBottomOfDomain` and `moveToTopOfDomain`.
**Recommendation:** Extract to a shared `animateMove(element, getInsertPosition)` utility.

#### M2. Inconsistent Module Patterns
**Location:** Throughout JS files
**Issue:** Most modules use IIFE with `window.ModuleName = {...}`, but some also export the class (`window.PullToRefreshClass`). Pattern varies slightly.
**Recommendation:** Standardize on one pattern. Suggested: IIFE returning public API, optionally exposing constructor for testing.

#### M3. Magic Numbers
**Location:** Various files
**Examples:**
- `task-complete.js:137`: `setTimeout(..., 300)` - animation duration
- `mobile-core.js:309`: `5 * 60 * 1000` - refresh threshold
- `toast.js:17`: `5000` - dismiss delay
- `drag-drop.js`: Various pixel thresholds

**Recommendation:** Define constants at module top:
```javascript
const ANIMATION_DURATION_MS = 300;
const REFRESH_THRESHOLD_MS = 5 * 60 * 1000;
```

#### M4. Error Messages Not User-Friendly
**Location:** `task-complete.js:165`, other API calls
**Issue:** Generic "Failed to update task" doesn't help users understand what went wrong.
**Recommendation:** Use more specific messages when possible, or include retry hints.

---

### Low Priority

#### L1. Inconsistent null/undefined Checks
**Location:** Various files
**Issue:** Mix of `!value`, `value === null`, `value == null`, `typeof value === 'undefined'`.
**Recommendation:** Standardize. Suggested: `value == null` for null/undefined, `!value` for falsy.

#### L2. Event Listener Cleanup
**Location:** `mobile-core.js`, `drag-drop.js`
**Issue:** Some event listeners are added but never removed. Could cause issues if modules are reinitialized.
**Recommendation:** Add cleanup methods for modules that might be reinitialized.

#### L3. Console Statements
**Location:** Various files
**Issue:** `console.log`, `console.warn`, `console.error` used directly without production filtering.
**Recommendation:** Consider a debug flag or wrapper to suppress in production.

#### L4. JSDoc Coverage
**Location:** Most files have good JSDoc, but some functions lack parameter types.
**Recommendation:** Ensure all public functions have complete JSDoc with `@param` and `@returns`.

---

## Cross-Cutting Concerns

### API Contract Consistency
**Status:** Good
- All routes use `/api/v1/` prefix consistently
- JSON responses follow consistent structure
- CSRF protection properly implemented across all state-changing endpoints

### Configuration
**Status:** Good
- Constants centralized in `app/constants.py`
- Environment-based configuration properly separated
- No hardcoded secrets detected

### Logging
**Status:** Needs Improvement (Medium)
- Python: Good module-level loggers, but inconsistent message formatting
- JavaScript: `console.*` used directly without abstraction

---

## Refactoring Plan

### Phase 1: Quick Wins (Low Effort, High Impact)

| Item | Effort | Impact | Files |
|------|--------|--------|-------|
| Add ESLint configuration | 1 hour | High | `package.json`, `.eslintrc.js` |
| Extract JS constants | 2 hours | Medium | All JS files |
| Remove unused Python imports | 30 min | Low | Run `ruff --fix` |
| Standardize Python logging format | 2 hours | Medium | Services layer |

### Phase 2: Medium Effort

| Item | Effort | Impact | Files |
|------|--------|--------|-------|
| Extract FLIP animation utility | 2 hours | Medium | `task-complete.js`, new `flip-animate.js` |
| Add custom Python exceptions | 3 hours | Medium | New `app/exceptions.py`, services |
| Consolidate validation in Pydantic | 4 hours | Medium | Routers, schemas |
| Split large JS files | 4 hours | High | `plan-tasks.js`, `drag-drop.js` |

### Phase 3: Larger Refactors

| Item | Effort | Impact | Files |
|------|--------|--------|-------|
| Add TypeScript definitions | 8 hours | High | New `.d.ts` files |
| Implement JS module bundler | 8 hours | Medium | Build configuration |
| Create service base class with query helpers | 6 hours | Medium | Services layer |

---

## Positive Observations

The codebase demonstrates several engineering strengths:

1. **Zero Linting Errors**: Both `ruff` and `pyright` pass with 0 errors, 0 warnings.

2. **Consistent IIFE Pattern**: All JavaScript modules follow the same encapsulation pattern with `'use strict'` directive.

3. **Good Multitenancy Discipline**: Every database query properly filters by `user_id`. No data isolation issues detected.

4. **Clean Async Patterns**: Python async/await used correctly throughout; no blocking calls in async context.

5. **CSRF Protection**: Properly implemented with `getCSRFHeaders()` helper and server-side validation.

6. **Accessibility**: Good use of ARIA attributes (`aria-pressed`, proper button types, etc.).

7. **Mobile-First Code**: Dedicated mobile modules with proper touch handling, viewport management, and PWA support.

8. **Strategy Pattern**: `PlanTasks` module demonstrates good use of design patterns for scheduling algorithms.

9. **Optimistic UI**: Task completion uses optimistic updates with proper rollback on error.

10. **Animation Quality**: FLIP technique for smooth task movement animations shows attention to UX detail.

---

## Appendix: Files Reviewed

### Python Files

| File | Lines | Purpose |
|------|-------|---------|
| `app/services/task_service.py` | ~450 | Core task CRUD operations |
| `app/services/backup_service.py` | ~300 | Backup/restore functionality |
| `app/services/passkey_service.py` | ~250 | WebAuthn passkey management |
| `app/services/recurrence_service.py` | ~200 | Recurring task handling |
| `app/services/todoist_import.py` | ~150 | Todoist import logic |
| `app/services/todoist.py` | ~200 | Todoist API integration |
| `app/services/gcal.py` | ~300 | Google Calendar integration |
| `app/services/preferences_service.py` | ~100 | User preferences |
| `app/services/calendar_cache.py` | ~150 | Calendar caching |
| `app/services/challenge_service.py` | ~100 | Challenge management |
| `app/services/task_grouping.py` | ~150 | Task grouping logic |
| `app/services/task_sorting.py` | ~100 | Task sorting logic |
| `app/routers/tasks.py` | ~400 | Task API endpoints |
| `app/routers/pages.py` | ~250 | Page rendering routes |
| `app/routers/backup.py` | ~150 | Backup API endpoints |
| `app/routers/passkeys.py` | ~200 | Passkey API endpoints |
| `app/routers/auth.py` | ~200 | Authentication routes |
| `app/models.py` | ~500 | SQLAlchemy models |
| `app/constants.py` | ~100 | Application constants |

### JavaScript Files

| File | Lines | Purpose |
|------|-------|---------|
| `static/js/plan-tasks.js` | 1436 | Auto-scheduling with strategies |
| `static/js/drag-drop.js` | 1193 | Drag and drop scheduling |
| `static/js/passkey.js` | 598 | WebAuthn implementation |
| `static/js/task-complete.js` | 357 | Task completion handling |
| `static/js/mobile-core.js` | 427 | Mobile utilities |
| `static/js/recurrence-picker.js` | 306 | Recurrence rule UI |
| `static/js/theme.js` | 153 | Theme management |
| `static/js/error-handler.js` | 146 | Error handling utilities |
| `static/js/toast.js` | 113 | Toast notifications |
| `static/js/crypto.js` | ~200 | Encryption utilities |
| `static/js/task-dialog.js` | ~400 | Task dialog functionality |

### Linting Results

```
$ uv run ruff check . --statistics
(clean - no output)

$ uv run pyright app/
0 errors, 0 warnings, 0 informations
```

---

*Audit performed by Claude Code on 2026-01-22*
