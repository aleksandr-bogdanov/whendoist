{% extends "base.html" %}

{% block title %}Tasks - Whendoist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
<link rel="stylesheet" href="/static/css/dialog.css">
{% endblock %}

{% block content %}
{% if not google_connected %}
<div class="connection-banner">
    <a href="/auth/google">Connect Google Calendar</a> to see your events.
</div>
{% endif %}

<div class="tasks-layout">
    <!-- LEFT PANEL: Task List -->
    <section class="tasks-panel">
        <!-- Task List -->
        <div class="task-list-container">
            <!-- Column Headers (sticky, sortable) -->
            <div class="task-list-header">
                <span class="header-task">Task</span>
                <span class="header-meta">
                    <button type="button" class="header-sort" data-sort="duration" title="Sort by duration">
                        <span class="label-full">Duration</span><span class="label-compact">DUR</span>
                        <span class="sort-icon"></span>
                    </button>
                    <button type="button" class="header-sort" data-sort="impact" title="Sort by impact">
                        <span class="label-full">Impact</span><span class="label-compact">IMP</span>
                        <span class="sort-icon"></span>
                    </button>
                    <button type="button" class="header-sort active" data-sort="clarity" data-order="asc" title="Sort by clarity">
                        <span class="label-full">Clarity</span><span class="label-compact">CLR</span>
                        <span class="sort-icon">↑</span>
                    </button>
                </span>
            </div>
            <div class="task-list-scroll">
            {% if domains_with_tasks %}
                {% for domain_item in domains_with_tasks %}
                <details class="project-group" {% if domain_item.domain %}open{% endif %} data-domain-id="{{ domain_item.domain.id if domain_item.domain else 'inbox' }}">
                    <summary class="project-header">
                        <span class="project-name">
                            {% if domain_item.domain %}
                                {% if domain_item.domain.icon %}{{ domain_item.domain.icon }} {% endif %}{{ domain_item.domain.name }}
                            {% else %}
                                Inbox
                            {% endif %}
                        </span>
                    </summary>
                    <div class="task-list">
                        {% for task_item in domain_item.tasks %}
                        {% set task = task_item.task %}
                        {% set is_completed = task.status == 'completed' or task_item.instance_completed_at %}
                        <div class="task-item impact-{{ task.impact }}{% if task.scheduled_date and task.scheduled_time %} scheduled{% endif %}{% if task_item.completion_age_class %} {{ task_item.completion_age_class }}{% endif %}"
                             data-clarity="{{ task.clarity or 'none' }}"
                             data-impact="{{ task.impact or 4 }}"
                             data-task-id="{{ task.id }}"
                             data-completed="{{ '1' if is_completed else '0' }}"
                             data-duration="{{ task.duration_minutes or '' }}"
                             data-scheduled-date="{{ task.scheduled_date.isoformat() if task.scheduled_date else '' }}"
                             data-is-recurring="{{ 'true' if task.is_recurring else 'false' }}"
                             {% if not (task.scheduled_date and task.scheduled_time) %}draggable="true"{% endif %}>
                            <button class="complete-gutter complete-gutter--hover" type="button" aria-label="Complete task" aria-pressed="{{ 'true' if task.status == 'completed' else 'false' }}">
                                <span class="complete-bar"></span>
                                <span class="complete-check" aria-hidden="true">✓</span>
                            </button>
                            <div class="task-content">
                                <span class="task-text">{{ task.title }}</span>
                                {% if task_item.next_occurrence or task.scheduled_date %}
                                <span class="task-due">
                                    {% if task.is_recurring %}<span class="recurring-icon" title="Recurring task">↻</span>{% endif %}
                                    {{ (task_item.next_occurrence or task.scheduled_date).strftime('%b %d') }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="task-meta">
                                <span class="meta-duration">
                                    {% if task.duration_minutes %}
                                        {% if task.duration_minutes >= 60 %}
                                        {{ task.duration_minutes // 60 }}h{% if task.duration_minutes % 60 %}{{ task.duration_minutes % 60 }}m{% endif %}
                                        {% else %}
                                        {{ task.duration_minutes }}m
                                        {% endif %}
                                    {% else %}—{% endif %}
                                </span>
                                <span class="meta-impact impact-{{ task.impact }}">
                                    {% if task.impact == 1 %}P1
                                    {% elif task.impact == 2 %}P2
                                    {% elif task.impact == 3 %}P3
                                    {% else %}P4{% endif %}
                                </span>
                                <span class="meta-clarity clarity-{{ task.clarity or 'none' }}">
                                    {% if task.clarity %}
                                        {{ task_item.clarity_display }}
                                    {% else %}—{% endif %}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="add-task-row" data-domain-id="{{ domain_item.domain.id if domain_item.domain else '' }}">
                            <span class="add-task-text">+ Add task</span>
                        </div>
                    </div>
                </details>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <p>No tasks with domains yet.</p>
                <p>Create a domain in Settings, then promote thoughts to tasks.</p>
            </div>
            {% endif %}
        </div>
        </div>
    </section>

    <!-- RIGHT PANEL: Day Calendar Carousel -->
    <aside class="calendar-panel">
        <button type="button" id="go-to-today-btn" class="go-to-today-btn">Today</button>
        <div class="calendar-carousel" id="calendar-carousel">
            {% for day in calendar_days %}
            <div class="day-calendar{% if day.is_today %} today{% elif day.offset < 0 %} past{% else %} future{% endif %}"
                 data-day="{{ day.date.isoformat() }}"
                 data-day-name="{{ day.date.strftime('%A') }}"
                 data-day-date="{{ day.date.strftime('%B %d') }}"
                 {% if day.is_today %}id="today-calendar"{% endif %}>

                <div class="day-header">
                    <span class="day-header-date">{{ day.date.strftime('%A, %b %d') }}</span>
                    <button type="button" class="plan-day-btn" title="Plan My Day">
                        <span class="action-emoji">✨</span>
                        <span class="action-name">Plan My Day</span>
                    </button>
                </div>

                {% if day.events %}
                <div class="all-day-section">
                    {% for event in day.events if event.all_day %}
                    <div class="all-day-event">{{ event.summary }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                {# Date-only tasks banner (scheduled for this day but no specific time) - always visible #}
                <div class="date-only-banner" data-day="{{ day.date.isoformat() }}" data-droppable="anytime">
                    <span class="date-only-label">Anytime</span>
                    <div class="date-only-tasks">
                        {% for item in day.date_only_tasks %}
                        {% set item_status = item.instance.status if item.is_instance else item.task.status %}
                        <div class="date-only-task calendar-item impact-{{ item.task.impact or 4 }}{% if item.completion_age_class %} {{ item.completion_age_class }}{% endif %}"
                             data-task-id="{{ item.task.id }}"
                             data-completed="{{ '1' if item_status == 'completed' else '0' }}"
                             {% if item.is_instance %}data-instance-id="{{ item.instance.id }}" data-instance-date="{{ item.instance.instance_date.isoformat() }}"{% endif %}
                             data-duration="{{ item.duration_minutes }}"
                             data-clarity="{{ item.clarity }}"
                             data-impact="{{ item.task.impact or 4 }}"
                             draggable="true">
                            <button class="complete-gutter complete-gutter--always" type="button" aria-label="Complete task" aria-pressed="{{ 'true' if item_status == 'completed' else 'false' }}">
                                <span class="complete-bar"></span>
                                <span class="complete-check" aria-hidden="true">✓</span>
                            </button>
                            {% if item.duration_minutes %}
                            <span class="date-only-task-duration">
                                {% if item.duration_minutes >= 60 %}{{ item.duration_minutes // 60 }}h{% if item.duration_minutes % 60 %}{{ item.duration_minutes % 60 }}m{% endif %}{% else %}{{ item.duration_minutes }}m{% endif %}
                            </span>
                            {% endif %}
                            <span class="date-only-task-text">{{ item.task.title }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="hour-grid">
                    <!-- Previous evening hours (21:00-23:59 from day before) -->
                    {% set prev_day = day.date - timedelta(days=1) %}
                    {% for hour in range(21, 24) %}
                    <div class="hour-row adjacent-day prev-day" data-hour="{{ hour }}" data-actual-date="{{ prev_day.isoformat() }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true"></div>
                    </div>
                    {% endfor %}

                    <!-- Day start separator -->
                    <div class="day-separator day-start">
                        <span class="day-separator-label">Start of {{ day.date.strftime('%A') }}</span>
                    </div>

                    {% for hour in range(0, 24) %}
                    <div class="hour-row" data-hour="{{ hour }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true">
                            {% for event in day.events if not event.all_day and event.start.hour == hour %}
                            {% set duration_mins = ((event.end - event.start).total_seconds() / 60)|int %}
                            {% set height_px = (duration_mins / 60 * 60)|int %}
                            {% set top_px = (event.start.minute / 60 * 60)|int %}
                            {% set duration_class = 'duration-short' if duration_mins < 30 else ('duration-medium' if duration_mins < 60 else 'duration-long') %}
                            {% set start_mins = event.start.hour * 60 + event.start.minute %}
                            {% set end_mins = start_mins + duration_mins %}
                            <div class="calendar-event {{ duration_class }}" style="height: {{ height_px }}px; top: {{ top_px }}px;" data-start-mins="{{ start_mins }}" data-end-mins="{{ end_mins }}">
                                <div class="event-left">
                                    <span class="event-time">{{ event.start.strftime('%H:%M') }}</span>
                                    {% if duration_mins >= 30 %}
                                    <span class="event-duration">{% if duration_mins >= 60 %}{{ duration_mins // 60 }}h{% if duration_mins % 60 %}{{ duration_mins % 60 }}m{% endif %}{% else %}{{ duration_mins }}m{% endif %}</span>
                                    {% endif %}
                                </div>
                                <span class="event-title">{{ event.summary }}</span>
                            </div>
                            {% endfor %}
                            {# Scheduled native tasks #}
                            {% for scheduled in day.scheduled_tasks if scheduled.start.hour == hour %}
                            {% set duration_mins = scheduled.duration_minutes %}
                            {% set height_px = (duration_mins / 60 * 60)|int %}
                            {% set top_px = (scheduled.start.minute / 60 * 60)|int %}
                            {% set duration_class = 'duration-short' if duration_mins < 30 else ('duration-medium' if duration_mins < 60 else 'duration-long') %}
                            {% set start_mins = scheduled.start.hour * 60 + scheduled.start.minute %}
                            {% set end_mins = start_mins + duration_mins %}
                            {% set task_status = scheduled.instance.status if scheduled.is_instance else scheduled.task.status %}
                            <div class="scheduled-task calendar-item impact-{{ scheduled.task.impact or 4 }} {{ duration_class }} from-db{% if scheduled.is_instance %} recurring-instance{% endif %}{% if scheduled.completion_age_class %} {{ scheduled.completion_age_class }}{% endif %}"
                                 style="height: {{ height_px }}px; top: {{ top_px }}px;"
                                 data-task-id="{{ scheduled.task.id }}"
                                 data-completed="{{ '1' if task_status == 'completed' else '0' }}"
                                 {% if scheduled.is_instance %}data-instance-id="{{ scheduled.instance.id }}" data-instance-date="{{ scheduled.instance.instance_date.isoformat() }}"{% endif %}
                                 data-start-mins="{{ start_mins }}"
                                 data-end-mins="{{ end_mins }}"
                                 data-duration="{{ duration_mins }}"
                                 data-clarity="{{ scheduled.clarity }}"
                                 data-impact="{{ scheduled.task.impact or 4 }}">
                                <button class="complete-gutter complete-gutter--always" type="button" aria-label="Complete task" aria-pressed="{{ 'true' if task_status == 'completed' else 'false' }}">
                                    <span class="complete-bar"></span>
                                    <span class="complete-check" aria-hidden="true">✓</span>
                                </button>
                                <div class="scheduled-task-left">
                                    <span class="scheduled-task-time">{{ scheduled.start.strftime('%H:%M') }}</span>
                                    {% if duration_mins >= 30 %}
                                    <span class="scheduled-task-duration">{% if duration_mins >= 60 %}{{ duration_mins // 60 }}h{% if duration_mins % 60 %}{{ duration_mins % 60 }}m{% endif %}{% else %}{{ duration_mins }}m{% endif %}</span>
                                    {% endif %}
                                </div>
                                <span class="scheduled-task-text">{{ scheduled.task.title }}{% if scheduled.is_instance %}<span class="occurrence-day" title="Occurrence: {{ scheduled.instance.instance_date.strftime('%A, %b %d') }}">{{ scheduled.instance.instance_date.strftime('%a') }}</span>{% endif %}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Day end separator -->
                    <div class="day-separator day-end">
                        <span class="day-separator-label">End of {{ day.date.strftime('%A') }}</span>
                    </div>

                    <!-- Next morning hours (00:00-05:59 from day after) -->
                    {% set next_day = day.date + timedelta(days=1) %}
                    {% for hour in range(0, 6) %}
                    <div class="hour-row adjacent-day next-day" data-hour="{{ hour }}" data-actual-date="{{ next_day.isoformat() }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>
</div>

<!-- Add Task FAB -->
<button type="button" class="add-task-btn" aria-label="Add Task"></button>
{% endblock %}

{% block scripts %}
<script src="/static/js/recurrence-picker.js"></script>
<script src="/static/js/task-dialog.js"></script>
<script src="/static/js/energy-selector.js"></script>
<script src="/static/js/task-sort.js"></script>
<script src="/static/js/task-complete.js"></script>
<script src="/static/js/drag-drop.js"></script>
<script src="/static/js/plan-tasks.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Scroll carousel to today's calendar
    const todayCalendar = document.getElementById('today-calendar');
    if (todayCalendar) {
        todayCalendar.scrollIntoView({ behavior: 'instant', inline: 'center' });
    }

    // Add "now" line to today's calendar and scroll to it
    const todayHourGrid = todayCalendar?.querySelector('.hour-grid');
    if (todayHourGrid) {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const hourHeight = 60; // px per hour (matches CSS min-height)

        // Find the current hour's row (not adjacent-day) and calculate position
        const currentHourRow = todayHourGrid.querySelector(`.hour-row[data-hour="${currentHour}"]:not(.adjacent-day)`);
        if (currentHourRow) {
            const topPosition = currentHourRow.offsetTop + (currentMinute / 60 * hourHeight);

            // Create now line element
            const nowLine = document.createElement('div');
            nowLine.className = 'now-line';
            nowLine.style.top = `${topPosition}px`;
            todayHourGrid.appendChild(nowLine);

            // Scroll to show current time (centered in view)
            const gridHeight = todayHourGrid.clientHeight;
            const scrollTarget = Math.max(0, topPosition - (gridHeight / 2));
            todayHourGrid.scrollTop = scrollTarget;

            // Update now line position every minute
            setInterval(() => {
                const now = new Date();
                const h = now.getHours();
                const m = now.getMinutes();
                const hourRow = todayHourGrid.querySelector(`.hour-row[data-hour="${h}"]:not(.adjacent-day)`);
                if (hourRow) {
                    nowLine.style.top = `${hourRow.offsetTop + (m / 60 * hourHeight)}px`;
                }
            }, 60000);
        }
    } else {
        // Fallback: scroll other calendars to 8am (main day hours, not adjacent)
        document.querySelectorAll('.hour-grid').forEach(grid => {
            const hourRow = grid.querySelector('.hour-row[data-hour="8"]:not(.adjacent-day)');
            if (hourRow) {
                grid.scrollTop = hourRow.offsetTop;
            }
        });
    }

    // Calculate initial overlaps for all day calendars
    document.querySelectorAll('.day-calendar').forEach(dayCalendar => {
        if (typeof recalculateOverlaps === 'function') {
            recalculateOverlaps(dayCalendar);
        }
    });

    // "Go to Today" floating button with visibility based on scroll position
    const todayBtn = document.getElementById('go-to-today-btn');
    const carousel = document.getElementById('calendar-carousel');

    if (todayBtn && todayCalendar && carousel) {
        todayBtn.addEventListener('click', () => {
            todayCalendar.scrollIntoView({ behavior: 'smooth', inline: 'start' });
        });

        // Hide button when today is visible
        const todayObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    todayBtn.classList.toggle('hidden', entry.isIntersecting);
                });
            },
            { root: carousel, threshold: 0.5 }
        );
        todayObserver.observe(todayCalendar);
    }

    // Sync vertical scroll position when switching days
    if (carousel) {
        const dayCalendars = carousel.querySelectorAll('.day-calendar');
        let lastScrollTop = null;
        let currentVisibleDay = null;

        // Track vertical scroll on each hour-grid
        dayCalendars.forEach(day => {
            const hourGrid = day.querySelector('.hour-grid');
            if (hourGrid) {
                hourGrid.addEventListener('scroll', () => {
                    lastScrollTop = hourGrid.scrollTop;
                });
            }
        });

        const dayObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        // Sync vertical scroll position to new visible day
                        if (currentVisibleDay !== entry.target && lastScrollTop !== null) {
                            const newHourGrid = entry.target.querySelector('.hour-grid');
                            if (newHourGrid) {
                                newHourGrid.scrollTop = lastScrollTop;
                            }
                        }
                        currentVisibleDay = entry.target;
                    }
                });
            },
            { root: carousel, threshold: 0.5 }
        );
        dayCalendars.forEach(day => dayObserver.observe(day));
    }
});
</script>
{% endblock %}
