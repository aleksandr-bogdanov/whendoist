{% extends "base.html" %}

{% block title %}Tasks - Whendoist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css?v={{ app_version|default('') }}">
<link rel="stylesheet" href="/static/css/dialog.css?v={{ app_version|default('') }}">
{% endblock %}

{% block content %}
{% if not google_connected %}
<div class="connection-banner">
    <a href="/auth/google">Connect Google Calendar</a> to see your events.
</div>
{% endif %}

<div class="tasks-layout">
    <!-- Mobile Tab Switcher (visible on mobile only) -->
    <div class="mobile-tabs">
        <button type="button" class="mobile-tab active" data-view="tasks" aria-selected="true">
            <span class="tab-icon"><svg width="20" height="20"><use href="/static/img/icons/ui-icons.svg#task-list"/></svg></span>
            <span class="tab-label">Tasks</span>
        </button>
        <button type="button" class="mobile-tab-add" aria-label="Add Task" title="Quick add task"><svg width="24" height="24"><use href="/static/img/icons/ui-icons.svg#plus"/></svg></button>
        <button type="button" class="mobile-tab" data-view="schedule" aria-selected="false">
            <span class="tab-icon"><svg width="20" height="20"><use href="/static/img/icons/ui-icons.svg#calendar"/></svg></span>
            <span class="tab-label">Schedule</span>
        </button>
    </div>

    <!-- LEFT PANEL: Task List -->
    <section class="tasks-panel mobile-active">
        <!-- Energy selector â€” outside scroll container so position:fixed works on mobile -->
        <div class="energy-wrapper" id="header-energy">
            <span class="energy-label">Energy</span>
            <div class="header-energy__pills">
                <button type="button" class="energy-pill" data-energy="1" aria-pressed="false" title="Zombie â€” autopilot tasks only">ðŸ§Ÿ</button>
                <button type="button" class="energy-pill active" data-energy="2" aria-pressed="true" title="Normal â€” all except brainstorm">â˜•</button>
                <button type="button" class="energy-pill" data-energy="3" aria-pressed="false" title="Focus â€” all tasks including brainstorm">ðŸ§ </button>
            </div>
            <div class="clarity-dots" id="clarity-dots">
                <span class="cdot cdot-autopilot"></span>
                <span class="cdot cdot-normal"></span>
                <span class="cdot cdot-brainstorm"></span>
            </div>
        </div>
        <!-- Task List -->
        <div class="task-list-container">
            <!-- Column Headers (sticky, sortable) â€” Two-row command center -->
            <div class="task-list-header">
                <!-- Row 1: Title + Sort Columns + Gear -->
                <div class="header-row1">
                    <!-- Back button (shown in deleted/scheduled/completed views) -->
                    <button type="button" class="header-back-btn" id="header-back-btn" hidden>
                        <svg class="icon icon-sm back-arrow" aria-hidden="true">
                            <use href="{{ url_for('static', path='img/icons/ui-icons.svg') }}#arrow-left"></use>
                        </svg>
                    </button>
                    <div class="header-view-count" id="header-view-count" hidden>
                        <span class="header-view-title" id="header-view-title"></span>
                        <span class="header-date-label" id="header-date-label">Date</span>
                    </div>
                    <!-- Domain name slot â€” populated by JS when a domain scrolls to top (mobile only) -->
                    <span class="header-domain-label" id="header-domain-label"></span>
                    <span class="header-meta" id="header-sorts">
                        <button type="button" class="header-sort active" data-sort="clarity" data-order="asc" title="Sort by clarity">
                            <span class="label-full">Clarity</span><span class="label-compact">CLR</span>
                            <span class="sort-icon">â†‘</span>
                        </button>
                        <button type="button" class="header-sort" data-sort="duration" title="Sort by duration">
                            <span class="label-full">Duration</span><span class="label-compact">DUR</span>
                            <span class="sort-icon"></span>
                        </button>
                        <button type="button" class="header-sort" data-sort="impact" title="Sort by impact">
                            <span class="label-full">Impact</span><span class="label-compact">IMP</span>
                            <span class="sort-icon"></span>
                        </button>
                    </span>
                    <div class="settings-anchor">
                        <button type="button" class="gear-btn" id="gear-btn" title="Settings" aria-haspopup="true" aria-expanded="false">âš™</button>
                        <!-- Settings Panel (replaces old 12-control dropdown) -->
                        <div class="settings-panel" id="settings-panel" hidden>
                            <div class="sp-title">Completed tasks</div>
                            <div class="sp-row">
                                <span class="sp-label">Keep visible for</span>
                                <div class="sp-seg" data-pref="completed_retention_days">
                                    <button type="button" class="seg-btn{% if user_prefs.completed_retention_days == 1 %} active{% endif %}" data-value="1">1d</button>
                                    <button type="button" class="seg-btn{% if user_prefs.completed_retention_days == 3 %} active{% endif %}" data-value="3">3d</button>
                                    <button type="button" class="seg-btn{% if user_prefs.completed_retention_days == 7 %} active{% endif %}" data-value="7">7d</button>
                                </div>
                            </div>
                            <div class="sp-row">
                                <span class="sp-label">Hide recurring after done</span>
                                <button type="button" class="option-toggle{% if user_prefs.hide_recurring_after_completion %} active{% endif %}"
                                        data-pref="hide_recurring_after_completion"
                                        aria-pressed="{{ 'true' if user_prefs.hide_recurring_after_completion else 'false' }}">
                                    <span class="toggle-track"><span class="toggle-thumb"></span></span>
                                </button>
                            </div>
                            <div class="sp-divider"></div>
                            <button class="sp-action" id="show-scheduled-tasks-btn">ðŸ“… View all scheduled</button>
                            <button class="sp-action" id="show-completed-tasks-btn">âœ“ View all completed</button>
                            <button class="sp-action sp-action--danger" id="show-deleted-tasks-btn">ðŸ—‘ View deleted</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="task-list-scroll" id="task-list-scroll">
            {% include '_task_list.html' %}
            </div>
        </div>
    </section>

    <!-- RIGHT PANEL: Day Calendar Carousel -->
    <aside class="calendar-panel" data-hour-height="{{ user_prefs.calendar_hour_height or 60 }}">
        <div class="calendar-toolbar">
            <button type="button" id="go-to-today-btn" class="go-to-today-btn">Today</button>
            <div class="zoom-controls">
                <button class="zoom-btn" data-zoom="out" title="Zoom out">âˆ’</button>
                <button class="zoom-btn" data-zoom="in" title="Zoom in">+</button>
            </div>
        </div>
        {# Shared day header â€” stays fixed above the carousel during swipe #}
        <div class="calendar-day-header" id="calendar-day-header">
            <div class="day-header-nav">
                <button type="button" class="day-nav-btn day-nav-prev" aria-label="Previous day">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <span class="day-header-date" id="current-day-label">{{ today.strftime('%A, %b %d') }}</span>
                <button type="button" class="day-nav-btn day-nav-next" aria-label="Next day">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
            <button type="button" class="plan-day-btn" id="shared-plan-day-btn" title="Plan My Day">
                <span class="action-emoji">âœ¨</span>
                <span class="action-name">Plan My Day</span>
            </button>
        </div>
        <div class="calendar-carousel" id="calendar-carousel">
            {% for day in calendar_days %}
            <div class="day-calendar{% if day.is_today %} today{% elif day.offset < 0 %} past{% else %} future{% endif %}"
                 data-day="{{ day.date.isoformat() }}"
                 data-day-name="{{ day.date.strftime('%A') }}"
                 data-day-date="{{ day.date.strftime('%B %d') }}"
                 data-day-label="{{ day.date.strftime('%A, %b %d') }}"
                 {% if day.is_today %}id="today-calendar"{% endif %}>

                <div class="pmd-hero" data-pmd-hero hidden>
                    <div class="pmd-hero-label">Plan this day</div>
                    <div class="pmd-hero-stat" data-pmd-hero-stat></div>
                    <div class="pmd-hero-sub" data-pmd-hero-sub></div>
                    <button type="button" class="pmd-hero-btn plan-day-btn" title="Plan My Day">Plan My Day</button>
                </div>

                {% if day.events %}
                <div class="all-day-section">
                    {% for event in day.events if event.all_day %}
                    <div class="all-day-event">{{ event.summary }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                {# Date-only tasks banner (scheduled for this day but no specific time) - always visible #}
                <div class="date-only-banner" data-day="{{ day.date.isoformat() }}" data-droppable="anytime">
                    <span class="date-only-label">Anytime</span>
                    <div class="date-only-tasks">
                        {% for item in day.date_only_tasks %}
                        {% set item_status = item.instance.status if item.is_instance else item.task.status %}
                        <div class="date-only-task calendar-item impact-{{ item.task.impact or 4 }}{% if item.completion_age_class %} {{ item.completion_age_class }}{% endif %}"
                             data-task-id="{{ item.task.id }}"
                             data-completed="{{ '1' if item_status == 'completed' else '0' }}"
                             {% if item.is_instance %}data-instance-id="{{ item.instance.id }}" data-instance-date="{{ item.instance.instance_date.isoformat() }}"{% endif %}
                             data-is-recurring="{{ 'true' if item.task.recurrence_rule else 'false' }}"
                             data-scheduled-date="{{ day.date.isoformat() }}"
                             data-duration="{{ item.duration_minutes }}"
                             data-clarity="{{ item.clarity }}"
                             data-impact="{{ item.task.impact or 4 }}"
                             data-title="{{ item.task.title }}"
                             draggable="true">
                            <button class="complete-gutter complete-gutter--always" type="button" aria-label="Complete task" aria-pressed="{{ 'true' if item_status == 'completed' else 'false' }}">
                                <span class="complete-bar"></span>
                                <span class="complete-check" aria-hidden="true">âœ“</span>
                            </button>
                            {% if item.duration_minutes %}
                            <span class="date-only-task-duration">
                                {% if item.duration_minutes >= 60 %}{{ item.duration_minutes // 60 }}h{% if item.duration_minutes % 60 %}{{ item.duration_minutes % 60 }}m{% endif %}{% else %}{{ item.duration_minutes }}m{% endif %}
                            </span>
                            {% endif %}
                            <span class="date-only-task-text">{% if encryption_enabled %}ðŸ”’{% else %}{{ item.task.title }}{% endif %}</span>
                            {% if item.is_instance %}<button class="calendar-quick-action" data-action="skip" type="button" aria-label="Skip this occurrence" title="Skip"><svg width="14" height="14"><use href="/static/img/icons/ui-icons.svg#skip-forward"/></svg></button>{% else %}<button class="calendar-quick-action" data-action="unschedule" type="button" aria-label="Unschedule" title="Unschedule"><svg width="14" height="14"><use href="/static/img/icons/ui-icons.svg#upload"/></svg></button>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="hour-grid">
                    <!-- Previous evening hours (21:00-23:59 from day before) -->
                    {% set prev_day = day.date - timedelta(days=1) %}
                    {% for hour in range(21, 24) %}
                    <div class="hour-row adjacent-day prev-day" data-hour="{{ hour }}" data-actual-date="{{ prev_day.isoformat() }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true"></div>
                    </div>
                    {% endfor %}

                    <!-- Day start separator -->
                    <div class="day-separator day-start">
                        <span class="day-separator-label">Start of {{ day.date.strftime('%A') }}</span>
                    </div>

                    {% for hour in range(0, 24) %}
                    <div class="hour-row" data-hour="{{ hour }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true">
                            {% set cal_hh = user_prefs.calendar_hour_height or 60 %}
                            {% for event in day.events if not event.all_day and event.start.hour == hour %}
                            {% set duration_mins = ((event.end - event.start).total_seconds() / 60)|int %}
                            {% set height_px = (duration_mins / 60 * cal_hh)|int %}
                            {% set top_px = (event.start.minute / 60 * cal_hh)|int %}
                            {% set duration_class = 'duration-short' if duration_mins < 30 else ('duration-medium' if duration_mins < 60 else 'duration-long') %}
                            {% set start_mins = event.start.hour * 60 + event.start.minute %}
                            {% set end_mins = start_mins + duration_mins %}
                            <div class="calendar-event {{ duration_class }}" style="height: {{ height_px }}px; top: {{ top_px }}px;" data-start-mins="{{ start_mins }}" data-end-mins="{{ end_mins }}">
                                <div class="event-left">
                                    <span class="event-time">{{ event.start.strftime('%H:%M') }}</span>
                                    {% if duration_mins >= 30 %}
                                    <span class="event-duration">{% if duration_mins >= 60 %}{{ duration_mins // 60 }}h{% if duration_mins % 60 %}{{ duration_mins % 60 }}m{% endif %}{% else %}{{ duration_mins }}m{% endif %}</span>
                                    {% endif %}
                                </div>
                                <span class="event-title">{{ event.summary }}</span>
                            </div>
                            {% endfor %}
                            {# Scheduled native tasks #}
                            {% for scheduled in day.scheduled_tasks if scheduled.start.hour == hour %}
                            {% set duration_mins = scheduled.duration_minutes %}
                            {% set height_px = (duration_mins / 60 * cal_hh)|int %}
                            {% set top_px = (scheduled.start.minute / 60 * cal_hh)|int %}
                            {% set duration_class = 'duration-short' if duration_mins < 30 else ('duration-medium' if duration_mins < 60 else 'duration-long') %}
                            {% set start_mins = scheduled.start.hour * 60 + scheduled.start.minute %}
                            {% set end_mins = start_mins + duration_mins %}
                            {% set task_status = scheduled.instance.status if scheduled.is_instance else scheduled.task.status %}
                            <div class="scheduled-task calendar-item impact-{{ scheduled.task.impact or 4 }} {{ duration_class }} from-db{% if scheduled.is_instance %} recurring-instance{% endif %}{% if scheduled.completion_age_class %} {{ scheduled.completion_age_class }}{% endif %}"
                                 style="height: {{ height_px }}px; top: {{ top_px }}px;"
                                 data-task-id="{{ scheduled.task.id }}"
                                 data-completed="{{ '1' if task_status == 'completed' else '0' }}"
                                 {% if scheduled.is_instance %}data-instance-id="{{ scheduled.instance.id }}" data-instance-date="{{ scheduled.instance.instance_date.isoformat() }}"{% endif %}
                                 data-is-recurring="{{ 'true' if scheduled.task.recurrence_rule else 'false' }}"
                                 data-scheduled-date="{{ day.date.isoformat() }}"
                                 data-start-mins="{{ start_mins }}"
                                 data-end-mins="{{ end_mins }}"
                                 data-duration="{{ duration_mins }}"
                                 data-clarity="{{ scheduled.clarity }}"
                                 data-impact="{{ scheduled.task.impact or 4 }}"
                                 data-title="{{ scheduled.task.title }}">
                                <button class="complete-gutter complete-gutter--always" type="button" aria-label="Complete task" aria-pressed="{{ 'true' if task_status == 'completed' else 'false' }}">
                                    <span class="complete-bar"></span>
                                    <span class="complete-check" aria-hidden="true">âœ“</span>
                                </button>
                                <div class="scheduled-task-left">
                                    <span class="scheduled-task-time">{{ scheduled.start.strftime('%H:%M') }}</span>
                                    {% if duration_mins >= 30 %}
                                    <span class="scheduled-task-duration">{% if duration_mins >= 60 %}{{ duration_mins // 60 }}h{% if duration_mins % 60 %}{{ duration_mins % 60 }}m{% endif %}{% else %}{{ duration_mins }}m{% endif %}</span>
                                    {% endif %}
                                </div>
                                <span class="scheduled-task-text">{% if encryption_enabled %}ðŸ”’{% else %}{{ scheduled.task.title }}{% endif %}{% if scheduled.is_instance %}<span class="occurrence-day" title="Occurrence: {{ scheduled.instance.instance_date.strftime('%A, %b %d') }}">{{ scheduled.instance.instance_date.strftime('%a') }}</span>{% endif %}</span>
                                {% if scheduled.is_instance %}<button class="calendar-quick-action" data-action="skip" type="button" aria-label="Skip this occurrence" title="Skip"><svg width="14" height="14"><use href="/static/img/icons/ui-icons.svg#skip-forward"/></svg></button>{% else %}<button class="calendar-quick-action" data-action="unschedule" type="button" aria-label="Unschedule" title="Unschedule"><svg width="14" height="14"><use href="/static/img/icons/ui-icons.svg#upload"/></svg></button>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Day end separator -->
                    <div class="day-separator day-end">
                        <span class="day-separator-label">End of {{ day.date.strftime('%A') }}</span>
                    </div>

                    <!-- Next morning hours (00:00-05:59 from day after) -->
                    {% set next_day = day.date + timedelta(days=1) %}
                    {% for hour in range(0, 6) %}
                    <div class="hour-row adjacent-day next-day" data-hour="{{ hour }}" data-actual-date="{{ next_day.isoformat() }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="calendar-fade-gradient"></div>
    </aside>
</div>

<!-- Add Task FAB -->
<button type="button" class="add-task-btn" aria-label="Add Task" data-shortcut="q" title="Quick add task"></button>
{% endblock %}

{% block scripts %}
<script src="/static/js/task-mutations.js"></script>
<script src="/static/js/recurrence-picker.js"></script>
<script src="/static/js/task-dialog.js"></script>
<script src="/static/js/energy-selector.js"></script>
<script src="/static/js/task-list-options.js"></script>
<script src="/static/js/task-sort.js"></script>
<script src="/static/js/task-complete.js"></script>
<script src="/static/js/drag-drop.js"></script>
<script src="/static/js/plan-tasks.js"></script>
<!-- Mobile-specific scripts -->
<script src="/static/js/mobile-tabs.js"></script>
<script src="/static/js/sticky-domain.js"></script>
<script src="/static/js/task-swipe.js"></script>
<script src="/static/js/gesture-discovery.js"></script>

<!-- E2E Encryption: Decrypt task titles and domain names on page load -->
<script>
(async function decryptEncryptedContent() {
    // Only run if encryption is enabled and key is available
    if (!Crypto.canCrypto()) {
        return;
    }

    /**
     * Check if a value looks like encrypted data (base64 with min length).
     * AES-256-GCM: 12 bytes IV + ciphertext + 16 bytes tag = min 28 bytes = ~38 base64 chars
     */
    function looksEncrypted(value) {
        if (!value || value.length < 38) return false;
        // Check if it's valid base64 (only contains base64 chars)
        return /^[A-Za-z0-9+/]+=*$/.test(value);
    }

    // Decrypt task titles
    const taskElements = document.querySelectorAll('[data-title]');
    for (const el of taskElements) {
        const title = el.dataset.title;
        if (!title) continue;

        try {
            // If it doesn't look encrypted, use as-is (plaintext)
            // Otherwise, try to decrypt
            const displayTitle = looksEncrypted(title)
                ? await Crypto.decryptField(title)
                : title;

            if (!displayTitle) continue;

            // Update the task text element
            const taskText = el.querySelector('.task-text');
            if (taskText) {
                taskText.textContent = displayTitle;
            }

            // Calendar anytime tasks
            const anytimeText = el.querySelector('.date-only-task-text');
            if (anytimeText) {
                anytimeText.textContent = displayTitle;
            }

            // Calendar scheduled tasks
            const scheduledText = el.querySelector('.scheduled-task-text');
            if (scheduledText) {
                const badge = scheduledText.querySelector('.occurrence-day');
                scheduledText.textContent = displayTitle;
                if (badge) {
                    scheduledText.appendChild(badge);
                }
            }
        } catch (e) {
            console.error('Failed to decrypt task title:', e);
            // On error, try to display the original value
            const taskText = el.querySelector('.task-text');
            if (taskText) taskText.textContent = title;
        }
    }

    // Decrypt domain names in project groups
    const domainElements = document.querySelectorAll('[data-domain-name]');
    for (const el of domainElements) {
        const name = el.dataset.domainName;
        if (!name) continue;

        try {
            // If it doesn't look encrypted, use as-is (plaintext)
            const displayName = looksEncrypted(name)
                ? await Crypto.decryptField(name)
                : name;

            if (!displayName) continue;

            const nameText = el.querySelector('.domain-name-text');
            if (nameText) {
                nameText.textContent = displayName;
            }
        } catch (e) {
            console.error('Failed to decrypt domain name:', e);
            // On error, try to display the original value
            const nameText = el.querySelector('.domain-name-text');
            if (nameText) nameText.textContent = name;
        }
    }
})();
</script>

<script>
/**
 * Scroll the calendar carousel to today and the hour-grid to the current time.
 * Extracted as a named function so MobileTabs can call it when the calendar
 * panel first becomes visible (scrollIntoView is a no-op on hidden elements).
 */
window.scrollCalendarToNow = function() {
    var todayCalendar = document.getElementById('today-calendar');
    if (todayCalendar) {
        var initHour = new Date().getHours();
        if (initHour >= 20 && todayCalendar.nextElementSibling) {
            todayCalendar.nextElementSibling.scrollIntoView({ behavior: 'instant', inline: 'start' });
        } else {
            todayCalendar.scrollIntoView({ behavior: 'instant', inline: 'center' });
        }
    }

    var todayHourGrid = todayCalendar ? todayCalendar.querySelector('.hour-grid') : null;
    if (todayHourGrid) {
        var now = new Date();
        var currentHour = now.getHours();
        var currentMinute = now.getMinutes();
        var hourHeight = parseInt(document.querySelector('.calendar-panel')?.dataset.hourHeight, 10) || 60;

        var currentHourRow = todayHourGrid.querySelector('.hour-row[data-hour="' + currentHour + '"]:not(.adjacent-day)');
        if (currentHourRow) {
            var topPosition = currentHourRow.offsetTop + (currentMinute / 60 * hourHeight);

            // Create now line if it doesn't exist yet
            var nowLine = todayHourGrid.querySelector('.now-line');
            if (!nowLine) {
                nowLine = document.createElement('div');
                nowLine.className = 'now-line';
                todayHourGrid.appendChild(nowLine);

                // Update now line position every minute
                setInterval(function() {
                    var n = new Date();
                    var h = n.getHours();
                    var m = n.getMinutes();
                    var hr = todayHourGrid.querySelector('.hour-row[data-hour="' + h + '"]:not(.adjacent-day)');
                    if (hr) {
                        nowLine.style.top = (hr.offsetTop + (m / 60 * hourHeight)) + 'px';
                    }
                }, 60000);
            }
            nowLine.style.top = topPosition + 'px';

            // Scroll to show current time (centered in view)
            var gridHeight = todayHourGrid.clientHeight;
            var scrollTarget = Math.max(0, topPosition - (gridHeight / 2));
            todayHourGrid.scrollTop = scrollTarget;
        }
    } else {
        // Fallback: scroll other calendars to 8am (main day hours, not adjacent)
        document.querySelectorAll('.hour-grid').forEach(function(grid) {
            var hourRow = grid.querySelector('.hour-row[data-hour="8"]:not(.adjacent-day)');
            if (hourRow) {
                grid.scrollTop = hourRow.offsetTop;
            }
        });
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Reconcile stale cached "today" â€” PWA may serve week-old HTML
    (function() {
        const carousel = document.getElementById('calendar-carousel');
        if (!carousel) return;

        // Get client's today in YYYY-MM-DD format (local timezone)
        const now = new Date();
        const clientToday = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0');

        const serverToday = document.getElementById('today-calendar');

        // If server's "today" already matches client's today, nothing to do
        if (serverToday && serverToday.dataset.day === clientToday) return;

        // Try to find the real today in the rendered calendar days
        const realToday = carousel.querySelector('.day-calendar[data-day="' + clientToday + '"]');

        if (!realToday) {
            // Real today is outside the rendered range â€” page is very stale, force reload
            location.reload();
            return;
        }

        // Move today markers from stale element to correct element
        if (serverToday) {
            serverToday.removeAttribute('id');
            serverToday.classList.remove('today');
            // Stale "today" is always in the past
            serverToday.classList.add('past');
        }

        realToday.id = 'today-calendar';
        realToday.classList.remove('past', 'future');
        realToday.classList.add('today');
    })();

    // Only scroll to now if calendar is visible (not hidden behind mobile tabs)
    const calendarPanel = document.querySelector('.calendar-panel');
    const isMobile = window.matchMedia('(max-width: 900px)').matches;
    const calendarVisible = calendarPanel && (!isMobile || calendarPanel.classList.contains('mobile-active'));
    if (calendarVisible) {
        window.scrollCalendarToNow();
        // Pre-sync all hour-grids to today's scroll position
        var todayGrid = document.querySelector('#today-calendar .hour-grid');
        if (todayGrid) {
            var initScroll = todayGrid.scrollTop;
            document.querySelectorAll('.day-calendar .hour-grid').forEach(function(grid) {
                if (grid !== todayGrid) grid.scrollTop = initScroll;
            });
        }
    }

    // Calculate initial overlaps for all day calendars
    document.querySelectorAll('.day-calendar').forEach(dayCalendar => {
        if (typeof recalculateOverlaps === 'function') {
            recalculateOverlaps(dayCalendar);
        }
    });

    // "Go to Today" floating button with visibility based on scroll position
    const todayBtn = document.getElementById('go-to-today-btn');
    const todayCalendar = document.getElementById('today-calendar');
    const carousel = document.getElementById('calendar-carousel');

    if (todayBtn && todayCalendar && carousel) {
        todayBtn.addEventListener('click', () => {
            if (window.navigateToDay) {
                const todayIndex = Array.from(document.querySelectorAll('.day-calendar')).indexOf(todayCalendar);
                if (todayIndex !== -1) { window.navigateToDay(todayIndex); return; }
            }
            todayCalendar.scrollIntoView({ behavior: 'smooth', inline: 'start' });
        });

        // Hide button when today is visible
        const todayObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    todayBtn.classList.toggle('hidden', entry.isIntersecting);
                });
            },
            { root: carousel, threshold: 0.5 }
        );
        todayObserver.observe(todayCalendar);
    }

    // Sync vertical scroll position when switching days
    if (carousel) {
        const dayCalendars = carousel.querySelectorAll('.day-calendar');
        let lastScrollTop = null;
        let currentVisibleDay = null;

        // Sync vertical scroll across all hour-grids continuously
        let isSyncing = false;
        let syncRAF = null;

        function syncAllHourGrids(scrollTop) {
            if (isSyncing) return;
            lastScrollTop = scrollTop;
            if (syncRAF) return;
            syncRAF = requestAnimationFrame(() => {
                syncRAF = null;
                isSyncing = true;
                dayCalendars.forEach(day => {
                    const grid = day.querySelector('.hour-grid');
                    if (grid) grid.scrollTop = lastScrollTop;
                });
                isSyncing = false;
            });
        }

        dayCalendars.forEach(day => {
            const hourGrid = day.querySelector('.hour-grid');
            if (hourGrid) {
                hourGrid.addEventListener('scroll', () => {
                    syncAllHourGrids(hourGrid.scrollTop);
                });
            }
        });

        // Shared day header â€” update label when visible day changes
        const sharedHeader = document.getElementById('calendar-day-header');
        const dayLabel = document.getElementById('current-day-label');

        function updateSharedHeader(dayEl) {
            if (!dayEl || !sharedHeader) return;
            var label = dayEl.dataset.dayLabel || dayEl.dataset.dayName + ', ' + dayEl.dataset.dayDate;
            if (dayLabel) dayLabel.textContent = label;
            sharedHeader.dataset.currentDay = dayEl.dataset.day;
        }

        // Initialize from today-calendar
        var initDay = document.getElementById('today-calendar') || dayCalendars[0];
        if (initDay) updateSharedHeader(initDay);

        const dayObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        currentVisibleDay = entry.target;
                        updateSharedHeader(entry.target);
                        // Sync targetDayIndex so manual swipes keep nav accurate
                        const idx = Array.from(dayCalendars).indexOf(entry.target);
                        if (idx !== -1) targetDayIndex = idx;
                    }
                });
            },
            { root: carousel, threshold: 0.5 }
        );
        dayCalendars.forEach(day => dayObserver.observe(day));

        // Calendar navigation â€” track intended index to avoid mid-scroll race
        let targetDayIndex = Array.from(dayCalendars).indexOf(
            document.getElementById('today-calendar') || dayCalendars[0]
        );

        function navigateToDay(index) {
            index = Math.max(0, Math.min(index, dayCalendars.length - 1));
            targetDayIndex = index;
            // Update header immediately â€” don't wait for observer
            updateSharedHeader(dayCalendars[index]);
            dayCalendars[index].scrollIntoView({ behavior: 'smooth', inline: 'start' });
        }

        // Expose for Go To Today and Plan My Day
        window.navigateToDay = navigateToDay;
        window.getTargetDayIndex = () => targetDayIndex;

        document.querySelectorAll('.day-nav-prev').forEach(btn => {
            btn.addEventListener('click', () => navigateToDay(targetDayIndex - 1));
        });

        document.querySelectorAll('.day-nav-next').forEach(btn => {
            btn.addEventListener('click', () => navigateToDay(targetDayIndex + 1));
        });

        // Desktop drag-to-swipe between calendar days
        // (Touch devices use native scroll; this only handles mouse/pen)
        (function() {
            var isDown = false;
            var isDragging = false;
            var startX, startY, scrollStart;
            var THRESHOLD = 8;

            carousel.addEventListener('pointerdown', function(e) {
                if (e.pointerType === 'touch') return;
                if (e.button !== 0) return;
                if (e.target.closest('button, a, input, select, [draggable="true"], .calendar-quick-action')) return;

                isDown = true;
                isDragging = false;
                startX = e.pageX;
                startY = e.pageY;
                scrollStart = carousel.scrollLeft;
            });

            document.addEventListener('pointermove', function(e) {
                if (!isDown || e.pointerType === 'touch') return;

                var dx = e.pageX - startX;
                var dy = e.pageY - startY;

                if (!isDragging) {
                    if (Math.abs(dx) < THRESHOLD && Math.abs(dy) < THRESHOLD) return;
                    // Vertical movement dominates â€” let hour-grid scroll normally
                    if (Math.abs(dy) > Math.abs(dx)) { isDown = false; return; }
                    isDragging = true;
                    carousel.style.scrollBehavior = 'auto';
                    carousel.style.scrollSnapType = 'none';
                    carousel.style.cursor = 'grabbing';
                }

                e.preventDefault();
                carousel.scrollLeft = scrollStart - dx;
            });

            document.addEventListener('pointerup', function(e) {
                if (!isDown || e.pointerType === 'touch') return;
                var wasDragging = isDragging;
                isDown = false;
                isDragging = false;

                if (wasDragging) {
                    carousel.style.scrollBehavior = '';
                    carousel.style.scrollSnapType = '';
                    carousel.style.cursor = '';
                    var dx = e.pageX - startX;
                    // If dragged more than 25% of carousel width, navigate
                    if (Math.abs(dx) > carousel.offsetWidth * 0.25) {
                        navigateToDay(targetDayIndex + (dx > 0 ? -1 : 1));
                    } else {
                        navigateToDay(targetDayIndex);
                    }
                }
            });
        })();
    }

    // Plan My Day banner â€” show in evening (for tomorrow) or morning (for today)
    (function() {
        const banner = document.getElementById('pmd-banner');
        if (!banner) return;

        const hour = new Date().getHours();
        const title = document.getElementById('pmd-banner-title');
        const sub = document.getElementById('pmd-banner-sub');
        const btn = document.getElementById('pmd-banner-btn');

        // Count unscheduled active tasks
        const taskItems = document.querySelectorAll('#task-list-scroll .task-item:not(.scheduled):not([data-completed="1"])');
        const taskCount = taskItems.length;

        if (taskCount === 0) return;

        // Skip if already dismissed today
        var todayKey = 'pmd-dismissed-' + new Date().toISOString().slice(0, 10);
        if (localStorage.getItem(todayKey)) return;

        if (hour >= 18) {
            title.textContent = 'Plan tomorrow';
            sub.textContent = taskCount + ' tasks waiting to be scheduled';
            banner.hidden = false;
        } else if (hour < 11) {
            title.textContent = 'Plan your day';
            sub.textContent = taskCount + ' tasks to fill your time';
            banner.hidden = false;
        }

        btn.addEventListener('click', function() {
            const todayCal = document.getElementById('today-calendar');
            if (!todayCal) return;

            // Determine target calendar: tomorrow if evening, today otherwise
            var targetCal = (hour >= 18 && todayCal.nextElementSibling)
                ? todayCal.nextElementSibling
                : todayCal;

            // Scroll to the target calendar, then enter plan mode directly
            targetCal.scrollIntoView({ behavior: 'smooth', inline: 'start' });
            setTimeout(function() {
                if (window.PlanTasks && typeof window.PlanTasks.enterPlanMode === 'function') {
                    window.PlanTasks.enterPlanMode(targetCal);
                }
            }, 400);
        });

        var dismissBtn = document.getElementById('pmd-banner-dismiss');
        if (dismissBtn) {
            dismissBtn.addEventListener('click', function() {
                banner.hidden = true;
                localStorage.setItem(todayKey, '1');
            });
        }
    })();

    // Hero card: show when visible calendar has no events in next few hours
    (function() {
        document.querySelectorAll('.day-calendar').forEach(function(cal) {
            var hero = cal.querySelector('[data-pmd-hero]');
            if (!hero) return;

            var events = cal.querySelectorAll('.calendar-event, .scheduled-task');
            var dateOnlyTasks = cal.querySelectorAll('.date-only-task');
            var totalItems = events.length + dateOnlyTasks.length;

            if (totalItems <= 1) {
                var taskCount = document.querySelectorAll('#task-list-scroll .task-item:not([data-completed="1"])').length;
                var stat = hero.querySelector('[data-pmd-hero-stat]');
                var sub = hero.querySelector('[data-pmd-hero-sub]');
                if (stat) stat.textContent = taskCount + ' tasks ready';
                if (sub) sub.textContent = 'Fill your free time with what matters';
                hero.hidden = false;

                // Hide shared plan button if the visible day has a hero card
                var sharedPlanBtn = document.getElementById('shared-plan-day-btn');
                if (sharedPlanBtn && cal.classList.contains('today')) {
                    sharedPlanBtn.style.display = 'none';
                }
            }
        });
    })();
});
</script>

<script>
// Pending past instances â€” badge on SCHEDULED header
(async function checkPendingPastInstances() {
    try {
        const resp = await fetch('/api/v1/instances/pending-past-count');
        if (!resp.ok) return;
        const data = await resp.json();
        const count = data.pending_count;
        if (count > 0) {
            const badge = document.getElementById('past-badge');
            if (!badge) return;
            badge.textContent = count + ' past';
            badge.hidden = false;

            // Popover element (created on first click)
            let popover = null;

            badge.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                // Toggle existing popover
                if (popover && !popover.hidden) {
                    popover.hidden = true;
                    return;
                }

                // Create popover if needed
                if (!popover) {
                    popover = document.createElement('div');
                    popover.className = 'past-badge-popover';
                    popover.innerHTML =
                        '<button type="button" class="btn-sm btn-complete">Complete all</button>' +
                        '<button type="button" class="btn-sm">Skip all</button>';
                    badge.style.position = 'relative';
                    badge.appendChild(popover);

                    const btnComplete = popover.querySelector('.btn-complete');
                    const btnSkip = popover.querySelector('.btn-sm:not(.btn-complete)');

                    btnComplete.addEventListener('click', async (ev) => {
                        ev.stopPropagation();
                        const r = await fetch('/api/v1/instances/batch-past', {
                            method: 'POST',
                            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify({ action: 'complete' }),
                        });
                        if (r.ok) {
                            const result = await r.json();
                            const n = result.affected_count;
                            if (window.Toast) Toast.show(`Completed ${n} past instance${n !== 1 ? 's' : ''}`);
                            badge.hidden = true;
                            popover.hidden = true;
                        }
                    });

                    btnSkip.addEventListener('click', async (ev) => {
                        ev.stopPropagation();
                        const r = await fetch('/api/v1/instances/batch-past', {
                            method: 'POST',
                            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify({ action: 'skip' }),
                        });
                        if (r.ok) {
                            const result = await r.json();
                            const n = result.affected_count;
                            if (window.Toast) Toast.show(`Skipped ${n} past instance${n !== 1 ? 's' : ''}`);
                            badge.hidden = true;
                            popover.hidden = true;
                        }
                    });
                }

                popover.hidden = false;

                // Close popover on outside click
                const closePopover = (ev) => {
                    if (!badge.contains(ev.target)) {
                        popover.hidden = true;
                        document.removeEventListener('click', closePopover);
                    }
                };
                setTimeout(() => document.addEventListener('click', closePopover), 0);
            });
        }
    } catch (e) {
        // Non-critical
    }
})();
</script>
{% endblock %}
