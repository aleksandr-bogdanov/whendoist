{% extends "base.html" %}

{% block title %}Dashboard - Whendoist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
{% if not todoist_connected or not google_connected %}
<div class="connection-banner">
    {% if not todoist_connected %}
    <a href="/auth/todoist">Connect Todoist</a> to see your tasks.
    {% endif %}
    {% if not google_connected %}
    <a href="/auth/google">Connect Google Calendar</a> to see your events.
    {% endif %}
</div>
{% endif %}

<div class="dashboard-layout">
    <!-- LEFT PANEL: Task List -->
    <section class="tasks-panel">
        <!-- Energy Selector -->
        <div class="energy-selector">
            <span class="energy-title">YOUR CURRENT ENERGY LEVEL</span>
            <div class="energy-buttons">
                <button type="button" data-energy="1" class="energy-btn" aria-pressed="false">
                    <span class="energy-emoji">ðŸ§Ÿ</span>
                    <span class="energy-name">Zombie</span>
                </button>
                <button type="button" data-energy="2" class="energy-btn active" aria-pressed="true">
                    <span class="energy-emoji">â˜•</span>
                    <span class="energy-name">Normal</span>
                </button>
                <button type="button" data-energy="3" class="energy-btn" aria-pressed="false">
                    <span class="energy-emoji">ðŸ§ </span>
                    <span class="energy-name">Focus</span>
                </button>
            </div>
        </div>

        <!-- Commit Bar (shown when tasks are scheduled) -->
        <div class="commit-bar" id="commit-bar" style="display: none;">
            <span class="commit-count"><span id="scheduled-count">0</span> tasks scheduled</span>
            <div class="commit-actions">
                <button type="button" id="discard-btn" class="commit-action-btn discard-btn">Discard</button>
                <button type="button" id="commit-btn" class="commit-action-btn commit-btn">
                    <span class="commit-btn-text">Commit</span>
                    <span class="commit-btn-loading" style="display: none;">...</span>
                </button>
            </div>
        </div>

        <!-- Task List -->
        <div class="task-list-container">
            <!-- Column Headers (sticky) -->
            <div class="task-list-header">
                <span class="header-task">Task</span>
                <span class="header-meta">
                    <span class="header-label header-duration">Duration</span>
                    <span class="header-label header-impact">Impact</span>
                    <span class="header-label header-clarity">Clarity</span>
                </span>
            </div>
            <div class="task-list-scroll">
            {% if projects_with_tasks %}
                {# Regular projects first (not Inbox) #}
                {% for project_item in projects_with_tasks if project_item.project and project_item.project.name != 'Inbox' %}
                <details class="project-group" open>
                    <summary class="project-header">
                        <span class="project-name">{{ project_item.project.name }}</span>
                        <span class="task-count">{{ project_item.tasks|length }}</span>
                    </summary>
                    <div class="task-list">
                        {% for task_item in project_item.tasks %}
                        <div class="task-item impact-{{ task_item.task.priority }}{% if task_item.subtasks %} has-subtasks{% endif %}{% if task_item.task.due and task_item.task.due.datetime_ %} scheduled{% endif %}"
                             data-clarity="{{ task_item.metadata.clarity.value if task_item.metadata.clarity else 'none' }}"
                             data-task-id="{{ task_item.task.id }}"
                             data-duration="{{ task_item.metadata.duration_minutes or '' }}"
                             data-due-date="{{ task_item.task.due.date.isoformat() if task_item.task.due and not task_item.task.due.datetime_ else '' }}"
                             data-is-recurring="{{ 'true' if task_item.task.due and task_item.task.due.is_recurring else 'false' }}"
                             {% if not task_item.subtasks and not (task_item.task.due and task_item.task.due.datetime_) %}draggable="true"{% endif %}>
                            <div class="task-content">
                                <span class="task-text">{{ task_item.task.content }}</span>
                                {% if task_item.task.due %}
                                <span class="task-due">
                                    {% if task_item.task.due.is_recurring %}<span class="recurring-icon">â†»</span>{% endif %}
                                    {% if task_item.task.due.datetime_ %}
                                    {{ task_item.task.due.datetime_.strftime('%H:%M') }}
                                    {% else %}
                                    {{ task_item.task.due.date.strftime('%b %d') }}
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                            <div class="task-meta">
                                <span class="meta-duration">
                                    {% if task_item.metadata.duration_minutes %}
                                        {% if task_item.metadata.duration_minutes >= 60 %}
                                        {{ task_item.metadata.duration_minutes // 60 }}h{% if task_item.metadata.duration_minutes % 60 %}{{ task_item.metadata.duration_minutes % 60 }}m{% endif %}
                                        {% else %}
                                        {{ task_item.metadata.duration_minutes }}m
                                        {% endif %}
                                    {% else %}â€”{% endif %}
                                </span>
                                <span class="meta-impact impact-{{ task_item.task.priority }}">
                                    {% if task_item.task.priority == 4 %}High
                                    {% elif task_item.task.priority == 3 %}Medium
                                    {% elif task_item.task.priority == 2 %}Low
                                    {% else %}Min{% endif %}
                                </span>
                                <span class="meta-clarity clarity-{{ task_item.metadata.clarity.value if task_item.metadata.clarity else 'none' }}">
                                    {% if task_item.metadata.clarity %}
                                        {{ task_item.clarity_display }}
                                    {% else %}â€”{% endif %}
                                </span>
                            </div>
                        </div>
                        {% if task_item.subtasks %}
                        <div class="subtask-list">
                            {% for subtask in task_item.subtasks %}
                            <div class="task-item subtask impact-{{ subtask.task.priority }}{% if subtask.task.due and subtask.task.due.datetime_ %} scheduled{% endif %}"
                                 data-clarity="{{ subtask.metadata.clarity.value if subtask.metadata.clarity else 'none' }}"
                                 data-task-id="{{ subtask.task.id }}"
                                 data-duration="{{ subtask.metadata.duration_minutes or '' }}"
                                 data-due-date="{{ subtask.task.due.date.isoformat() if subtask.task.due and not subtask.task.due.datetime_ else '' }}"
                                 data-is-recurring="{{ 'true' if subtask.task.due and subtask.task.due.is_recurring else 'false' }}"
                                 {% if not (subtask.task.due and subtask.task.due.datetime_) %}draggable="true"{% endif %}>
                                <div class="task-content">
                                    <span class="task-text">{{ subtask.task.content }}</span>
                                    {% if subtask.task.due %}
                                    <span class="task-due">
                                        {% if subtask.task.due.is_recurring %}<span class="recurring-icon">â†»</span>{% endif %}
                                        {% if subtask.task.due.datetime_ %}
                                        {{ subtask.task.due.datetime_.strftime('%H:%M') }}
                                        {% else %}
                                        {{ subtask.task.due.date.strftime('%b %d') }}
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="task-meta">
                                    <span class="meta-duration">
                                        {% if subtask.metadata.duration_minutes %}
                                            {% if subtask.metadata.duration_minutes >= 60 %}
                                            {{ subtask.metadata.duration_minutes // 60 }}h{% if subtask.metadata.duration_minutes % 60 %}{{ subtask.metadata.duration_minutes % 60 }}m{% endif %}
                                            {% else %}
                                            {{ subtask.metadata.duration_minutes }}m
                                            {% endif %}
                                        {% else %}â€”{% endif %}
                                    </span>
                                    <span class="meta-impact impact-{{ subtask.task.priority }}">
                                        {% if subtask.task.priority == 4 %}High
                                        {% elif subtask.task.priority == 3 %}Medium
                                        {% elif subtask.task.priority == 2 %}Low
                                        {% else %}Min{% endif %}
                                    </span>
                                    <span class="meta-clarity clarity-{{ subtask.metadata.clarity.value if subtask.metadata.clarity else 'none' }}">
                                        {% if subtask.metadata.clarity %}
                                            {{ subtask.clarity_display }}
                                        {% else %}â€”{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </details>
                {% endfor %}
                {# Inbox at the bottom, folded by default #}
                {% for project_item in projects_with_tasks if project_item.project and project_item.project.name == 'Inbox' %}
                <details class="project-group">
                    <summary class="project-header">
                        <span class="project-name">Inbox</span>
                        <span class="task-count">{{ project_item.tasks|length }}</span>
                    </summary>
                    <div class="task-list">
                        {% for task_item in project_item.tasks %}
                        <div class="task-item impact-{{ task_item.task.priority }}{% if task_item.subtasks %} has-subtasks{% endif %}{% if task_item.task.due and task_item.task.due.datetime_ %} scheduled{% endif %}"
                             data-clarity="{{ task_item.metadata.clarity.value if task_item.metadata.clarity else 'none' }}"
                             data-task-id="{{ task_item.task.id }}"
                             data-duration="{{ task_item.metadata.duration_minutes or '' }}"
                             data-due-date="{{ task_item.task.due.date.isoformat() if task_item.task.due and not task_item.task.due.datetime_ else '' }}"
                             data-is-recurring="{{ 'true' if task_item.task.due and task_item.task.due.is_recurring else 'false' }}"
                             {% if not task_item.subtasks and not (task_item.task.due and task_item.task.due.datetime_) %}draggable="true"{% endif %}>
                            <div class="task-content">
                                <span class="task-text">{{ task_item.task.content }}</span>
                                {% if task_item.task.due %}
                                <span class="task-due">
                                    {% if task_item.task.due.is_recurring %}<span class="recurring-icon">â†»</span>{% endif %}
                                    {% if task_item.task.due.datetime_ %}
                                    {{ task_item.task.due.datetime_.strftime('%H:%M') }}
                                    {% else %}
                                    {{ task_item.task.due.date.strftime('%b %d') }}
                                    {% endif %}
                                </span>
                                {% endif %}
                            </div>
                            <div class="task-meta">
                                <span class="chip chip-duration">
                                    {% if task_item.metadata.duration_minutes %}{{ task_item.metadata.duration_display }}{% else %}â€”{% endif %}
                                </span>
                                <span class="chip chip-impact impact-{{ task_item.task.priority }}">
                                    {{ {4: 'High', 3: 'Med', 2: 'Low', 1: 'Min'}[task_item.task.priority] }}
                                </span>
                                <span class="chip chip-clarity clarity-{{ task_item.metadata.clarity.value if task_item.metadata.clarity else 'none' }}">
                                    {{ task_item.metadata.clarity.value|title if task_item.metadata.clarity else 'â€”' }}
                                </span>
                            </div>
                        </div>
                        {% if task_item.subtasks %}
                        <div class="subtask-list">
                            {% for subtask in task_item.subtasks %}
                            <div class="task-item subtask impact-{{ subtask.task.priority }}{% if subtask.task.due and subtask.task.due.datetime_ %} scheduled{% endif %}"
                                 data-clarity="{{ subtask.metadata.clarity.value if subtask.metadata.clarity else 'none' }}"
                                 data-task-id="{{ subtask.task.id }}"
                                 data-duration="{{ subtask.metadata.duration_minutes or '' }}"
                                 data-due-date="{{ subtask.task.due.date.isoformat() if subtask.task.due and not subtask.task.due.datetime_ else '' }}"
                                 data-is-recurring="{{ 'true' if subtask.task.due and subtask.task.due.is_recurring else 'false' }}"
                                 {% if not (subtask.task.due and subtask.task.due.datetime_) %}draggable="true"{% endif %}>
                                <div class="task-content">
                                    <span class="task-text">{{ subtask.task.content }}</span>
                                </div>
                                <div class="task-meta">
                                    <span class="chip chip-duration">
                                        {% if subtask.metadata.duration_minutes %}{{ subtask.metadata.duration_display }}{% else %}â€”{% endif %}
                                    </span>
                                    <span class="chip chip-impact impact-{{ subtask.task.priority }}">
                                        {{ {4: 'High', 3: 'Med', 2: 'Low', 1: 'Min'}[subtask.task.priority] }}
                                    </span>
                                    <span class="chip chip-clarity clarity-{{ subtask.metadata.clarity.value if subtask.metadata.clarity else 'none' }}">
                                        {% if subtask.metadata.clarity %}{{ subtask.metadata.clarity.value|title }}{% else %}â€”{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </details>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <p>No tasks found.</p>
                <p>Connect Todoist to see your tasks.</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- RIGHT PANEL: Day Calendar Carousel -->
    <aside class="calendar-panel">
        <div class="calendar-header">
            <span class="calendar-title">SCHEDULE</span>
            <div class="calendar-day-info" id="calendar-day-info">
                <span class="day-name">{{ calendar_days[7].date.strftime('%A') if calendar_days|length > 7 else '' }}</span>
                <span class="day-date">{{ calendar_days[7].date.strftime('%B %d') if calendar_days|length > 7 else '' }}</span>
            </div>
        </div>
        <button type="button" id="go-to-today-btn" class="go-to-today-btn">Today</button>
        <div class="calendar-carousel" id="calendar-carousel">
            {% for day in calendar_days %}
            <div class="day-calendar{% if day.is_today %} today{% elif day.offset < 0 %} past{% else %} future{% endif %}"
                 data-day="{{ day.date.isoformat() }}"
                 data-day-name="{{ day.date.strftime('%A') }}"
                 data-day-date="{{ day.date.strftime('%B %d') }}"
                 {% if day.is_today %}id="today-calendar"{% endif %}>

                {% if day.events %}
                <div class="all-day-section">
                    {% for event in day.events if event.all_day %}
                    <div class="all-day-event">{{ event.summary }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="hour-grid">
                    {% for hour in range(0, 24) %}
                    <div class="hour-row" data-hour="{{ hour }}">
                        <span class="hour-label">{{ '%02d' % hour }}:00</span>
                        <div class="hour-slot" data-droppable="true">
                            {% for event in day.events if not event.all_day and event.start.hour == hour %}
                            {% set duration_mins = ((event.end - event.start).total_seconds() / 60)|int %}
                            {% set height_px = (duration_mins / 60 * 60)|int %}
                            {% set top_px = (event.start.minute / 60 * 60)|int %}
                            {% set duration_class = 'duration-short' if duration_mins < 30 else ('duration-medium' if duration_mins < 60 else 'duration-long') %}
                            {% set start_mins = event.start.hour * 60 + event.start.minute %}
                            {% set end_mins = start_mins + duration_mins %}
                            <div class="calendar-event {{ duration_class }}" style="height: {{ height_px }}px; top: {{ top_px }}px;" data-start-mins="{{ start_mins }}" data-end-mins="{{ end_mins }}">
                                <div class="event-left">
                                    <span class="event-time">{{ event.start.strftime('%H:%M') }}</span>
                                    {% if duration_mins >= 30 %}
                                    <span class="event-duration">{% if duration_mins >= 60 %}{{ duration_mins // 60 }}h{% if duration_mins % 60 %}{{ duration_mins % 60 }}m{% endif %}{% else %}{{ duration_mins }}m{% endif %}</span>
                                    {% endif %}
                                </div>
                                <span class="event-title">{{ event.summary }}</span>
                            </div>
                            {% endfor %}
                            {# Scheduled Todoist tasks #}
                            {% for scheduled in day.scheduled_tasks if scheduled.start.hour == hour %}
                            {% set duration_mins = scheduled.duration_minutes %}
                            {% set height_px = (duration_mins / 60 * 60)|int %}
                            {% set top_px = (scheduled.start.minute / 60 * 60)|int %}
                            {% set duration_class = 'duration-short' if duration_mins < 30 else ('duration-medium' if duration_mins < 60 else 'duration-long') %}
                            {% set start_mins = scheduled.start.hour * 60 + scheduled.start.minute %}
                            {% set end_mins = start_mins + duration_mins %}
                            <div class="scheduled-task clarity-{{ scheduled.clarity }} {{ duration_class }} from-todoist"
                                 style="height: {{ height_px }}px; top: {{ top_px }}px;"
                                 data-task-id="{{ scheduled.task.id }}"
                                 data-start-mins="{{ start_mins }}"
                                 data-end-mins="{{ end_mins }}"
                                 data-duration="{{ duration_mins }}"
                                 data-clarity="{{ scheduled.clarity }}">
                                <div class="scheduled-task-left">
                                    <span class="scheduled-task-time">{{ scheduled.start.strftime('%H:%M') }}</span>
                                    {% if duration_mins >= 30 %}
                                    <span class="scheduled-task-duration">{% if duration_mins >= 60 %}{{ duration_mins // 60 }}h{% if duration_mins % 60 %}{{ duration_mins % 60 }}m{% endif %}{% else %}{{ duration_mins }}m{% endif %}</span>
                                    {% endif %}
                                </div>
                                <span class="scheduled-task-text">{{ scheduled.task.content }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/energy-selector.js"></script>
<script src="/static/js/drag-drop.js"></script>
<script src="/static/js/plan-tasks.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Scroll carousel to today's calendar
    const todayCalendar = document.getElementById('today-calendar');
    if (todayCalendar) {
        todayCalendar.scrollIntoView({ behavior: 'instant', inline: 'center' });
    }

    // Scroll each hour grid to 8am
    document.querySelectorAll('.hour-grid').forEach(grid => {
        const hourRow = grid.querySelector('.hour-row[data-hour="8"]');
        if (hourRow) {
            grid.scrollTop = hourRow.offsetTop;
        }
    });

    // Calculate initial overlaps for all day calendars
    document.querySelectorAll('.day-calendar').forEach(dayCalendar => {
        if (typeof recalculateOverlaps === 'function') {
            recalculateOverlaps(dayCalendar);
        }
    });

    // "Go to Today" button with visibility based on scroll position
    const todayBtn = document.getElementById('go-to-today-btn');
    const carousel = document.getElementById('calendar-carousel');

    if (todayBtn && todayCalendar && carousel) {
        todayBtn.addEventListener('click', () => {
            todayCalendar.scrollIntoView({ behavior: 'smooth', inline: 'start' });
        });

        // Hide button when today is visible
        const todayObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    todayBtn.style.opacity = entry.isIntersecting ? '0' : '1';
                    todayBtn.style.pointerEvents = entry.isIntersecting ? 'none' : 'auto';
                });
            },
            { root: carousel, threshold: 0.5 }
        );
        todayObserver.observe(todayCalendar);
    }

    // Update calendar header when scrolling through days
    const dayInfo = document.getElementById('calendar-day-info');
    if (dayInfo && carousel) {
        const dayCalendars = carousel.querySelectorAll('.day-calendar');
        const dayObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
                        const dayName = entry.target.dataset.dayName;
                        const dayDate = entry.target.dataset.dayDate;
                        dayInfo.querySelector('.day-name').textContent = dayName;
                        dayInfo.querySelector('.day-date').textContent = dayDate;
                    }
                });
            },
            { root: carousel, threshold: 0.5 }
        );
        dayCalendars.forEach(day => dayObserver.observe(day));
    }
});
</script>
{% endblock %}
