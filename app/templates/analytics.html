{% extends "base.html" %}

{% block title %}Analytics - Whendoist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dialog.css">
<link rel="stylesheet" href="/static/css/pages/analytics.css">
{% endblock %}

{% block content %}
<div class="analytics-page">
    <div class="page-surface">
        <!-- Header -->
        <div class="analytics-header">
            <h1 class="analytics-title">Analytics</h1>
            <div class="date-range-selector">
                <a href="/analytics?days=7" class="range-btn{% if days == 7 %} active{% endif %}">7D</a>
                <a href="/analytics?days=30" class="range-btn{% if days == 30 %} active{% endif %}">30D</a>
                <a href="/analytics?days=90" class="range-btn{% if days == 90 %} active{% endif %}">90D</a>
                <span class="date-label">{{ start_date.strftime('%b %d') }} - {{ end_date.strftime('%b %d, %Y') }}</span>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value success">{{ stats.total_completed }}</div>
                <div class="stat-label">Completed</div>
                {% if stats.week_comparison.change_pct != 0 %}
                <div class="stat-change {% if stats.week_comparison.change_pct > 0 %}positive{% else %}negative{% endif %}">
                    {% if stats.week_comparison.change_pct > 0 %}+{% endif %}{{ stats.week_comparison.change_pct }}% vs last week
                </div>
                {% endif %}
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ stats.total_pending }}</div>
                <div class="stat-label">Pending</div>
                <div class="stat-sub">Avg resolution: {{ stats.aging_stats.avg_days }} days</div>
            </div>
            <div class="stat-card">
                <div class="stat-value primary">{{ stats.completion_rate }}%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
            <div class="stat-card">
                <div class="streak-display">
                    {% if stats.streaks.current > 0 %}<span class="streak-fire">ðŸ”¥</span>{% endif %}
                    <div class="stat-value warning">{{ stats.streaks.current }}</div>
                </div>
                <div class="stat-label">Day Streak</div>
                <div class="stat-sub">Best: {{ stats.streaks.longest }} days</div>
            </div>
        </div>

        <!-- Daily Completions + Velocity -->
        <div class="charts-row">
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Daily Completions</p>
                </div>
                <div class="panel__bd">
                    <div id="chart-daily" class="chart-container"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">By Domain</p>
                </div>
                <div class="panel__bd">
                    <div id="chart-domain" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Productivity Patterns -->
        <div class="charts-row-2">
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Best days of week</p>
                </div>
                <div class="panel__bd">
                    <div id="chart-dow" class="chart-container--sm"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Active Hours</p>
                </div>
                <div class="panel__bd">
                    <div id="chart-hour" class="chart-container--sm"></div>
                </div>
            </div>
        </div>

        <!-- Impact + Heatmap -->
        <div class="charts-row">
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Contribution Heatmap (12 weeks)</p>
                </div>
                <div class="panel__bd">
                    <div class="heatmap-container">
                        <div id="chart-heatmap" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">By Impact</p>
                </div>
                <div class="panel__bd">
                    <div id="chart-impact" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Velocity Trend + Recent Completions -->
        <div class="charts-row">
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Velocity (30-day trend)</p>
                </div>
                <div class="panel__bd">
                    <div id="chart-velocity" class="chart-container"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Recent Completions</p>
                </div>
                <div class="panel__bd panel__bd--flush">
                    {% if recent_completions %}
                    <div class="completion-log">
                        {% for item in recent_completions %}
                        <div class="completion-row" data-task-id="{{ item.task_id }}">
                            <span class="completion-check">âœ“</span>
                            <span class="completion-title" title="{{ item.title }}">{{ item.title }}</span>
                            <span class="completion-date">{{ item.completed_at_display }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <img src="{{ url_for('static', path='img/illustrations/empty-analytics.svg') }}" alt="" class="empty-state-illustration" width="80" height="80" aria-hidden="true">
                        <p>No recent completions</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recurring Tasks + Task Age -->
        <div class="charts-row-2">
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Recurring Task Completion</p>
                </div>
                <div class="panel__bd panel__bd--flush">
                    {% if stats.recurring_stats %}
                    {% for task in stats.recurring_stats %}
                    <div class="recurring-row">
                        <span class="recurring-title">{{ task.title }}</span>
                        <span class="recurring-rate recurring-count">{{ task.completed }}/{{ task.total }}</span>
                        <div class="recurring-bar">
                            <div class="recurring-bar-fill" style="width: {{ task.rate }}%;"></div>
                        </div>
                        <span class="recurring-rate recurring-pct">{{ task.rate }}%</span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <img src="{{ url_for('static', path='img/illustrations/empty-tasks.svg') }}" alt="" class="empty-state-illustration" width="80" height="80" aria-hidden="true">
                        <p>No recurring tasks</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="panel">
                <div class="panel__hd">
                    <p class="panel-title">Resolution Time</p>
                </div>
                <div class="panel__bd">
                    <p class="panel-desc">Days from task creation to completion</p>
                    <div id="chart-aging" class="chart-container--sm"></div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="/static/js/task-dialog.js"></script>
<script>
// Chart data from backend
const stats = {{ stats | tojson }};
const days = {{ days }};
const recentCompletions = {{ recent_completions | tojson }};

// Theme-aware colors
function getThemeColors() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    return {
        primary: '#8b5cf6',
        text: isDark ? 'rgba(248, 250, 252, 0.72)' : 'rgba(15, 23, 42, 0.5)',
        textStrong: isDark ? 'rgba(248, 250, 252, 0.9)' : 'rgba(15, 23, 42, 0.6)',
        grid: isDark ? 'rgba(248, 250, 252, 0.08)' : 'rgba(15, 23, 42, 0.08)',
        background: isDark ? '#1E293B' : '#ffffff',
        heatmapEmpty: isDark ? '#334155' : '#e2e8f0',
        stroke: isDark ? '#0F172A' : '#fff',
    };
}

// Get common chart options with current theme
function getCommonOptions() {
    const colors = getThemeColors();
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    return {
        chart: {
            fontFamily: 'inherit',
            toolbar: { show: false },
            animations: { enabled: true, speed: 300 },
            background: 'transparent',
        },
        colors: [colors.primary],
        grid: {
            borderColor: colors.grid,
            strokeDashArray: 4,
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light',
            style: {
                fontSize: '12px',
            },
        },
    };
}

// Initialize with current theme
const commonOptions = getCommonOptions();

// 1. Daily Completions Bar Chart
const dailyData = stats.daily_completions || [];
// Determine tick amount based on days range
const dailyTickAmount = days <= 7 ? dailyData.length : (days <= 30 ? 10 : 12);
new ApexCharts(document.querySelector('#chart-daily'), {
    ...commonOptions,
    chart: { ...commonOptions.chart, type: 'bar', height: 200 },
    series: [{
        name: 'Completed',
        data: dailyData.map(d => d.count)
    }],
    xaxis: {
        categories: dailyData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        labels: {
            style: { fontSize: '10px', colors: 'rgba(15, 23, 42, 0.5)' },
            rotate: -45,
            rotateAlways: days > 14,
            hideOverlappingLabels: true,
        },
        tickAmount: dailyTickAmount,
    },
    yaxis: {
        labels: { style: { fontSize: '10px', colors: 'rgba(15, 23, 42, 0.5)' } },
    },
    plotOptions: {
        bar: { borderRadius: 4, columnWidth: days <= 7 ? '60%' : (days <= 30 ? '70%' : '80%') }
    },
    dataLabels: { enabled: false },
}).render();

// 2. Domain Donut Chart
const domainData = stats.by_domain || [];
let domainChart = null;  // Store chart instance for later update
if (domainData.length > 0) {
    domainChart = new ApexCharts(document.querySelector('#chart-domain'), {
        ...commonOptions,
        chart: { ...commonOptions.chart, type: 'donut', height: 220 },
        series: domainData.map(d => d.count),
        labels: domainData.map(d => d.domain_icon + ' ' + d.domain_name),
        colors: ['#8b5cf6', '#06b6d4', '#f97316', '#22c55e', '#ec4899', '#eab308'],
        legend: {
            position: 'right',
            fontSize: '12px',
            markers: { width: 10, height: 10, radius: 2 },
            itemMargin: { horizontal: 0, vertical: 4 },
        },
        tooltip: {
            fillSeriesColor: false,
            style: { fontSize: '13px' },
            y: {
                formatter: (val) => val + ' tasks'
            },
            marker: { show: true },
        },
        dataLabels: { enabled: false },
        plotOptions: {
            pie: {
                donut: {
                    size: '60%',
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Total',
                            fontSize: '12px',
                            color: 'rgba(15, 23, 42, 0.5)',
                        }
                    }
                }
            }
        },
    });
    domainChart.render();
} else {
    document.querySelector('#chart-domain').innerHTML = '<div class="empty-state">No data</div>';
}

// 3. Day of Week Bar Chart
const dowData = stats.by_day_of_week || [];
const dowMax = Math.max(...dowData.map(d => d.count), 1);
const dowYMax = Math.ceil(dowMax * 1.2); // 20% headroom for labels

new ApexCharts(document.querySelector('#chart-dow'), {
    ...commonOptions,
    chart: { ...commonOptions.chart, type: 'bar', height: 220 },
    series: [{
        name: 'Completed',
        data: dowData.map(d => d.count)
    }],
    xaxis: {
        categories: dowData.map(d => d.day),
        labels: { style: { fontSize: '10px', colors: 'rgba(15, 23, 42, 0.5)' } },
    },
    yaxis: {
        min: 0,
        max: dowYMax,
        show: false,
    },
    plotOptions: {
        bar: { borderRadius: 3, columnWidth: '50%' }
    },
    dataLabels: {
        enabled: true,
        formatter: function(val) { return val; },
        offsetY: -15,
        style: {
            fontSize: '10px',
            fontWeight: 600,
            colors: ['rgba(15, 23, 42, 0.6)']
        },
    },
    grid: { show: false },
}).render();

// 4. Hour of Day Area Chart
const hourData = stats.by_hour || [];
new ApexCharts(document.querySelector('#chart-hour'), {
    ...commonOptions,
    chart: { ...commonOptions.chart, type: 'area', height: 150 },
    series: [{
        name: 'Completed',
        data: hourData.map(d => d.count)
    }],
    xaxis: {
        categories: hourData.map(d => d.hour + ':00'),
        labels: {
            style: { fontSize: '9px', colors: 'rgba(15, 23, 42, 0.5)' },
            rotate: 0,
            hideOverlappingLabels: true,
        },
        tickAmount: 6,
    },
    yaxis: { show: false },
    stroke: { curve: 'smooth', width: 2 },
    fill: {
        type: 'gradient',
        gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.4,
            opacityTo: 0.1,
        }
    },
    dataLabels: { enabled: false },
    grid: { show: false },
}).render();

// 5. Heatmap (GitHub-style)
const heatmapData = stats.heatmap_data || [];
// Organize into weeks (7 days each) for heatmap
const weeks = [];
let currentWeek = [];
heatmapData.forEach((d, i) => {
    const date = new Date(d.x);
    const dayOfWeek = date.getDay(); // 0 = Sunday
    if (i === 0 || dayOfWeek === 0) {
        if (currentWeek.length > 0) weeks.push(currentWeek);
        currentWeek = [];
    }
    currentWeek.push({ x: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), y: d.y });
});
if (currentWeek.length > 0) weeks.push(currentWeek);

// Create series for each day of week
const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const heatmapSeries = dayNames.map((name, dayIdx) => ({
    name: name,
    data: weeks.map((week, weekIdx) => {
        const entry = week.find((_, i) => {
            const d = new Date(heatmapData[weekIdx * 7 + i]?.x);
            return d.getDay() === dayIdx;
        });
        return entry ? entry.y : 0;
    })
})).reverse();

const heatmapColors = getThemeColors();
new ApexCharts(document.querySelector('#chart-heatmap'), {
    ...commonOptions,
    chart: { ...commonOptions.chart, type: 'heatmap', height: 180 },
    series: heatmapSeries,
    colors: ['#8b5cf6'],
    plotOptions: {
        heatmap: {
            shadeIntensity: 0.5,
            radius: 2,
            colorScale: {
                ranges: [
                    { from: 0, to: 0, color: heatmapColors.heatmapEmpty, name: 'none' },
                    { from: 1, to: 3, color: '#c4b5fd', name: 'low' },
                    { from: 4, to: 7, color: '#a78bfa', name: 'medium' },
                    { from: 8, to: 100, color: '#7c3aed', name: 'high' },
                ]
            }
        }
    },
    dataLabels: { enabled: false },
    xaxis: {
        labels: { show: false },
    },
    yaxis: {
        labels: { style: { fontSize: '10px', colors: heatmapColors.text } },
    },
    legend: { show: false },
    stroke: { width: 2, colors: [heatmapColors.stroke] },
}).render();

// 6. Impact Distribution
const impactData = stats.impact_distribution || [];
new ApexCharts(document.querySelector('#chart-impact'), {
    ...commonOptions,
    chart: { ...commonOptions.chart, type: 'bar', height: 200 },
    series: [{
        name: 'Completed',
        data: impactData.map(d => d.count)
    }],
    xaxis: {
        categories: impactData.map(d => d.label),
        labels: { style: { fontSize: '10px', colors: 'rgba(15, 23, 42, 0.5)' } },
    },
    yaxis: {
        labels: { style: { fontSize: '10px', colors: 'rgba(15, 23, 42, 0.5)' } },
    },
    colors: impactData.map(d => d.color),
    plotOptions: {
        bar: {
            borderRadius: 4,
            columnWidth: '50%',
            distributed: true,
        }
    },
    dataLabels: { enabled: false },
    legend: { show: false },
}).render();

// 7. Velocity Trend (Mixed chart)
const velocityData = stats.velocity_data || [];
// Normalize by largest daily count for better scale utilization
const velocityDailyMax = Math.max(...velocityData.map(d => d.count), 1);
const velocityYMax = Math.ceil(velocityDailyMax * 1.15); // 15% headroom

new ApexCharts(document.querySelector('#chart-velocity'), {
    ...commonOptions,
    chart: { ...commonOptions.chart, type: 'line', height: 400 },
    series: [
        {
            name: 'Daily',
            type: 'column',
            data: velocityData.map(d => d.count)
        },
        {
            name: '7-day avg',
            type: 'line',
            data: velocityData.map(d => d.avg)
        }
    ],
    xaxis: {
        categories: velocityData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        labels: {
            style: { fontSize: '9px', colors: 'rgba(15, 23, 42, 0.5)' },
            rotate: -45,
            hideOverlappingLabels: true,
        },
        tickAmount: 10,
    },
    yaxis: {
        min: 0,
        max: velocityYMax,
        tickAmount: 4,
        labels: { style: { fontSize: '10px', colors: 'rgba(15, 23, 42, 0.5)' } },
    },
    colors: ['rgba(139, 92, 246, 0.3)', '#8b5cf6'],
    stroke: { width: [0, 3], curve: 'smooth' },
    plotOptions: {
        bar: { borderRadius: 2, columnWidth: '60%' }
    },
    dataLabels: { enabled: false },
    legend: {
        show: true,
        position: 'top',
        horizontalAlign: 'right',
        fontSize: '11px',
    },
}).render();

// 8. Resolution Time Donut
const agingData = stats.aging_stats?.buckets || {};
const agingLabels = ['Same day', '1-7 days', '8-30 days', '30+ days'];
const agingValues = [
    agingData.same_day || 0,
    agingData.within_week || 0,
    agingData.within_month || 0,
    agingData.over_month || 0
];
const agingEl = document.querySelector('#chart-aging');
if (agingEl && agingValues.some(v => v > 0)) {
    new ApexCharts(agingEl, {
        ...commonOptions,
        chart: { ...commonOptions.chart, type: 'donut', height: 150 },
        series: agingValues,
        labels: agingLabels,
        colors: ['#22c55e', '#eab308', '#f97316', '#dc2626'],
        legend: {
            position: 'right',
            fontSize: '10px',
        },
        dataLabels: { enabled: false },
        plotOptions: {
            pie: {
                donut: {
                    size: '60%',
                }
            }
        },
    }).render();
}

// =============================================================================
// E2E Encryption: Decrypt task titles and domain names
// =============================================================================

/**
 * Check if a value looks like encrypted data (base64 with min length).
 * AES-256-GCM: 12 bytes IV + ciphertext + 16 bytes tag = min 28 bytes = ~38 base64 chars
 */
function looksEncrypted(value) {
    if (!value || value.length < 38) return false;
    return /^[A-Za-z0-9+/]+=*$/.test(value);
}

/**
 * Decrypt analytics data (task titles, domain names).
 * Only runs if encryption is enabled and key is available.
 */
async function decryptAnalyticsData() {
    // Check if encryption is enabled and we can decrypt
    if (!window.WHENDOIST?.encryptionEnabled) return;
    if (!window.Crypto?.canCrypto()) return;

    // Decrypt recent completion titles (use JS data for reliability)
    const completionTitles = document.querySelectorAll('.completion-title');
    for (let i = 0; i < completionTitles.length && i < recentCompletions.length; i++) {
        const el = completionTitles[i];
        const item = recentCompletions[i];
        if (!item?.title || !looksEncrypted(item.title)) continue;

        try {
            const decrypted = await Crypto.decryptField(item.title);
            if (decrypted) {
                el.textContent = decrypted;
                el.title = decrypted;  // Update tooltip too
            }
        } catch (e) {
            console.error('Failed to decrypt completion title:', e);
            // Leave as-is on error
        }
    }

    // Decrypt recurring task titles (use JS data like domain chart for reliability)
    const recurringTitles = document.querySelectorAll('.recurring-title');
    const recurringStats = stats.recurring_stats || [];
    for (let i = 0; i < recurringTitles.length && i < recurringStats.length; i++) {
        const el = recurringTitles[i];
        const taskData = recurringStats[i];
        if (!taskData?.title || !looksEncrypted(taskData.title)) continue;

        try {
            const decrypted = await Crypto.decryptField(taskData.title);
            if (decrypted) {
                el.textContent = decrypted;
            }
        } catch (e) {
            console.error('Failed to decrypt recurring task title:', e);
        }
    }

    // Decrypt domain names in chart (update labels with decrypted values)
    if (domainChart && domainData.length > 0) {
        const decryptedLabels = await Promise.all(domainData.map(async (d) => {
            if (!looksEncrypted(d.domain_name)) {
                return d.domain_icon + ' ' + d.domain_name;
            }

            try {
                const decrypted = await Crypto.decryptField(d.domain_name);
                return d.domain_icon + ' ' + (decrypted || d.domain_name);
            } catch (e) {
                console.error('Failed to decrypt domain name:', e);
                return d.domain_icon + ' ' + d.domain_name;
            }
        }));

        // Update chart with decrypted labels using stored chart instance
        domainChart.updateOptions({
            labels: decryptedLabels
        });
    }
}

// Run decryption after page load
decryptAnalyticsData();

// =============================================================================
// Theme change handler for ApexCharts
// =============================================================================

// Store all chart instances for theme updates
const chartInstances = [];

// Collect chart instances after they're created
document.addEventListener('DOMContentLoaded', () => {
    // ApexCharts stores instances globally
    if (window.Apex && window.Apex._chartInstances) {
        // Delay to ensure all charts are initialized
        setTimeout(() => {
            chartInstances.push(...(window.Apex._chartInstances || []));
        }, 500);
    }
});

// Listen for theme changes
window.addEventListener('themechange', (e) => {
    const colors = getThemeColors();
    const isDark = e.detail.theme === 'dark';

    // Update all ApexCharts instances
    if (window.ApexCharts) {
        // Get all chart instances from ApexCharts global registry
        const charts = document.querySelectorAll('.apexcharts-canvas');
        charts.forEach(canvas => {
            const chartId = canvas.getAttribute('id');
            if (chartId) {
                // Find the chart instance by looking at parent container
                const container = canvas.closest('[id^="chart-"]');
                if (container && container._chart) {
                    container._chart.updateOptions({
                        tooltip: { theme: isDark ? 'dark' : 'light' },
                        grid: { borderColor: colors.grid },
                    }, false, false);
                }
            }
        });
    }

    // Update specific charts that need color updates
    if (domainChart) {
        domainChart.updateOptions({
            tooltip: { theme: isDark ? 'dark' : 'light' },
            plotOptions: {
                pie: {
                    donut: {
                        labels: {
                            total: {
                                color: colors.text,
                            }
                        }
                    }
                }
            }
        }, false, false);
    }
});
</script>
{% endblock %}
