{% extends "base.html" %}

{% block title %}Settings - Whendoist{% endblock %}

{% block extra_css %}
<style>
/* =============================================================================
   Settings v0.6 - Final polish
   User-defined labels preserved, aligned controls, proper integrations
   ============================================================================= */

/* 1) Page wrapper */
.settings-page {
    min-height: calc(100vh - 80px);
    padding: 0 24px 24px;
    display: flex;
    justify-content: center;
}

/* 2) Page surface - shared container style */
.page-surface {
    width: 100%;
    max-width: 1100px;
    background: var(--grey-bg);
    border: 1px solid var(--border-hair);
    border-radius: 12px;
    padding: 32px 36px 44px;
    box-sizing: border-box;
}

/* 3) Page title - ALL CAPS */
.settings-title {
    margin: 0 0 28px 0;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    font-weight: 700;
    font-size: 1.5rem;
    line-height: 1;
    color: var(--text);
}

/* 4) Two-column grid */
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.settings-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 0;
    overflow: hidden;
}

/* =============================================================================
   Panel component
   ============================================================================= */

.settings-panel {
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    min-width: 0;
}

.settings-panel__hd {
    background: var(--grey-bg);
    border-bottom: 1px solid var(--border-hair);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
}

.panel-hd-left {
    flex: 1;
}

.panel-title {
    text-transform: uppercase;
    letter-spacing: 0.14em;
    font-weight: 700;
    font-size: 0.62rem;
    color: var(--text-muted);
    margin: 0 0 4px 0;
}

.panel-desc {
    font-size: 0.72rem;
    color: var(--text-faint);
    line-height: 1.4;
    margin: 0;
}

.panel-hd-right {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.55rem;
    font-weight: 600;
    color: var(--text-faint);
    padding-top: 2px;
    flex-shrink: 0;
}

/* Disabled panel state */
.settings-panel--disabled .settings-panel__bd {
    opacity: 0.5;
    pointer-events: none;
}

.panel-disabled-notice {
    padding: 12px 16px;
    font-size: 0.75rem;
    color: var(--text-muted);
    background: rgba(15, 23, 42, 0.02);
    border-bottom: 1px solid var(--border-hair);
}

/* =============================================================================
   Unified Row component
   ============================================================================= */

.settings-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-hair);
    background: var(--light-bg);
    transition: background 0.1s ease;
    min-height: 44px;
    box-sizing: border-box;
}

.settings-row:last-child {
    border-bottom: none;
}

.settings-row:hover {
    background: var(--row-hover);
}

/* Right-aligned column for actions/toggles - fixed width for alignment */
.settings-row__right {
    margin-left: auto;
    min-width: 80px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

/* Row actions - hidden until hover */
.row-actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.12s ease;
    flex-shrink: 0;
}

.settings-row:hover .row-actions,
.settings-row:focus-within .row-actions {
    opacity: 1;
    pointer-events: auto;
}

/* Add row variant */
.settings-row--add {
    background: var(--grey-bg);
    border-bottom: none;
    gap: 8px;
}

.settings-row--add:hover {
    background: var(--grey-bg);
}

.settings-row--add .settings-row__right {
    min-width: 0;
}

/* Clickable row */
.settings-row--clickable {
    cursor: pointer;
}

/* =============================================================================
   Icon buttons
   ============================================================================= */

.icon-btn {
    all: unset;
    box-sizing: border-box;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 1px solid var(--border-hair);
    background: rgba(255, 255, 255, 0.85);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.1s ease, border-color 0.1s ease, color 0.1s ease;
}

.icon-btn svg {
    display: block;
    flex-shrink: 0;
}

.icon-btn:hover {
    border-color: var(--border);
    background: var(--grey-bg);
    color: var(--text);
}

.icon-btn.edit:hover {
    border-color: rgba(109, 94, 246, 0.35);
    background: rgba(109, 94, 246, 0.08);
    color: var(--primary);
}

.icon-btn.delete:hover {
    border-color: rgba(220, 38, 38, 0.25);
    background: rgba(220, 38, 38, 0.06);
    color: var(--danger);
}

/* Chevron for expandable rows */
.row-chevron {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-faint);
    transition: transform 0.15s ease;
    flex-shrink: 0;
}

.row-chevron.expanded {
    transform: rotate(180deg);
}

/* =============================================================================
   Provider/Integration rows
   ============================================================================= */

.provider-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--grey-bg);
    border: 1px solid var(--border-hair);
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-muted);
    flex-shrink: 0;
}

.provider-info {
    flex: 1;
    min-width: 0;
}

.provider-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    line-height: 1.2;
}

.provider-status {
    font-size: 0.7rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 2px;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-faint);
    flex-shrink: 0;
}

.status-dot.connected {
    background: #16a34a;
}

/* Muted label for locked state */
.muted-label {
    font-size: 0.6rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-faint);
    white-space: nowrap;
}

/* =============================================================================
   Expandable section (for Todoist actions)
   ============================================================================= */

.expand-section {
    display: none;
    background: rgba(15, 23, 42, 0.02);
    border-bottom: 1px solid var(--border-hair);
}

.expand-section.open {
    display: block;
}

.expand-content {
    padding: 12px 16px 14px;
    min-width: 0;
    overflow: hidden;
}

.expand-label {
    font-size: 0.55rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    color: var(--text-faint);
    margin-bottom: 6px;
}

.expand-desc {
    font-size: 0.7rem;
    color: var(--text-faint);
    line-height: 1.45;
    margin-bottom: 10px;
}

.expand-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}

.expand-actions__left {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.expand-status {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-hair);
}

.expand-status.success {
    color: #16a34a;
}

.expand-status.error {
    color: var(--danger);
}

.expand-status.preview {
    color: var(--text);
    padding: 0;
    margin-top: 12px;
}

/* Passkey List */
.passkey-list {
    padding: 0 16px 12px;
}

.passkey-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-hair);
}

.passkey-item:last-child {
    border-bottom: none;
}

.passkey-item__info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.passkey-item__name {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text);
}

.passkey-item__date {
    font-size: 0.6875rem;
    color: var(--text-muted);
}

.btn-sm--danger {
    color: var(--danger) !important;
}

.btn-sm--danger:hover {
    background: rgba(220, 38, 38, 0.08) !important;
}

/* Import Preview */
.import-preview {
    background: rgba(15, 23, 42, 0.02);
    border: 1px solid var(--border-hair);
    border-radius: 8px;
    padding: 14px;
}

.preview-header {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 12px;
}

.preview-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;
}

.preview-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 12px;
    background: var(--light-bg);
    border-radius: 6px;
    min-width: 64px;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
    font-variant-numeric: tabular-nums;
}

.stat-label {
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.preview-projects {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 12px;
}

.preview-project {
    font-size: 0.68rem;
    padding: 3px 8px;
    background: var(--light-bg);
    border: 1px solid var(--border-hair);
    border-radius: 4px;
    color: var(--text-muted);
}

.preview-more {
    font-size: 0.68rem;
    padding: 3px 8px;
    color: var(--text-faint);
}

.preview-options {
    margin-bottom: 10px;
}

.preview-option {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.72rem;
    color: var(--text-muted);
    cursor: pointer;
}

.preview-option input[type="checkbox"] {
    width: 14px;
    height: 14px;
    margin: 0;
}

.preview-note {
    font-size: 0.68rem;
    color: var(--text-faint);
    margin-bottom: 14px;
    font-style: italic;
}

.preview-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

.import-loading {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-align: center;
    padding: 12px;
}

.btn-text-danger {
    all: unset;
    box-sizing: border-box;
    font-size: 0.68rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--danger);
    cursor: pointer;
    transition: opacity 0.15s ease;
}

.btn-text-danger:hover {
    opacity: 0.7;
}

/* Ghost/secondary button variant */
.btn-sm--ghost {
    background: transparent;
    border: 1px solid var(--border-hair);
    color: var(--text-muted);
}

.btn-sm--ghost:hover {
    background: rgba(15, 23, 42, 0.04);
    border-color: var(--border);
    color: var(--text);
}

/* =============================================================================
   Calendar row
   ============================================================================= */

.calendar-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
}

.calendar-info {
    flex: 1;
    min-width: 0;
}

.calendar-name {
    font-size: 0.875rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}

.calendar-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 2px;
}

.calendar-badge {
    font-size: 0.55rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--grey-bg);
    color: var(--text-muted);
    padding: 2px 6px;
    border-radius: 3px;
    flex-shrink: 0;
}

/* Panel legend text */
.panel-legend {
    font-size: 0.68rem;
    color: var(--text-faint);
    font-style: italic;
    margin-top: 4px;
}

/* Calendar row - compact variant */
.settings-row--calendar {
    padding: 8px 16px;
    min-height: 36px;
}

.settings-row--calendar .calendar-name {
    font-size: 0.8125rem;
}

.settings-row--calendar .calendar-badge {
    font-size: 0.5rem;
}

/* Toggle switch */
.toggle-switch {
    all: unset;
    box-sizing: border-box;
    position: relative;
    display: inline-block;
    width: 32px;
    height: 18px;
    background: var(--border);
    border-radius: 9px;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
    vertical-align: middle;
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.15s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.12);
}

.toggle-switch.enabled {
    background: var(--primary);
}

.toggle-switch.enabled::after {
    transform: translateX(14px);
}

/* =============================================================================
   Domain row
   ============================================================================= */

.domain-icon {
    font-size: 1rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
}

.domain-name {
    flex: 1;
    font-size: 0.875rem;
    color: var(--text);
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Imported domain badge */
.domain-imported {
    font-size: 0.55rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-faint);
    flex-shrink: 0;
}

/* Emoji picker */
.emoji-picker-btn {
    all: unset;
    box-sizing: border-box;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid var(--border-hair);
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: border-color 0.15s, background 0.15s;
    flex-shrink: 0;
}

.emoji-picker-btn:hover {
    border-color: var(--border);
    background: var(--grey-bg);
}

.emoji-picker-btn:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(109, 94, 246, 0.12);
}

.emoji-picker-wrap {
    position: relative;
}

.emoji-picker-popover {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 4px;
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    box-shadow: var(--shadow-overlay);
    z-index: 100;
    display: none;
    width: 220px;
}

.emoji-picker-popover.open {
    display: block;
}

/* In modal, open downward */
.modal .emoji-picker-popover {
    bottom: auto;
    top: 100%;
    margin-bottom: 0;
    margin-top: 4px;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.emoji-option {
    all: unset;
    box-sizing: border-box;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s;
}

.emoji-option:hover {
    background: var(--grey-bg);
}

/* Add domain input row */
.settings-row--add {
    align-items: center;
}

input.add-domain-input,
input.add-domain-input[type="text"] {
    all: unset;
    box-sizing: border-box;
    flex: 1;
    height: 32px;
    padding: 0 10px;
    margin: 0;
    border: 1px solid var(--border-hair);
    border-radius: 6px;
    font-size: 0.8125rem;
    background: #fff;
    color: var(--text);
    line-height: 32px;
}

input.add-domain-input:focus,
input.add-domain-input[type="text"]:focus {
    outline: none;
    border-color: var(--border);
    box-shadow: 0 0 0 2px rgba(109, 94, 246, 0.12);
}

input.add-domain-input::placeholder {
    color: var(--text-faint);
}

/* =============================================================================
   Buttons
   ============================================================================= */

.btn-sm {
    all: unset;
    box-sizing: border-box;
    padding: 0 12px;
    margin: 0;
    border-radius: 5px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.15s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    height: 28px;
    line-height: 1;
}

.btn-sm--primary {
    background: var(--primary);
    color: #fff;
}

.btn-sm--primary:hover {
    background: var(--primary-hover);
}

.btn-sm--secondary {
    background: var(--grey-bg);
    border: 1px solid var(--border-hair);
    color: var(--text);
}

.btn-sm--secondary:hover {
    background: rgba(15, 23, 42, 0.06);
    border-color: var(--border);
}

.btn-sm:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* =============================================================================
   Maintenance panel (danger only)
   ============================================================================= */

.maintenance-content {
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.maintenance-info {
    flex: 1;
}

.maintenance-warning {
    font-size: 0.72rem;
    color: var(--danger);
    font-weight: 500;
    margin-bottom: 4px;
}

.maintenance-desc {
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.4;
}

.btn-sm--danger {
    background: rgba(220, 38, 38, 0.08);
    border: 1px solid rgba(220, 38, 38, 0.2);
    color: var(--danger);
    flex-shrink: 0;
}

.btn-sm--danger:hover {
    background: rgba(220, 38, 38, 0.14);
    border-color: rgba(220, 38, 38, 0.3);
}

/* =============================================================================
   Segmented Control
   ============================================================================= */

.segmented-control {
    display: flex;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
}

.segmented-btn {
    all: unset;
    box-sizing: border-box;
    padding: 5px 10px;
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--text-muted);
    background: var(--light-bg);
    cursor: pointer;
    border-right: 1px solid var(--border-hair);
    transition: background 0.1s, color 0.1s;
    white-space: nowrap;
}

.segmented-btn:last-child {
    border-right: none;
}

.segmented-btn:hover {
    background: var(--grey-bg);
}

.segmented-btn.active {
    background: var(--primary);
    color: #fff;
}

.segmented-btn.active:hover {
    background: var(--primary-hover);
}

/* Task Display row label */
.pref-label {
    flex: 1;
    font-size: 0.8125rem;
    color: var(--text);
    min-width: 0;
}

.backup-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.backup-info .pref-label {
    flex: none;
}

.pref-desc {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* =============================================================================
   Unclear tasks container
   ============================================================================= */

.unclear-tasks {
    border-top: 1px solid var(--border-hair);
    display: none;
    margin-top: 12px;
    max-height: 300px;
    overflow-y: auto;
}

.unclear-tasks.visible {
    display: block;
}

.unclear-tasks__hd {
    padding: 10px 0;
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    color: var(--text-muted);
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
}

.unclear-hint {
    font-weight: 500;
    text-transform: none;
    letter-spacing: 0.02em;
    color: var(--text-faint);
    font-size: 0.68rem;
}

.unclear-task-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 0;
    border-bottom: 1px solid var(--border-hair);
}

.unclear-task-row:last-child {
    border-bottom: none;
}

.unclear-task-title {
    flex: 1;
    min-width: 0;
    font-size: 0.8125rem;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.clarity-btns {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}

.clarity-btn {
    all: unset;
    box-sizing: border-box;
    padding: 4px 10px;
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border: 1px solid var(--border-hair);
    border-radius: 4px;
    background: #fff;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
}

.clarity-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(109, 94, 246, 0.05);
}

.unclear-empty {
    padding: 16px 0;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8125rem;
}

/* =============================================================================
   Empty states
   ============================================================================= */

.empty-state {
    padding: 28px 16px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8125rem;
}

/* =============================================================================
   Domain Edit Modal
   ============================================================================= */

.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 200;
    justify-content: center;
    align-items: center;
}

.modal-overlay.open {
    display: flex;
}

.modal {
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
    width: 320px;
    box-shadow: var(--shadow-overlay);
}

.modal__title {
    margin: 0 0 16px;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text);
}

.modal__form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.modal__row {
    display: flex;
    gap: 8px;
}

.modal__row input {
    flex: 1;
    height: 38px;
    padding: 0 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--text);
}

.modal__row input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(109, 94, 246, 0.15);
}

.modal__row .icon-input {
    width: 54px;
    flex: none;
    text-align: center;
}

.modal__actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 8px;
}

/* =============================================================================
   Settings Footer
   ============================================================================= */

.settings-footer {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0 6px;
    padding: 20px 16px 8px;
    margin-top: 12px;
    font-size: 0.6875rem;
    color: rgba(15, 23, 42, 0.45);
    border-top: 1px solid var(--border-hair);
}

.footer-sep {
    color: rgba(15, 23, 42, 0.2);
}

.footer-muted {
    color: rgba(15, 23, 42, 0.35);
}

.footer-link {
    color: rgba(15, 23, 42, 0.5);
    text-decoration: none;
    transition: color 0.15s ease;
}

.footer-link:hover {
    color: var(--primary);
}

/* =============================================================================
   Mobile responsive
   ============================================================================= */

@media (max-width: 900px) {
    .settings-page {
        padding: 16px;
    }

    .page-surface {
        padding: 24px;
    }

    .settings-title {
        font-size: 1.25rem;
        margin-bottom: 20px;
    }

    .settings-grid {
        grid-template-columns: 1fr;
    }

    /* Show actions always on mobile */
    .row-actions {
        opacity: 1;
        pointer-events: auto;
    }
}

@media (max-width: 600px) {
    .settings-page {
        padding: 12px;
    }

    .page-surface {
        padding: 16px;
        border-radius: 10px;
    }

    .settings-panel__hd {
        padding: 12px 14px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .panel-hd-right {
        align-self: flex-end;
    }

    .settings-row {
        padding: 12px 14px;
        min-height: 48px;
    }

    .settings-row__right {
        min-width: 60px;
    }

    .expand-content {
        padding: 14px;
    }

    .maintenance-content {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 14px;
    }

    .maintenance-info {
        text-align: center;
    }

    .btn-sm--danger {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="page-surface">
        <h1 class="settings-title">Settings</h1>

        <div class="settings-grid">
            <!-- LEFT COLUMN: Integrations + Calendars -->
            <div class="settings-column">

                <!-- INTEGRATIONS Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Integrations</p>
                            <p class="panel-desc">Connect external accounts used to sync tasks and events.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Google Calendar row -->
                        <div class="settings-row">
                            <div class="provider-icon">G</div>
                            <div class="provider-info">
                                <div class="provider-name">Google Calendar</div>
                                <div class="provider-status">
                                    <span class="status-dot {% if google_connected %}connected{% endif %}"></span>
                                    {% if google_connected %}Connected{% else %}Not connected{% endif %}
                                </div>
                            </div>
                            <div class="settings-row__right">
                                {% if google_connected %}
                                <span class="muted-label">Linked to login</span>
                                {% else %}
                                <a href="/auth/google" class="btn-sm btn-sm--primary">Connect</a>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Todoist row (expandable when connected) -->
                        {% if todoist_connected %}
                        <div class="settings-row settings-row--clickable" onclick="toggleTodoistSection()" id="todoist-row">
                            <div class="provider-icon">T</div>
                            <div class="provider-info">
                                <div class="provider-name">Todoist</div>
                                <div class="provider-status">
                                    <span class="status-dot connected"></span>
                                    Connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <div class="row-chevron" id="todoist-chevron">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <!-- Todoist expanded section -->
                        <div class="expand-section" id="todoist-expand">
                            <div class="expand-content">
                                <div class="expand-label">Todoist Integration</div>
                                <p class="expand-desc">
                                    Import projects and tasks from Todoist. Projects become domains; tasks keep due dates and priorities. After import, assign clarity levels to enable energy-based filtering.
                                </p>
                                <div class="expand-actions">
                                    <div class="expand-actions__left">
                                        <button type="button" class="btn-sm btn-sm--primary" id="btn-import-todoist" onclick="event.stopPropagation(); importFromTodoist()">
                                            Import from Todoist
                                        </button>
                                        <button type="button" class="btn-sm btn-sm--ghost" id="btn-show-unclear" onclick="event.stopPropagation(); showUnclearTasks()">
                                            Assign Clarity
                                        </button>
                                    </div>
                                    <button type="button" class="btn-text-danger" onclick="event.stopPropagation(); disconnectTodoist()">
                                        Disconnect
                                    </button>
                                </div>
                                <div id="import-status" class="expand-status" style="display: none;"></div>
                                <div id="unclear-tasks-container" class="unclear-tasks"></div>
                            </div>
                        </div>
                        {% else %}
                        <div class="settings-row">
                            <div class="provider-icon">T</div>
                            <div class="provider-info">
                                <div class="provider-name">Todoist</div>
                                <div class="provider-status">
                                    <span class="status-dot"></span>
                                    Not connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <a href="/auth/todoist" class="btn-sm btn-sm--primary">Connect</a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- GOOGLE CALENDARS Panel -->
                <div class="settings-panel {% if not google_connected %}settings-panel--disabled{% endif %}">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Google Calendars</p>
                            <p class="panel-desc">Choose which calendars are visible in the day view. Hidden calendars won't block time.</p>
                        </div>
                        {% if google_connected and calendars %}
                        <span class="panel-hd-right">Toggle to show</span>
                        {% endif %}
                    </div>
                    <div class="settings-panel__bd">
                        {% if not google_connected %}
                        <div class="panel-disabled-notice">
                            Connect Google Calendar to choose calendars.
                        </div>
                        <div class="empty-state">‚Äî</div>
                        {% elif calendars %}
                            {% for cal in calendars %}
                            <div class="settings-row settings-row--clickable settings-row--calendar" onclick="toggleCalendar(this, '{{ cal.id }}')">
                                <div class="calendar-dot" style="background-color: {{ cal.background_color }};"></div>
                                <div class="calendar-info">
                                    <span class="calendar-name" title="{{ cal.summary }}">{{ cal.summary }}</span>
                                    {% if cal.primary %}
                                    <div class="calendar-meta">
                                        <span class="calendar-badge">Primary</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="settings-row__right">
                                    <button
                                        type="button"
                                        class="toggle-switch {% if cal.enabled %}enabled{% endif %}"
                                        data-calendar-id="{{ cal.id }}"
                                        onclick="event.stopPropagation()"
                                        hx-post="/api/calendars/{{ cal.id }}/toggle"
                                        hx-swap="none"
                                        hx-on::after-request="handleCalendarToggle(this)"
                                        aria-label="Toggle calendar"
                                    ></button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">No calendars found</div>
                        {% endif %}
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Domains + Maintenance -->
            <div class="settings-column">

                <!-- LIFE DOMAINS Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Life Domains</p>
                            <p class="panel-desc">Domains group tasks in Whendoist. They can be imported from Todoist projects or created manually.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd" id="domain-list">
                        {% if domains %}
                            {% for domain in domains|sort(attribute='name') %}
                            <div class="settings-row" data-domain-id="{{ domain.id }}" data-domain-name="{{ domain.name }}">
                                <span class="domain-icon">{{ domain.icon or 'üìÅ' }}</span>
                                <span class="domain-name" title="{% if encryption_enabled %}Encrypted{% else %}{{ domain.name }}{% endif %}">{% if encryption_enabled %}üîí{% else %}{{ domain.name }}{% endif %}</span>
                                {% if domain.external_id %}
                                <span class="domain-imported">Imported</span>
                                {% endif %}
                                <div class="row-actions">
                                    <button type="button" class="icon-btn edit" data-domain-id="{{ domain.id }}" data-domain-name="{{ domain.name }}" data-domain-icon="{{ domain.icon or '' }}" onclick="editDomain(this)" title="Edit">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="icon-btn delete" onclick="deleteDomain({{ domain.id }})" title="Delete">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <path d="M18 6L6 18M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state" id="domains-empty">No domains yet</div>
                        {% endif %}
                        <!-- Add domain row -->
                        <div class="settings-row settings-row--add">
                            <div class="emoji-picker-wrap">
                                <button type="button" class="emoji-picker-btn" id="new-domain-icon-btn" onclick="toggleEmojiPicker('new')">üìÅ</button>
                                <div class="emoji-picker-popover" id="emoji-picker-new"></div>
                            </div>
                            <input type="text" id="new-domain-name" class="add-domain-input" placeholder="Add new domain..." maxlength="100">
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" onclick="addDomain()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BACKUP Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Backup</p>
                            <p class="panel-desc">Export and restore your data as JSON.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Export -->
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Export Data</span>
                                <span class="pref-desc">Download all tasks, domains, and settings as JSON</span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-export-backup" onclick="exportBackup()">
                                    Download Backup
                                </button>
                            </div>
                        </div>
                        <!-- Import -->
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Import Data</span>
                                <span class="pref-desc">Restore from a backup file (replaces current data)</span>
                            </div>
                            <div class="settings-row__right">
                                <input type="file" id="backup-file-input" accept=".json" style="display: none;" onchange="importBackup(this)">
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-import-backup" onclick="document.getElementById('backup-file-input').click()">
                                    Restore Backup
                                </button>
                            </div>
                        </div>
                        <div id="backup-status-wrap" class="expand-content" style="display: none; padding-top: 0;">
                            <div id="backup-status" class="expand-status" style="margin-top: 0;"></div>
                        </div>
                    </div>
                </div>

                <!-- SECURITY Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Security</p>
                            <p class="panel-desc">End-to-end encryption protects your task data. Only you can read it.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Encryption status -->
                        <div class="settings-row" id="encryption-row">
                            <div class="backup-info">
                                <span class="pref-label">End-to-End Encryption</span>
                                <span class="pref-desc" id="encryption-status-text">
                                    {% if user_prefs.encryption_enabled %}
                                    Enabled - your data is encrypted
                                    {% else %}
                                    Disabled - data stored in plaintext
                                    {% endif %}
                                </span>
                            </div>
                            <div class="settings-row__right">
                                {% if user_prefs.encryption_enabled %}
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-encryption-toggle" onclick="disableEncryption()">
                                    Disable
                                </button>
                                {% else %}
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-encryption-toggle" onclick="showEncryptionSetup()">
                                    Enable
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div id="encryption-setup-wrap" class="expand-content" style="display: none; margin-top: 12px;">
                            <div id="encryption-setup-content"></div>
                        </div>

                        <!-- Lock Status (shown only when encryption is enabled) -->
                        {% if user_prefs.encryption_enabled %}
                        <div class="settings-row" id="lock-status-row">
                            <div class="backup-info">
                                <span class="pref-label">Lock Status</span>
                                <span class="pref-desc" id="lock-status-text">
                                    <span id="lock-status-unlocked" style="color: var(--success-color, #22c55e);">üîì Unlocked</span>
                                    <span id="lock-status-locked" style="display: none; color: var(--text-muted);">üîí Locked</span>
                                </span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-reauth" onclick="showReauthenticate()" style="display: none;">
                                    Re-authenticate
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Passkey Management (shown only when encryption is enabled) -->
                        {% if user_prefs.encryption_enabled %}
                        <div class="settings-row" id="passkey-row">
                            <div class="backup-info">
                                <span class="pref-label">Passkey Unlock</span>
                                <span class="pref-desc" id="passkey-status-text">
                                    {% if passkey_count > 0 %}
                                    {{ passkey_count }} passkey{% if passkey_count > 1 %}s{% endif %} registered
                                    {% else %}
                                    No passkeys - unlock with passphrase only
                                    {% endif %}
                                </span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-add-passkey" onclick="showAddPasskeyForm()">
                                    Add Passkey
                                </button>
                            </div>
                        </div>

                        <!-- Passkey list -->
                        <div id="passkey-list" class="passkey-list">
                            {% for passkey in user_passkeys %}
                            <div class="passkey-item" data-id="{{ passkey.id }}">
                                <div class="passkey-item__info">
                                    <span class="passkey-item__name">{{ passkey.name }}</span>
                                    <span class="passkey-item__date">Added {{ passkey.created_at.strftime('%b %d, %Y') }}</span>
                                </div>
                                <button type="button" class="btn-sm btn-sm--ghost btn-sm--danger" onclick="deletePasskey({{ passkey.id }}, '{{ passkey.name }}')">
                                    Remove
                                </button>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Add passkey form (hidden by default) -->
                        <div id="add-passkey-wrap" class="expand-content" style="display: none; padding-top: 0;">
                            <div id="add-passkey-content">
                                <div class="expand-label">Add Passkey</div>
                                <p class="expand-desc">
                                    Use your device's biometrics, security key, or password manager to unlock encrypted data.
                                </p>
                                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                    <input type="text" id="passkey-name" class="add-domain-input" placeholder="Passkey name (e.g., 1Password, Touch ID)" style="flex: 1;">
                                </div>
                                <div class="expand-actions">
                                    <div class="expand-actions__left">
                                        <button type="button" class="btn-sm btn-sm--primary" id="btn-register-passkey" onclick="registerPasskey()">Register Passkey</button>
                                        <button type="button" class="btn-sm btn-sm--ghost" onclick="hideAddPasskeyForm()">Cancel</button>
                                    </div>
                                </div>
                                <div id="passkey-setup-status" class="expand-status" style="display: none;"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- MAINTENANCE Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Maintenance</p>
                            <p class="panel-desc">Delete local Whendoist data. This cannot be undone.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <div class="maintenance-content">
                            <div class="maintenance-info">
                                <div class="maintenance-warning">Danger Zone</div>
                                <div class="maintenance-desc">Permanently delete all tasks and domains from Whendoist.</div>
                            </div>
                            <button type="button" class="btn-sm btn-sm--danger" id="btn-wipe-data" onclick="wipeAllData()">
                                Wipe All Data
                            </button>
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Settings Footer - spans full width -->
        <footer class="settings-footer">
            <span id="build-version">Whendoist</span>
            <span class="footer-sep">¬∑</span>
            <span id="build-commit" class="footer-muted"></span>
            <span class="footer-sep">¬∑</span>
            <a href="#" onclick="showVerifyBuildModal(); return false;" class="footer-link">Build info</a>
            <span class="footer-sep">¬∑</span>
            <a href="https://github.com/aleksandr-bogdanov/whendoist" target="_blank" class="footer-link">GitHub</a>
            <span class="footer-sep">¬∑</span>
            <a href="https://github.com/aleksandr-bogdanov/whendoist/blob/main/LICENSE" target="_blank" class="footer-link">MIT License</a>
            <span class="footer-sep">¬∑</span>
            <a href="https://github.com/aleksandr-bogdanov/whendoist#acknowledgments" target="_blank" class="footer-link">Credits</a>
        </footer>
    </div>
</div>

<!-- Build Verification Modal -->
<div class="modal-overlay" id="verify-build-overlay" onclick="if(event.target === this) closeVerifyBuildModal()">
    <div class="modal" style="width: 480px; max-width: 95vw; max-height: 90vh; display: flex; flex-direction: column;">
        <h3 class="modal__title" style="flex-shrink: 0;">Build Information</h3>
        <div id="verify-build-content" style="font-size: 0.8125rem; overflow-y: auto; flex: 1; min-height: 0;">
            <div class="verify-loading">Loading verification info...</div>
        </div>
        <div class="modal__actions" style="margin-top: 16px; flex-shrink: 0;">
            <button type="button" class="btn-sm btn-sm--secondary" onclick="closeVerifyBuildModal()">Close</button>
        </div>
    </div>
</div>

<!-- Domain Edit Modal -->
<div class="modal-overlay" id="domain-edit-overlay" onclick="if(event.target === this) closeDomainEdit()">
    <div class="modal">
        <h3 class="modal__title">Edit Domain</h3>
        <form class="modal__form" onsubmit="saveDomainEdit(event)">
            <input type="hidden" id="edit-domain-id">
            <input type="hidden" id="edit-domain-icon">
            <div class="modal__row">
                <div class="emoji-picker-wrap">
                    <button type="button" class="emoji-picker-btn" id="edit-domain-icon-btn" onclick="toggleEmojiPicker('edit')">üìÅ</button>
                    <div class="emoji-picker-popover" id="emoji-picker-edit"></div>
                </div>
                <input type="text" id="edit-domain-name" placeholder="Domain name" required maxlength="100">
            </div>
            <div class="modal__actions">
                <button type="button" class="btn-sm btn-sm--secondary" onclick="closeDomainEdit()">Cancel</button>
                <button type="submit" class="btn-sm btn-sm--primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
// Emoji picker
const DOMAIN_EMOJIS = [
    'üìÅ', 'üíº', 'üè†', 'üë§', 'üë•', 'üí™', 'üßò',
    'üìö', 'üéì', 'üíª', 'üé®', 'üéµ', 'üéÆ', 'üì∑',
    '‚úàÔ∏è', 'üöó', 'üèÉ', '‚öΩ', 'üéØ', 'üí∞', 'üìà',
    '‚ù§Ô∏è', 'üåü', 'üî•', '‚ú®', 'üéâ', 'üéÅ', 'üèÜ',
    'üçé', 'ü•ó', '‚òï', 'üç≥', 'üõí', 'üè•', 'üíä',
    'üêï', 'üå±', 'üåç', '‚òÄÔ∏è', 'üåô', '‚ö°', 'üîß'
];

let activeEmojiPicker = null;

function renderEmojiPicker(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="emoji-grid">
            ${DOMAIN_EMOJIS.map(emoji => `
                <button type="button" class="emoji-option" onclick="selectEmoji('${containerId}', '${emoji}')">${emoji}</button>
            `).join('')}
        </div>
    `;
}

function toggleEmojiPicker(type) {
    const pickerId = `emoji-picker-${type}`;
    const picker = document.getElementById(pickerId);

    // Close any other open picker
    if (activeEmojiPicker && activeEmojiPicker !== picker) {
        activeEmojiPicker.classList.remove('open');
    }

    // Render if empty
    if (!picker.innerHTML) {
        renderEmojiPicker(pickerId);
    }

    picker.classList.toggle('open');
    activeEmojiPicker = picker.classList.contains('open') ? picker : null;
}

function selectEmoji(pickerId, emoji) {
    const type = pickerId.replace('emoji-picker-', '');
    const btn = document.getElementById(`${type}-domain-icon-btn`);
    btn.textContent = emoji;

    if (type === 'edit') {
        document.getElementById('edit-domain-icon').value = emoji;
    }

    // Close picker
    document.getElementById(pickerId).classList.remove('open');
    activeEmojiPicker = null;
}

// Close emoji picker on outside click
document.addEventListener('click', (e) => {
    if (activeEmojiPicker && !e.target.closest('.emoji-picker-wrap')) {
        activeEmojiPicker.classList.remove('open');
        activeEmojiPicker = null;
    }
});

// Todoist expandable section
function toggleTodoistSection() {
    const expand = document.getElementById('todoist-expand');
    const chevron = document.getElementById('todoist-chevron');
    if (!expand) return;

    expand.classList.toggle('open');
    if (chevron) chevron.classList.toggle('expanded');
}

// Calendar toggle via row click
function toggleCalendar(row, calendarId) {
    const toggle = row.querySelector('.toggle-switch');
    if (toggle) {
        toggle.click();
    }
}

// Handle calendar toggle response
function handleCalendarToggle(toggle) {
    toggle.classList.toggle('enabled');
}

// Disconnect Todoist
async function disconnectTodoist() {
    if (!confirm('Disconnect Todoist? You can reconnect later, but will need to re-import.')) {
        return;
    }

    try {
        const response = await fetch('/auth/todoist/disconnect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to disconnect Todoist');
        }
    } catch (e) {
        alert('Failed to disconnect Todoist');
    }
}

// Domain CRUD
async function addDomain() {
    const input = document.getElementById('new-domain-name');
    const iconBtn = document.getElementById('new-domain-icon-btn');
    const name = input.value.trim();
    const icon = iconBtn.textContent.trim();
    if (!name) return;

    try {
        // Encrypt domain name if encryption is enabled
        const encryptedName = await Crypto.encryptField(name);

        const response = await fetch('/api/domains', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: encryptedName, icon: icon || null })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to create domain');
        }
    } catch (e) {
        alert('Failed to create domain');
    }
}

async function editDomain(btn) {
    const id = btn.dataset.domainId;
    let name = btn.dataset.domainName;
    const icon = btn.dataset.domainIcon;

    // Decrypt name if encryption is enabled
    if (Crypto.canCrypto()) {
        name = await Crypto.decryptField(name);
    }

    document.getElementById('edit-domain-id').value = id;
    document.getElementById('edit-domain-name').value = name;
    document.getElementById('edit-domain-icon').value = icon || 'üìÅ';
    document.getElementById('edit-domain-icon-btn').textContent = icon || 'üìÅ';
    document.getElementById('domain-edit-overlay').classList.add('open');
    document.getElementById('edit-domain-name').focus();
}

function closeDomainEdit() {
    document.getElementById('domain-edit-overlay').classList.remove('open');
    // Close any open emoji picker
    const picker = document.getElementById('emoji-picker-edit');
    if (picker) picker.classList.remove('open');
    activeEmojiPicker = null;
}

async function saveDomainEdit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-domain-id').value;
    const name = document.getElementById('edit-domain-name').value.trim();
    const icon = document.getElementById('edit-domain-icon').value.trim();

    if (!name) return;

    try {
        // Encrypt domain name if encryption is enabled
        const encryptedName = await Crypto.encryptField(name);

        const response = await fetch(`/api/domains/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: encryptedName, icon: icon || null })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to update domain');
        }
    } catch (e) {
        alert('Failed to update domain');
    }
}

async function deleteDomain(id) {
    if (!confirm('Delete this domain? Tasks will be moved to Unsorted.')) return;

    try {
        const response = await fetch(`/api/domains/${id}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to delete domain');
        }
    } catch (e) {
        alert('Failed to delete domain');
    }
}

// Enter key to add domain
document.getElementById('new-domain-name').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addDomain();
    }
});

// Escape to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDomainEdit();
});

// Todoist Import - Preview-based flow
let importPreviewData = null;

async function importFromTodoist() {
    const btn = document.getElementById('btn-import-todoist');
    const status = document.getElementById('import-status');

    btn.disabled = true;
    btn.textContent = 'Loading preview...';
    status.style.display = 'none';

    try {
        // First, fetch preview
        const previewResponse = await fetch('/api/import/todoist/preview');
        const preview = await previewResponse.json();

        if (!previewResponse.ok) {
            throw new Error(preview.detail || 'Failed to load preview');
        }

        importPreviewData = preview;

        // Show preview dialog
        showImportPreview(preview);
    } catch (e) {
        status.textContent = '‚ùå ' + (e.message || 'Failed to load preview');
        status.style.display = 'block';
        status.className = 'expand-status error';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Import from Todoist';
    }
}

function showImportPreview(preview) {
    const status = document.getElementById('import-status');

    // Build preview HTML - show ALL projects
    let projectsList = '';
    if (preview.projects.length > 0) {
        projectsList = preview.projects.map(p =>
            `<span class="preview-project">${p.name} (${p.task_count})</span>`
        ).join('');
    }

    const html = `
        <div class="import-preview">
            <div class="preview-header">Ready to Import</div>
            <div class="preview-stats">
                <div class="preview-stat">
                    <span class="stat-value">${preview.projects_count}</span>
                    <span class="stat-label">Projects</span>
                </div>
                <div class="preview-stat">
                    <span class="stat-value">${preview.tasks_count}</span>
                    <span class="stat-label">Tasks</span>
                </div>
                <div class="preview-stat">
                    <span class="stat-value">${preview.subtasks_count}</span>
                    <span class="stat-label">Subtasks</span>
                </div>
                <div class="preview-stat">
                    <span class="stat-value">${preview.completed_count}</span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>
            ${projectsList ? `<div class="preview-projects">${projectsList}</div>` : ''}
            <div class="preview-options">
                <label class="preview-option">
                    <input type="checkbox" id="import-completed" checked>
                    <span>Import completed tasks (for analytics)</span>
                </label>
            </div>
            <div class="preview-note">
                Subtasks will be flattened to tasks using "Parent ‚Üí Subtask" name pattern
            </div>
            <div class="preview-actions">
                <button type="button" class="btn-sm btn-sm--ghost" onclick="cancelImportPreview()">Cancel</button>
                <button type="button" class="btn-sm btn-sm--primary" onclick="executeImport()">Import Now</button>
            </div>
        </div>
    `;

    status.innerHTML = html;
    status.style.display = 'block';
    status.className = 'expand-status preview';
}

function cancelImportPreview() {
    const status = document.getElementById('import-status');
    status.style.display = 'none';
    importPreviewData = null;
}

async function executeImport() {
    const btn = document.getElementById('btn-import-todoist');
    const status = document.getElementById('import-status');
    const includeCompleted = document.getElementById('import-completed')?.checked ?? true;

    // Show loading state
    status.innerHTML = '<div class="import-loading">Importing...</div>';
    btn.disabled = true;

    try {
        const response = await fetch('/api/import/todoist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                include_completed: includeCompleted,
                skip_existing: true
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Build detailed import summary
            const lines = [];

            // Main import line
            lines.push(`‚úì Imported ${data.tasks_created} tasks, ${data.domains_created} domains`);

            // Completed tasks imported
            if (data.tasks_completed > 0) {
                lines.push(`‚Ü≥ ${data.tasks_completed} completed tasks (for analytics)`);
            }

            // Parent tasks flattened (expected behavior)
            if (data.parents_flattened > 0) {
                lines.push(`‚Ü≥ ${data.parents_flattened} parent tasks merged into subtasks`);
            }

            // Duplicates skipped
            const dupes = data.tasks_skipped + data.domains_skipped;
            if (dupes > 0) {
                lines.push(`‚äò ${dupes} already imported (skipped)`);
            }

            // Tasks needing clarity assignment
            if (data.tasks_need_clarity > 0) {
                lines.push(`‚ö† ${data.tasks_need_clarity} tasks need clarity ‚Äî use "Assign Clarity" below`);
            }

            status.innerHTML = lines.join('<br>');
            status.className = 'expand-status success';

            // E2E Encryption: Encrypt imported tasks if encryption is enabled
            // The imported tasks are stored as plaintext - user needs to re-enable encryption
            // to encrypt them, or we can encrypt on-the-fly using batch update
            if (Crypto.canCrypto() && data.tasks_created > 0) {
                status.innerHTML += '<br>üîê Encrypting imported tasks...';
                try {
                    // Fetch all content (including newly imported)
                    const contentResponse = await fetch('/api/tasks/all-content');
                    if (contentResponse.ok) {
                        const allContent = await contentResponse.json();
                        const encrypted = await Crypto.encryptAllData(allContent.tasks, allContent.domains);

                        // Update tasks
                        if (encrypted.tasks.length > 0) {
                            await fetch('/api/tasks/batch-update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ tasks: encrypted.tasks })
                            });
                        }
                        status.innerHTML += '<br>‚úì Tasks encrypted';
                    }
                } catch (e) {
                    console.error('Failed to encrypt imported tasks:', e);
                    status.innerHTML += '<br>‚ö† Failed to encrypt some tasks';
                }
            }
        } else {
            const errorMsg = data.errors?.join(', ') || data.detail || 'Import failed';
            status.textContent = '‚ùå ' + errorMsg;
            status.className = 'expand-status error';
        }
    } catch (e) {
        status.textContent = '‚ùå Failed to connect to server';
        status.className = 'expand-status error';
    } finally {
        btn.disabled = false;
        importPreviewData = null;
    }
}

async function wipeAllData() {
    // Require typed confirmation
    const confirmText = prompt('This will permanently delete ALL your tasks and domains.\n\nType "DELETE" to confirm:');
    if (confirmText !== 'DELETE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        return;
    }

    const btn = document.getElementById('btn-wipe-data');
    btn.disabled = true;
    btn.textContent = 'Wiping...';

    try {
        const response = await fetch('/api/import/wipe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok && data.success) {
            alert(`Deleted ${data.tasks_deleted} tasks and ${data.domains_deleted} domains.`);
            window.location.reload();
        } else {
            alert(data.detail || 'Wipe failed');
        }
    } catch (e) {
        alert('Failed to connect to server');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Wipe All Data';
    }
}

// Backup functions
async function exportBackup() {
    const btn = document.getElementById('btn-export-backup');
    const statusWrap = document.getElementById('backup-status-wrap');
    const status = document.getElementById('backup-status');
    btn.disabled = true;
    btn.textContent = 'Exporting...';
    statusWrap.style.display = 'none';

    try {
        const response = await fetch('/api/backup/export');

        if (!response.ok) {
            throw new Error('Export failed');
        }

        // Get filename from Content-Disposition header
        const disposition = response.headers.get('Content-Disposition');
        const filenameMatch = disposition && disposition.match(/filename="(.+)"/);
        const filename = filenameMatch ? filenameMatch[1] : 'whendoist_backup.json';

        // Download the file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        status.textContent = '‚úÖ Backup downloaded successfully';
        status.className = 'expand-status success';
        statusWrap.style.display = 'block';
    } catch (e) {
        status.textContent = '‚ùå Export failed: ' + e.message;
        status.className = 'expand-status error';
        statusWrap.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Download Backup';
    }
}

async function importBackup(input) {
    const file = input.files[0];
    if (!file) return;

    // Confirm before importing
    const confirmText = prompt('This will REPLACE all your current data with the backup.\n\nType "RESTORE" to confirm:');
    if (confirmText !== 'RESTORE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        input.value = '';
        return;
    }

    const btn = document.getElementById('btn-import-backup');
    const statusWrap = document.getElementById('backup-status-wrap');
    const status = document.getElementById('backup-status');
    btn.disabled = true;
    btn.textContent = 'Restoring...';
    statusWrap.style.display = 'none';

    try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/backup/import', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            status.textContent = `‚úÖ Restored: ${data.domains} domains, ${data.tasks} tasks`;
            status.className = 'expand-status success';
            statusWrap.style.display = 'block';
            setTimeout(() => window.location.reload(), 1500);
        } else {
            // API returned an error response
            const errorMsg = data.detail || data.message || 'Import failed';
            throw new Error(errorMsg);
        }
    } catch (e) {
        // If response wasn't JSON, e.message will contain the parse error
        // but we want to show a more helpful message
        let errorMessage = e.message;
        if (e.message.includes('Unexpected token')) {
            errorMessage = 'Server error - check logs for details';
        }
        status.textContent = '‚ùå Restore failed: ' + errorMessage;
        status.className = 'expand-status error';
        statusWrap.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Restore Backup';
        input.value = '';
    }
}

// Show tasks needing clarity assignment
async function showUnclearTasks() {
    const container = document.getElementById('unclear-tasks-container');
    const btn = document.getElementById('btn-show-unclear');

    // Toggle visibility
    if (container.classList.contains('visible')) {
        container.classList.remove('visible');
        btn.textContent = 'Assign Clarity';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Loading...';

    try {
        const response = await fetch('/api/tasks?clarity=none');
        const tasks = await response.json();

        if (tasks.length === 0) {
            container.innerHTML = '<div class="unclear-empty">All tasks have clarity assigned. Energy filtering is fully available.</div>';
        } else {
            container.innerHTML = `
                <div class="unclear-tasks__hd">
                    ${tasks.length} task${tasks.length === 1 ? '' : 's'} need clarity
                    <span class="unclear-hint">Assign clarity to enable energy-based filtering</span>
                </div>
                ${tasks.map(task => `
                    <div class="unclear-task-row" data-task-id="${task.id}">
                        <span class="unclear-task-title">${escapeHtml(task.title)}</span>
                        <div class="clarity-btns">
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'executable')" title="Clear next action, can do when tired">Exec</button>
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'defined')" title="Know what to do, needs some focus">Def</button>
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'exploratory')" title="Needs research or deep thinking">Expl</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        container.classList.add('visible');
    } catch (e) {
        container.innerHTML = '<div class="unclear-empty">Failed to load tasks</div>';
        container.classList.add('visible');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Hide';
    }
}

async function setTaskClarity(taskId, clarity) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clarity })
        });

        if (response.ok) {
            const item = document.querySelector(`.unclear-task-row[data-task-id="${taskId}"]`);
            if (item) {
                item.remove();
                const container = document.getElementById('unclear-tasks-container');
                const remaining = container.querySelectorAll('.unclear-task-row').length;
                if (remaining === 0) {
                    container.innerHTML = '<div class="unclear-empty">All tasks have clarity assigned.</div>';
                } else {
                    const header = container.querySelector('.unclear-tasks__hd');
                    if (header) {
                        header.textContent = `${remaining} task${remaining === 1 ? '' : 's'} without clarity`;
                    }
                }
            }
        }
    } catch (e) {
        console.error('Failed to update task clarity:', e);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// Task Display Preferences
// ============================================================================

async function updatePreference(key, value) {
    try {
        const response = await fetch('/api/preferences', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [key]: value })
        });

        if (!response.ok) {
            console.error('Failed to update preference:', key);
        }
    } catch (e) {
        console.error('Failed to update preference:', e);
    }
}

// ============================================================================
// E2E Encryption
// ============================================================================

function showEncryptionSetup() {
    const wrap = document.getElementById('encryption-setup-wrap');
    const content = document.getElementById('encryption-setup-content');

    content.innerHTML = `
        <div class="expand-label">Set Up Encryption</div>
        <p class="expand-desc">
            Create a passphrase to encrypt your data. This passphrase is never sent to the server.
            <strong>Warning:</strong> If you forget your passphrase, your data cannot be recovered.
        </p>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
            <input type="password" id="encryption-passphrase" class="add-domain-input" placeholder="Enter passphrase (8+ characters)" style="width: 100%;">
            <input type="password" id="encryption-passphrase-confirm" class="add-domain-input" placeholder="Confirm passphrase" style="width: 100%;">
        </div>
        <div class="expand-actions">
            <div class="expand-actions__left">
                <button type="button" class="btn-sm btn-sm--primary" onclick="setupEncryption()">Enable Encryption</button>
                <button type="button" class="btn-sm btn-sm--ghost" onclick="hideEncryptionSetup()">Cancel</button>
            </div>
        </div>
        <div id="encryption-setup-status" class="expand-status" style="display: none;"></div>
    `;

    wrap.style.display = 'block';
    document.getElementById('encryption-passphrase').focus();
}

function hideEncryptionSetup() {
    const wrap = document.getElementById('encryption-setup-wrap');
    wrap.style.display = 'none';
}

async function setupEncryption() {
    const passphrase = document.getElementById('encryption-passphrase').value;
    const confirm = document.getElementById('encryption-passphrase-confirm').value;
    const status = document.getElementById('encryption-setup-status');

    // Validate
    if (passphrase.length < 8) {
        status.textContent = 'Passphrase must be at least 8 characters';
        status.className = 'expand-status error';
        status.style.display = 'block';
        return;
    }

    if (passphrase !== confirm) {
        status.textContent = 'Passphrases do not match';
        status.className = 'expand-status error';
        status.style.display = 'block';
        return;
    }

    status.textContent = 'Setting up encryption...';
    status.className = 'expand-status';
    status.style.display = 'block';

    try {
        // Generate salt, derive key, create test value
        const { salt, testValue } = await Crypto.setupEncryption(passphrase);

        // Fetch all content to encrypt
        status.textContent = 'Fetching data to encrypt...';
        const contentResponse = await fetch('/api/tasks/all-content');
        if (!contentResponse.ok) {
            throw new Error('Failed to fetch data');
        }
        const allContent = await contentResponse.json();

        // Encrypt all content
        status.textContent = `Encrypting ${allContent.tasks.length} tasks and ${allContent.domains.length} domains...`;
        const encrypted = await Crypto.encryptAllData(allContent.tasks, allContent.domains);

        // Save encrypted data to server
        status.textContent = 'Saving encrypted data...';

        // Batch update tasks
        if (encrypted.tasks.length > 0) {
            const taskResponse = await fetch('/api/tasks/batch-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tasks: encrypted.tasks })
            });
            if (!taskResponse.ok) {
                throw new Error('Failed to save encrypted tasks');
            }
        }

        // Batch update domains
        if (encrypted.domains.length > 0) {
            const domainResponse = await fetch('/api/domains/batch-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domains: encrypted.domains })
            });
            if (!domainResponse.ok) {
                throw new Error('Failed to save encrypted domains');
            }
        }

        // Enable encryption on server
        const response = await fetch('/api/preferences/encryption/setup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ salt, test_value: testValue })
        });

        if (response.ok) {
            status.textContent = 'Encryption complete! Refreshing page...';
            status.className = 'expand-status success';
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to enable encryption');
        }
    } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'expand-status error';
    }
}

async function disableEncryption() {
    // Verify we have the key to decrypt
    if (!Crypto.hasStoredKey()) {
        alert('Please unlock your data first before disabling encryption.');
        return;
    }

    const confirmText = prompt(
        'Disabling encryption will:\n' +
        '1. Decrypt all your tasks and domains\n' +
        '2. Store them as plaintext on the server\n\n' +
        'Type "DISABLE" to confirm:'
    );

    if (confirmText !== 'DISABLE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        return;
    }

    try {
        // Fetch all encrypted content
        const contentResponse = await fetch('/api/tasks/all-content');
        if (!contentResponse.ok) {
            throw new Error('Failed to fetch data');
        }
        const allContent = await contentResponse.json();

        // Decrypt all content
        const decrypted = await Crypto.decryptAllData(allContent.tasks, allContent.domains);

        // Save decrypted data to server
        if (decrypted.tasks.length > 0) {
            const taskResponse = await fetch('/api/tasks/batch-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tasks: decrypted.tasks })
            });
            if (!taskResponse.ok) {
                throw new Error('Failed to save decrypted tasks');
            }
        }

        if (decrypted.domains.length > 0) {
            const domainResponse = await fetch('/api/domains/batch-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domains: decrypted.domains })
            });
            if (!domainResponse.ok) {
                throw new Error('Failed to save decrypted domains');
            }
        }

        // Disable encryption on server
        const response = await fetch('/api/preferences/encryption/disable', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            Crypto.clearStoredKey();
            alert('Encryption disabled. Your data is now stored as plaintext.');
            window.location.reload();
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to disable encryption');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============================================================================
// Lock Status Management
// ============================================================================

function updateLockStatus() {
    const unlockedEl = document.getElementById('lock-status-unlocked');
    const lockedEl = document.getElementById('lock-status-locked');
    const reauthBtn = document.getElementById('btn-reauth');

    if (!unlockedEl || !lockedEl) return;  // Not on encryption-enabled page

    const isUnlocked = Crypto.hasStoredKey();

    if (isUnlocked) {
        unlockedEl.style.display = 'inline';
        lockedEl.style.display = 'none';
        if (reauthBtn) reauthBtn.style.display = 'none';
    } else {
        unlockedEl.style.display = 'none';
        lockedEl.style.display = 'inline';
        if (reauthBtn) reauthBtn.style.display = 'inline-block';
    }
}

function showReauthenticate() {
    // Show the unlock modal from base.html
    const modal = document.getElementById('passphrase-modal');
    if (modal) {
        modal.style.display = 'flex';

        // Show passkey section if passkeys are registered
        const passkeySection = document.getElementById('passkey-unlock-section');
        if (passkeySection && window.WHENDOIST?.hasPasskeys) {
            passkeySection.style.display = 'block';
        }
    }
}

// Update lock status on page load
document.addEventListener('DOMContentLoaded', function() {
    if (window.WHENDOIST?.encryptionEnabled) {
        updateLockStatus();
    }
});

// ============================================================================
// Passkey Management
// ============================================================================

function showAddPasskeyForm() {
    const wrap = document.getElementById('add-passkey-wrap');
    wrap.style.display = 'block';
    document.getElementById('passkey-name').focus();
}

function hideAddPasskeyForm() {
    const wrap = document.getElementById('add-passkey-wrap');
    wrap.style.display = 'none';
    document.getElementById('passkey-name').value = '';
    document.getElementById('passkey-setup-status').style.display = 'none';
}

async function registerPasskey() {
    const nameInput = document.getElementById('passkey-name');
    const statusEl = document.getElementById('passkey-setup-status');
    const btn = document.getElementById('btn-register-passkey');

    const name = nameInput.value.trim();
    if (!name) {
        statusEl.className = 'expand-status error';
        statusEl.textContent = 'Please enter a name for this passkey';
        statusEl.style.display = 'block';
        return;
    }

    if (!Passkey.isSupported()) {
        statusEl.className = 'expand-status error';
        statusEl.textContent = 'Your browser does not support passkeys';
        statusEl.style.display = 'block';
        return;
    }

    // Show loading state
    btn.disabled = true;
    btn.textContent = 'Registering...';
    statusEl.className = 'expand-status';
    statusEl.textContent = 'Follow your browser\'s prompts to create a passkey...';
    statusEl.style.display = 'block';

    try {
        const result = await Passkey.registerPasskey(name);

        if (result.success) {
            statusEl.className = 'expand-status success';
            statusEl.textContent = 'Passkey registered successfully! Reloading...';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            statusEl.className = 'expand-status error';
            statusEl.textContent = result.error || 'Failed to register passkey';
            btn.disabled = false;
            btn.textContent = 'Register Passkey';
        }
    } catch (e) {
        statusEl.className = 'expand-status error';
        statusEl.textContent = 'Error: ' + e.message;
        btn.disabled = false;
        btn.textContent = 'Register Passkey';
    }
}

async function deletePasskey(passkeyId, passkeyName) {
    const confirmDelete = confirm(`Remove passkey "${passkeyName}"?\n\nYou can still unlock with your passphrase or other passkeys.`);

    if (!confirmDelete) {
        return;
    }

    try {
        const response = await fetch(`/api/passkeys/${passkeyId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Failed to delete passkey: ' + (error.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============================================================================
// Build Provenance
// ============================================================================

let buildInfo = null;
let verificationInfo = null;

// Load build info on page load
async function loadBuildInfo() {
    try {
        const response = await fetch('/api/build/info');
        if (response.ok) {
            buildInfo = await response.json();
            updateBuildDisplay();
        }
    } catch (e) {
        console.error('Failed to load build info:', e);
    }
}

function updateBuildDisplay() {
    if (!buildInfo) return;

    const versionEl = document.getElementById('build-version');
    const commitEl = document.getElementById('build-commit');

    if (versionEl) {
        versionEl.textContent = `Whendoist ${buildInfo.version}`;
    }

    if (commitEl) {
        const commit = buildInfo.commit || {};
        commitEl.textContent = commit.short ? `${commit.short}` : '';
    }
}

function showVerifyBuildModal() {
    document.getElementById('verify-build-overlay').classList.add('open');
    loadVerificationInfo();
}

function closeVerifyBuildModal() {
    document.getElementById('verify-build-overlay').classList.remove('open');
}

async function loadVerificationInfo() {
    const content = document.getElementById('verify-build-content');

    try {
        const response = await fetch('/api/build/verify');
        if (!response.ok) throw new Error('Failed to load');

        verificationInfo = await response.json();
        renderVerificationModal();
    } catch (e) {
        content.innerHTML = `
            <div style="color: var(--danger);">
                Failed to load verification info: ${e.message}
            </div>
        `;
    }
}

async function verifyBuildHashes() {
    const statusEl = document.getElementById('verify-status');
    const btnEl = document.getElementById('btn-verify-build');

    if (!verificationInfo || !verificationInfo.hashes) {
        statusEl.innerHTML = '<span style="color: var(--danger);">No hashes available to verify</span>';
        statusEl.style.display = 'block';
        return;
    }

    btnEl.disabled = true;
    btnEl.textContent = 'Verifying...';
    statusEl.innerHTML = '<span style="color: var(--text-muted);">Computing hashes...</span>';
    statusEl.style.display = 'block';

    const expectedHashes = verificationInfo.hashes;
    // All CSS and JS files for comprehensive verification
    const keyFiles = [
        'css/app.css',
        'css/dashboard.css',
        'css/dialog.css',
        'js/crypto.js',
        'js/drag-drop.js',
        'js/energy-selector.js',
        'js/plan-tasks.js',
        'js/recurrence-picker.js',
        'js/task-complete.js',
        'js/task-dialog.js',
        'js/task-list-options.js',
        'js/task-sheet.js',
        'js/task-sort.js',
        'js/toast.js'
    ];
    const results = [];
    let allPassed = true;

    for (const file of keyFiles) {
        if (!expectedHashes[file]) continue;

        try {
            // Fetch the file
            const response = await fetch(`/static/${file}`, { cache: 'no-store' });
            const text = await response.text();

            // Compute SHA256 hash
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const computedHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            const expected = expectedHashes[file];
            const passed = computedHash === expected;

            if (!passed) allPassed = false;

            results.push({
                file,
                passed,
                computed: computedHash,
                expected: expected,
                error: null
            });
        } catch (e) {
            allPassed = false;
            results.push({ file, passed: false, computed: null, expected: expectedHashes[file], error: e.message });
        }
    }

    // Render results - show full hash comparison for mismatches
    const resultsHtml = results.map(r => {
        const icon = r.passed ? '‚úì' : '‚úó';
        const color = r.passed ? '#16a34a' : 'var(--danger)';

        if (r.error) {
            return `<div style="margin-bottom: 8px; padding: 8px; background: rgba(220, 38, 38, 0.04); border-radius: 4px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: ${color}; font-weight: 600;">${icon}</span>
                    <span style="flex: 1; font-weight: 500;">${r.file}</span>
                    <span style="font-size: 0.65rem; color: var(--danger);">error</span>
                </div>
                <div style="font-size: 0.65rem; color: var(--danger); margin-top: 4px; margin-left: 18px;">
                    ${r.error}
                </div>
            </div>`;
        }

        if (r.passed) {
            return `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; padding: 4px 0;">
                <span style="color: ${color}; font-weight: 600;">${icon}</span>
                <span style="flex: 1;">${r.file}</span>
                <span style="font-size: 0.65rem; color: var(--text-muted);">match</span>
            </div>`;
        }

        // Mismatch - show full details
        return `<div style="margin-bottom: 8px; padding: 8px; background: rgba(220, 38, 38, 0.04); border-radius: 4px;">
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                <span style="color: ${color}; font-weight: 600;">${icon}</span>
                <span style="flex: 1; font-weight: 500;">${r.file}</span>
                <span style="font-size: 0.65rem; color: var(--danger);">mismatch</span>
            </div>
            <div style="font-size: 0.62rem; font-family: monospace; margin-left: 18px;">
                <div style="color: var(--text-muted); margin-bottom: 2px;">
                    <span style="display: inline-block; width: 60px;">Expected:</span>
                    <code style="background: var(--grey-bg); padding: 1px 4px; border-radius: 2px; word-break: break-all;">${r.expected}</code>
                </div>
                <div style="color: var(--danger);">
                    <span style="display: inline-block; width: 60px;">Got:</span>
                    <code style="background: rgba(220, 38, 38, 0.08); padding: 1px 4px; border-radius: 2px; word-break: break-all;">${r.computed}</code>
                </div>
            </div>
        </div>`;
    }).join('');

    const matchCount = results.filter(r => r.passed).length;
    const mismatchCount = results.filter(r => !r.passed).length;
    const summaryColor = allPassed ? '#16a34a' : 'var(--danger)';
    const summaryText = allPassed
        ? `All ${matchCount} files verified ‚úì`
        : `${mismatchCount} file${mismatchCount === 1 ? '' : 's'} modified (${matchCount} matched)`;

    const explanation = allPassed
        ? 'The served files match the expected hashes from the build manifest.'
        : 'Some files differ from the build manifest. This may be expected in development, or could indicate tampering in production.';

    statusEl.innerHTML = `
        <div style="margin-bottom: 10px; padding: 10px; background: ${allPassed ? 'rgba(22, 163, 74, 0.08)' : 'rgba(220, 38, 38, 0.08)'}; border-radius: 6px;">
            <div style="text-align: center; margin-bottom: 4px;">
                <span style="color: ${summaryColor}; font-weight: 600;">${summaryText}</span>
            </div>
            <div style="text-align: center; font-size: 0.68rem; color: var(--text-muted);">
                ${explanation}
            </div>
        </div>
        <div style="font-size: 0.72rem;">${resultsHtml}</div>
    `;

    btnEl.disabled = false;
    btnEl.textContent = 'Verify Again';
}

function renderVerificationModal() {
    const content = document.getElementById('verify-build-content');
    const info = verificationInfo;

    if (!info) return;

    const commit = info.commit || {};
    const build = info.build || {};
    const verification = info.verification || {};

    content.innerHTML = `
        <div style="margin-bottom: 16px;">
            <div style="color: var(--text-muted); font-size: 0.75rem;">
                Running from commit <code style="background: var(--grey-bg); padding: 1px 4px; border-radius: 3px;">${commit.short || 'unknown'}</code>
                ${commit.date ? ` (${new Date(commit.date).toLocaleDateString()})` : ''}
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <div style="background: var(--grey-bg); padding: 10px; border-radius: 6px; text-align: center;">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--text);">${info.version || 'unknown'}</div>
                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Version</div>
            </div>
            <div style="background: var(--grey-bg); padding: 10px; border-radius: 6px; text-align: center;">
                <div style="font-size: 0.9rem; font-weight: 600; color: var(--text); font-family: monospace;">${build.hash || 'n/a'}</div>
                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Build Hash</div>
            </div>
        </div>

        <!-- Verify Build Section -->
        <div style="border-top: 1px solid var(--border-hair); padding-top: 12px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);">
                    Verify Build Integrity
                </div>
                <button type="button" class="btn-sm btn-sm--primary" id="btn-verify-build" onclick="verifyBuildHashes()">
                    Verify Build
                </button>
            </div>
            <div style="font-size: 0.68rem; color: var(--text-muted); margin-bottom: 8px;">
                Computes SHA256 hashes of served files (CSS/JS) and compares against the build manifest.
                <br>The manifest contains hashes generated when the build was created.
            </div>
            <div id="verify-status" style="display: none;"></div>
        </div>

        <!-- Manual Verification Section -->
        <div style="border-top: 1px solid var(--border-hair); padding-top: 12px; margin-top: 12px;">
            <div style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 8px;">
                Manual Verification
            </div>
            <div style="font-size: 0.68rem; color: var(--text-muted); margin-bottom: 8px;">
                To independently verify the build, clone the repo and compare SHA256 hashes:
            </div>
            <div style="background: var(--grey-bg); border-radius: 6px; padding: 10px; font-family: monospace; font-size: 0.68rem; white-space: pre-wrap; overflow-x: auto; position: relative;">
<code style="display: block; line-height: 1.6;"># 1. Clone and checkout this version
git clone https://github.com/aleksandr-bogdanov/whendoist
cd whendoist && git checkout ${info.version || 'master'}

# 2. Generate SHA256 hashes locally
sha256sum static/css/*.css static/js/*.js</code>
            </div>
            <div style="font-size: 0.68rem; color: var(--text-muted); margin-top: 10px; margin-bottom: 6px;">
                Expected hashes from build manifest (first 3 key files):
            </div>
            ${info.hashes ? `
            <div style="background: var(--grey-bg); border-radius: 6px; padding: 8px 10px; font-family: monospace; font-size: 0.62rem; overflow-x: auto;">
                ${['css/app.css', 'js/crypto.js', 'js/toast.js'].map(f => info.hashes[f] ?
                    `<div style="margin-bottom: 3px; display: flex; gap: 8px;">
                        <span style="color: var(--text-muted); flex-shrink: 0;">${f}:</span>
                        <code style="word-break: break-all; color: var(--text);">${info.hashes[f]}</code>
                    </div>` : '').join('')}
                <div style="color: var(--text-faint); font-size: 0.6rem; margin-top: 4px;">
                    + ${Object.keys(info.hashes).length - 3} more files... (click "Verify Build" to see all)
                </div>
            </div>
            ` : '<div style="color: var(--text-muted); font-size: 0.68rem;">No hashes available in manifest</div>'}
        </div>

        <!-- Links Section -->
        <div style="border-top: 1px solid var(--border-hair); padding-top: 12px; margin-top: 12px;">
            <div style="font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 8px;">
                External Links
            </div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
                <a href="${verification.github_release || '#'}" target="_blank" style="font-size: 0.75rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    GitHub Release
                </a>
                <a href="${verification.source_code || '#'}" target="_blank" style="font-size: 0.75rem; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                    View Source Code
                </a>
            </div>
        </div>
    `;
}

// Load build info when page loads
document.addEventListener('DOMContentLoaded', loadBuildInfo);

// Escape key to close verify modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeVerifyBuildModal();
    }
});

// Decrypt domain names on page load
(async function decryptDomainNames() {
    if (!Crypto.canCrypto()) return;

    const domainRows = document.querySelectorAll('#domain-list [data-domain-name]');
    for (const row of domainRows) {
        const encryptedName = row.dataset.domainName;
        if (!encryptedName) continue;

        try {
            const decryptedName = await Crypto.decryptField(encryptedName);
            if (!decryptedName || decryptedName === encryptedName) continue;

            // Update the displayed name
            const nameEl = row.querySelector('.domain-name');
            if (nameEl) {
                nameEl.textContent = decryptedName;
                nameEl.title = decryptedName;
            }
        } catch (e) {
            console.error('Failed to decrypt domain name:', e);
        }
    }
})();
</script>
{% endblock %}
