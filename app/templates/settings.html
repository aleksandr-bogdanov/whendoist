{% extends "base.html" %}

{% block title %}Settings - Whendoist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/pages/settings.css">
{% endblock %}
{% block content %}
<div class="settings-page">
    <div class="page-surface">
        <h1 class="settings-title">Settings</h1>

        <div class="settings-grid">
            <!-- APPEARANCE Section (Main - at top) -->
            <section class="settings-section">
                <h2 class="settings-section-label">Appearance</h2>

                <!-- THEME Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Theme</p>
                            <p class="panel-desc">Customize how Whendoist looks.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Color Mode</span>
                                <span class="pref-desc">Choose light, dark, or follow your system preference</span>
                            </div>
                            <div class="settings-row__right">
                                <div class="theme-toggle" id="theme-toggle">
                                    <button type="button" class="theme-btn" data-theme="light" onclick="setTheme('light')" title="Light mode">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="5"/>
                                            <line x1="12" y1="1" x2="12" y2="3"/>
                                            <line x1="12" y1="21" x2="12" y2="23"/>
                                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                            <line x1="1" y1="12" x2="3" y2="12"/>
                                            <line x1="21" y1="12" x2="23" y2="12"/>
                                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="theme-btn" data-theme="dark" onclick="setTheme('dark')" title="Dark mode">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="theme-btn" data-theme="system" onclick="setTheme('system')" title="System preference">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                            <line x1="8" y1="21" x2="16" y2="21"/>
                                            <line x1="12" y1="17" x2="12" y2="21"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- REGIONAL Section -->
            <section class="settings-section">
                <h2 class="settings-section-label">Regional</h2>

                <!-- TIMEZONE Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Timezone</p>
                            <p class="panel-desc">Your timezone for scheduling and "today" calculations.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Current Timezone</span>
                                <span class="pref-desc" id="timezone-display">{{ user_timezone or 'Auto-detected on next page load' }}</span>
                            </div>
                            <div class="settings-row__right">
                                <select id="timezone-select" class="pref-select" onchange="updateTimezone(this.value)">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CONNECTIONS Section -->
            <section class="settings-section">
                <h2 class="settings-section-label">Connections</h2>

                <!-- INTEGRATIONS Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Integrations</p>
                            <p class="panel-desc">Connect external accounts used to sync tasks and events.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Google Calendar row -->
                        {% if google_connected %}
                        <div class="settings-row settings-row--clickable" onclick="toggleGcalSection()" id="gcal-row">
                            <div class="provider-icon">G</div>
                            <div class="provider-info">
                                <div class="provider-name">Google Calendar</div>
                                <div class="provider-status">
                                    <span class="status-dot connected"></span>
                                    Connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <div class="row-chevron" id="gcal-chevron">
                                    <svg class="icon icon-sm" aria-hidden="true">
                                        <use href="{{ url_for('static', path='img/icons/ui-icons.svg') }}#chevron-down"></use>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <!-- Google Calendar expanded section -->
                        <div class="expand-section" id="gcal-expand">
                            <div class="expand-content">
                                <!-- Sub-section: Visible Calendars -->
                                <div class="expand-subsection">
                                    <div class="expand-label-row">
                                        <div class="expand-label">Visible Calendars</div>
                                        {% if calendars %}
                                        <span class="expand-hint">Toggle to show</span>
                                        {% endif %}
                                    </div>
                                    {% if calendars %}
                                    <div class="expand-list">
                                        {% for cal in calendars %}
                                        {% if cal.summary == "Whendoist" or (user_prefs and user_prefs.gcal_sync_calendar_id and cal.id == user_prefs.gcal_sync_calendar_id) %}
                                        {# Skip ‚Äî shown in Task Sync sub-section instead #}
                                        {% else %}
                                        <div class="settings-row settings-row--clickable settings-row--calendar" onclick="toggleCalendarVisibility('{{ cal.id }}', this)">
                                            <div class="calendar-dot" style="background-color: {{ cal.background_color }};"></div>
                                            <div class="calendar-info">
                                                <span class="calendar-name" title="{{ cal.summary }}">{{ cal.summary }}</span>
                                                {% if cal.primary %}
                                                <div class="calendar-meta">
                                                    <span class="calendar-badge">Primary</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="settings-row__right">
                                                <button
                                                    type="button"
                                                    class="toggle-switch {% if cal.enabled %}enabled{% endif %}"
                                                    data-calendar-id="{{ cal.id }}"
                                                    onclick="event.stopPropagation(); toggleCalendarVisibility('{{ cal.id }}', this.closest('.settings-row'))"
                                                    aria-label="Toggle calendar"
                                                ></button>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                        <div class="empty-state">No calendars found</div>
                                    {% endif %}
                                </div>

                                <!-- Divider -->
                                <div class="expand-divider"></div>

                                <!-- Sub-section: Task Sync -->
                                <div class="expand-subsection" id="gcal-sync-section">
                                    <div class="expand-label-row">
                                        <div class="expand-label">Task Sync</div>
                                        {% for cal in calendars %}
                                        {% if cal.summary == "Whendoist" or (user_prefs and user_prefs.gcal_sync_calendar_id and cal.id == user_prefs.gcal_sync_calendar_id) %}
                                        <span class="sync-target-hint">
                                            <span class="calendar-dot" style="background-color: {{ cal.background_color }};"></span>
                                            {{ cal.summary }}
                                        </span>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% if encryption_enabled %}
                                    <div class="expand-list">
                                        <div class="settings-row">
                                            <div class="backup-info">
                                                <span class="pref-label">Sync tasks to Google Calendar</span>
                                                <span class="pref-desc" style="color: var(--color-text-muted);">
                                                    Sync requires unencrypted task titles. Disable E2E encryption to use this feature.
                                                </span>
                                            </div>
                                            <div class="settings-row__right">
                                                <button type="button" class="toggle-switch" disabled title="Requires encryption to be disabled"></button>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    {% if user_prefs and user_prefs.gcal_sync_error %}
                                    <div class="settings-row" id="gcal-sync-error-row" style="background: var(--color-danger-bg, #fef2f2); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px;">
                                        <div class="backup-info">
                                            <span class="pref-label" style="color: var(--color-danger, #dc2626);">Sync stopped</span>
                                            <span class="pref-desc" style="color: var(--color-danger, #dc2626);">
                                                {{ user_prefs.gcal_sync_error }}
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="expand-list">
                                        <div class="settings-row">
                                            <div class="backup-info">
                                                <span class="pref-label">Sync tasks to Google Calendar</span>
                                                <span class="pref-desc" id="gcal-sync-status">
                                                    {% if user_prefs and user_prefs.gcal_sync_enabled %}
                                                    Synced to: Whendoist calendar
                                                    {% else %}
                                                    One-way sync &mdash; changes in Whendoist appear in Google Calendar.
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="settings-row__right">
                                                <button
                                                    type="button"
                                                    class="toggle-switch {% if user_prefs and user_prefs.gcal_sync_enabled %}enabled{% endif %}"
                                                    id="gcal-sync-toggle"
                                                    onclick="event.stopPropagation(); toggleGcalSync(this)"
                                                    aria-label="Toggle Google Calendar sync"
                                                ></button>
                                            </div>
                                        </div>
                                        {% if user_prefs and user_prefs.gcal_sync_enabled %}
                                        <div class="settings-row" id="gcal-sync-options">
                                            <div class="backup-info">
                                                <span class="pref-label">Include date-only tasks as all-day events</span>
                                                <span class="pref-desc">Tasks without a specific time will appear as all-day events.</span>
                                            </div>
                                            <div class="settings-row__right">
                                                <button
                                                    type="button"
                                                    class="toggle-switch {% if user_prefs.gcal_sync_all_day %}enabled{% endif %}"
                                                    id="gcal-sync-allday-toggle"
                                                    onclick="event.stopPropagation(); toggleGcalSyncAllDay(this)"
                                                    aria-label="Toggle all-day event sync"
                                                ></button>
                                            </div>
                                        </div>
                                        <div class="settings-row">
                                            <div class="backup-info">
                                                <span class="pref-label">Re-sync all tasks</span>
                                                <span class="pref-desc">Force a full re-sync of all scheduled tasks.</span>
                                            </div>
                                            <div class="settings-row__right">
                                                <button type="button" class="btn-sm btn-sm--secondary" id="btn-resync" onclick="event.stopPropagation(); resyncAllTasks()">Re-sync</button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="settings-row">
                            <div class="provider-icon">G</div>
                            <div class="provider-info">
                                <div class="provider-name">Google Calendar</div>
                                <div class="provider-status">
                                    <span class="status-dot"></span>
                                    Not connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <a href="/auth/google" class="btn-sm btn-sm--primary">Connect</a>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Todoist row (expandable when connected) -->
                        {% if todoist_connected %}
                        <div class="settings-row settings-row--clickable" onclick="toggleTodoistSection()" id="todoist-row">
                            <div class="provider-icon">T</div>
                            <div class="provider-info">
                                <div class="provider-name">Todoist</div>
                                <div class="provider-status">
                                    <span class="status-dot connected"></span>
                                    Connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <div class="row-chevron" id="todoist-chevron">
                                    <svg class="icon icon-sm" aria-hidden="true">
                                        <use href="{{ url_for('static', path='img/icons/ui-icons.svg') }}#chevron-down"></use>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <!-- Todoist expanded section -->
                        <div class="expand-section" id="todoist-expand">
                            <div class="expand-content">
                                <div class="expand-label">Todoist Integration</div>
                                <p class="expand-desc">
                                    Import projects and tasks from Todoist. Projects become domains; tasks keep due dates and priorities. After import, assign clarity levels to enable energy-based filtering.
                                </p>
                                <div class="expand-actions">
                                    <div class="expand-actions__left">
                                        <button type="button" class="btn-sm btn-sm--primary" id="btn-import-todoist" onclick="event.stopPropagation(); importFromTodoist()">
                                            Import from Todoist
                                        </button>
                                        <button type="button" class="btn-sm btn-sm--ghost" id="btn-show-unclear" onclick="event.stopPropagation(); showUnclearTasks()">
                                            Assign Clarity
                                        </button>
                                    </div>
                                    <button type="button" class="btn-text-danger" onclick="event.stopPropagation(); disconnectTodoist()">
                                        Disconnect
                                    </button>
                                </div>
                                <div id="import-status" class="expand-status" style="display: none;"></div>
                                <div id="unclear-tasks-container" class="unclear-tasks"></div>
                            </div>
                        </div>
                        {% else %}
                        <div class="settings-row">
                            <div class="provider-icon">T</div>
                            <div class="provider-info">
                                <div class="provider-name">Todoist</div>
                                <div class="provider-status">
                                    <span class="status-dot"></span>
                                    Not connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <a href="/auth/todoist" class="btn-sm btn-sm--primary">Connect</a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </section>

            <!-- DATA Section -->
            <section class="settings-section">
                <h2 class="settings-section-label">Data</h2>

                <!-- LIFE DOMAINS Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Life Domains</p>
                            <p class="panel-desc">Domains group tasks in Whendoist. They can be imported from Todoist projects or created manually.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd" id="domain-list">
                        {% if domains %}
                            {% for domain in domains|sort(attribute='name') %}
                            <div class="settings-row" data-domain-id="{{ domain.id }}" data-domain-name="{{ domain.name }}">
                                <span class="domain-icon">{{ domain.icon or 'üìÅ' }}</span>
                                <span class="domain-name" title="{% if encryption_enabled %}Encrypted{% else %}{{ domain.name }}{% endif %}">{% if encryption_enabled %}üîí{% else %}{{ domain.name }}{% endif %}</span>
                                <div class="domain-meta">
                                    <span class="domain-task-count" title="Active tasks">{{ domain_task_counts.get(domain.id, 0) }} tasks</span>
                                    {% if domain.external_id %}
                                    <span class="domain-imported">Imported</span>
                                    {% endif %}
                                </div>
                                <div class="row-actions">
                                    <button type="button" class="icon-btn edit" data-domain-id="{{ domain.id }}" data-domain-name="{{ domain.name }}" data-domain-icon="{{ domain.icon or '' }}" onclick="editDomain(this)" title="Edit" aria-label="Edit domain">
                                        <svg class="icon icon-xs" aria-hidden="true">
                                            <use href="{{ url_for('static', path='img/icons/ui-icons.svg') }}#edit"></use>
                                        </svg>
                                    </button>
                                    <button type="button" class="icon-btn delete" onclick="deleteDomain({{ domain.id }})" title="Delete" aria-label="Delete domain">
                                        <svg class="icon icon-xs" aria-hidden="true">
                                            <use href="{{ url_for('static', path='img/icons/ui-icons.svg') }}#delete"></use>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state" id="domains-empty">No domains yet</div>
                        {% endif %}
                        <!-- Add domain row -->
                        <div class="settings-row settings-row--add">
                            <div class="emoji-picker-wrap">
                                <button type="button" class="emoji-picker-btn" id="new-domain-icon-btn" onclick="toggleEmojiPicker('new')" aria-label="Choose domain icon">üìÅ</button>
                                <div class="emoji-picker-popover" id="emoji-picker-new"></div>
                            </div>
                            <input type="text" id="new-domain-name" class="add-domain-input" placeholder="Add new domain..." maxlength="100" aria-label="New domain name">
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" onclick="addDomain()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BACKUP Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Backup</p>
                            <p class="panel-desc">Export and restore your data as JSON.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Export -->
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Export Data</span>
                                <span class="pref-desc">Download all tasks, domains, and settings as JSON</span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-export-backup" onclick="exportBackup()">
                                    Download Backup
                                </button>
                            </div>
                        </div>
                        <!-- Import -->
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Import Data</span>
                                <span class="pref-desc">Restore from a backup file (replaces current data)</span>
                            </div>
                            <div class="settings-row__right">
                                <input type="file" id="backup-file-input" accept=".json" style="display: none;" onchange="importBackup(this)">
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-import-backup" onclick="document.getElementById('backup-file-input').click()">
                                    Restore Backup
                                </button>
                            </div>
                        </div>
                        <div id="backup-status-wrap" class="expand-content" style="display: none; padding-top: 0;">
                            <div id="backup-status" class="expand-status" style="margin-top: 0;"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECURITY Section -->
            <section class="settings-section">
                <h2 class="settings-section-label">Security</h2>

                <!-- SECURITY Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Security</p>
                            <p class="panel-desc">End-to-end encryption protects your task data. Only you can read it.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Encryption status -->
                        <div class="settings-row" id="encryption-row">
                            <div class="backup-info">
                                <span class="pref-label">End-to-End Encryption</span>
                                <span class="pref-desc" id="encryption-status-text">
                                    {% if user_prefs.encryption_enabled %}
                                    Enabled - your data is encrypted
                                    {% else %}
                                    Disabled - data stored in plaintext
                                    {% endif %}
                                </span>
                            </div>
                            <div class="settings-row__right">
                                {% if user_prefs.encryption_enabled %}
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-encryption-toggle" onclick="disableEncryption()">
                                    Disable
                                </button>
                                {% else %}
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-encryption-toggle" onclick="showEncryptionSetup()">
                                    Enable
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div id="encryption-setup-wrap" class="expand-content" style="display: none; margin-top: 12px;">
                            <div id="encryption-setup-content"></div>
                        </div>

                        <!-- Lock Status (shown only when encryption is enabled) -->
                        {% if user_prefs.encryption_enabled %}
                        <div class="settings-row" id="lock-status-row">
                            <div class="backup-info">
                                <span class="pref-label">Lock Status</span>
                                <span class="pref-desc" id="lock-status-text">
                                    <span id="lock-status-unlocked" style="color: var(--success-color, #22c55e);">üîì Unlocked</span>
                                    <span id="lock-status-locked" style="display: none; color: var(--text-muted);">üîí Locked</span>
                                </span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-reauth" onclick="showReauthenticate()" style="display: none;">
                                    Re-authenticate
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Passkey Management (shown only when encryption is enabled) -->
                        {% if user_prefs.encryption_enabled %}
                        <div class="settings-row" id="passkey-row">
                            <div class="backup-info">
                                <span class="pref-label">Passkey Unlock</span>
                                <span class="pref-desc" id="passkey-status-text">
                                    {% if passkey_count > 0 %}
                                    {{ passkey_count }} passkey{% if passkey_count > 1 %}s{% endif %} registered
                                    {% else %}
                                    No passkeys - unlock with passphrase only
                                    {% endif %}
                                </span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-add-passkey" onclick="showAddPasskeyForm()">
                                    Add Passkey
                                </button>
                            </div>
                        </div>

                        <!-- Passkey list -->
                        <div id="passkey-list" class="passkey-list">
                            {% for passkey in user_passkeys %}
                            <div class="passkey-item" data-id="{{ passkey.id }}">
                                <div class="passkey-item__info">
                                    <span class="passkey-item__name">{{ passkey.name }}</span>
                                    <span class="passkey-item__date">Added {{ passkey.created_at.strftime('%b %d, %Y') }}</span>
                                </div>
                                <button type="button" class="btn-sm btn-sm--ghost btn-sm--danger" onclick="deletePasskey({{ passkey.id }}, '{{ passkey.name }}')">
                                    Remove
                                </button>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Add passkey form (hidden by default) -->
                        <div id="add-passkey-wrap" class="expand-content" style="display: none; padding-top: 0;">
                            <div id="add-passkey-content">
                                <div class="expand-label">Add Passkey</div>
                                <p class="expand-desc">
                                    Use your device's biometrics, security key, or password manager to unlock encrypted data.
                                </p>
                                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                    <input type="text" id="passkey-name" class="add-domain-input" placeholder="Passkey name (e.g., 1Password, Touch ID)" style="flex: 1;" aria-label="Passkey name">
                                </div>
                                <div class="expand-actions">
                                    <div class="expand-actions__left">
                                        <button type="button" class="btn-sm btn-sm--primary" id="btn-register-passkey" onclick="registerPasskey()">Register Passkey</button>
                                        <button type="button" class="btn-sm btn-sm--ghost" onclick="hideAddPasskeyForm()">Cancel</button>
                                    </div>
                                </div>
                                <div id="passkey-setup-status" class="expand-status" style="display: none;"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </section>

            <!-- ACCOUNT Section (Danger Zone) -->
            <section class="settings-section settings-section--danger">
                <h2 class="settings-section-label">Account</h2>

                <!-- SETUP Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Setup</p>
                            <p class="panel-desc">Run the setup wizard again to reconfigure your account.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Setup Wizard</span>
                                <span class="pref-desc">
                                    {% if user.wizard_completed_at %}
                                    Completed {{ user.wizard_completed_at.strftime('%b %d, %Y') }}
                                    {% else %}
                                    Not yet completed
                                    {% endif %}
                                </span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" onclick="rerunWizard()">
                                    Re-run Wizard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MAINTENANCE Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Maintenance</p>
                            <p class="panel-desc">Delete local Whendoist data. This cannot be undone.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <div class="maintenance-content">
                            <div class="maintenance-info">
                                <div class="maintenance-warning">Danger Zone</div>
                                <div class="maintenance-desc">Permanently delete all tasks and domains from Whendoist.</div>
                            </div>
                            <button type="button" class="btn-sm btn-sm--danger" id="btn-wipe-data" onclick="wipeAllData()">
                                Wipe All Data
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Settings Footer - spans full width -->
        <footer class="settings-footer">
            <span id="build-version">Whendoist</span>
            <span class="footer-sep">¬∑</span>
            <span id="build-commit" class="footer-muted"></span>
            <span class="footer-sep">¬∑</span>
            <a href="https://github.com/aleksandr-bogdanov/whendoist" target="_blank" class="footer-link">GitHub</a>
            <span class="footer-sep">¬∑</span>
            <a href="https://github.com/aleksandr-bogdanov/whendoist/blob/main/LICENSE" target="_blank" class="footer-link">MIT License</a>
            <span class="footer-sep">¬∑</span>
            <a href="https://github.com/aleksandr-bogdanov/whendoist#acknowledgments" target="_blank" class="footer-link">Credits</a>
        </footer>
    </div>
</div>

<!-- Domain Edit Modal -->
<div class="modal-overlay" id="domain-edit-overlay" onclick="if(event.target === this) closeDomainEdit()">
    <div class="modal">
        <h3 class="modal__title">Edit Domain</h3>
        <form class="modal__form" onsubmit="saveDomainEdit(event)">
            <input type="hidden" id="edit-domain-id">
            <input type="hidden" id="edit-domain-icon">
            <div class="modal__row">
                <div class="emoji-picker-wrap">
                    <button type="button" class="emoji-picker-btn" id="edit-domain-icon-btn" onclick="toggleEmojiPicker('edit')" aria-label="Choose domain icon">üìÅ</button>
                    <div class="emoji-picker-popover" id="emoji-picker-edit"></div>
                </div>
                <input type="text" id="edit-domain-name" placeholder="Domain name" required maxlength="100" aria-label="Domain name">
            </div>
            <div class="modal__actions">
                <button type="button" class="btn-sm btn-sm--secondary" onclick="closeDomainEdit()">Cancel</button>
                <button type="submit" class="btn-sm btn-sm--primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
// Timezone picker
(function initTimezoneSelect() {
    const select = document.getElementById('timezone-select');
    if (!select) return;

    const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const savedTz = '{{ user_timezone|default("") }}';
    const currentTz = savedTz || detectedTz;

    // Get common timezones (subset of IANA timezones)
    const commonTimezones = [
        'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
        'America/Phoenix', 'America/Anchorage', 'Pacific/Honolulu',
        'America/Toronto', 'America/Vancouver', 'America/Mexico_City', 'America/Sao_Paulo',
        'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Europe/Rome', 'Europe/Madrid',
        'Europe/Amsterdam', 'Europe/Brussels', 'Europe/Moscow', 'Europe/Istanbul',
        'Asia/Tokyo', 'Asia/Shanghai', 'Asia/Hong_Kong', 'Asia/Singapore', 'Asia/Seoul',
        'Asia/Kolkata', 'Asia/Dubai', 'Asia/Bangkok', 'Asia/Jakarta',
        'Australia/Sydney', 'Australia/Melbourne', 'Australia/Perth', 'Pacific/Auckland',
        'Africa/Cairo', 'Africa/Johannesburg', 'Africa/Lagos'
    ];

    // Try to get full list from browser, fall back to common list
    let timezones = commonTimezones;
    try {
        if (Intl.supportedValuesOf) {
            timezones = Intl.supportedValuesOf('timeZone');
        }
    } catch (e) {
        // Browser doesn't support supportedValuesOf, use common list
    }

    // Add current timezone first if not in list
    if (currentTz && !timezones.includes(currentTz)) {
        const option = document.createElement('option');
        option.value = currentTz;
        option.textContent = currentTz.replace(/_/g, ' ');
        option.selected = true;
        select.appendChild(option);
    }

    // Populate the dropdown
    timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz;
        option.textContent = tz.replace(/_/g, ' ');
        if (tz === currentTz) {
            option.selected = true;
        }
        select.appendChild(option);
    });
})();

async function updateTimezone(timezone) {
    const display = document.getElementById('timezone-display');

    try {
        const response = await fetch('/api/v1/preferences', {
            method: 'PUT',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ timezone })
        });

        if (!response.ok) {
            throw new Error('Failed to update timezone');
        }

        // Update display
        display.textContent = timezone.replace(/_/g, ' ');
        window.WHENDOIST.userTimezone = timezone;

        // Show success feedback
        display.style.color = 'var(--color-success)';
        setTimeout(() => { display.style.color = ''; }, 1000);
    } catch (error) {
        console.error('Timezone update failed:', error);
        display.textContent = 'Update failed';
        display.style.color = 'var(--color-danger)';
    }
}

// Emoji picker
const DOMAIN_EMOJIS = [
    'üìÅ', 'üíº', 'üè†', 'üë§', 'üë•', 'üí™', 'üßò',
    'üìö', 'üéì', 'üíª', 'üé®', 'üéµ', 'üéÆ', 'üì∑',
    '‚úàÔ∏è', 'üöó', 'üèÉ', '‚öΩ', 'üéØ', 'üí∞', 'üìà',
    '‚ù§Ô∏è', 'üåü', 'üî•', '‚ú®', 'üéâ', 'üéÅ', 'üèÜ',
    'üçé', 'ü•ó', '‚òï', 'üç≥', 'üõí', 'üè•', 'üíä',
    'üêï', 'üå±', 'üåç', '‚òÄÔ∏è', 'üåô', '‚ö°', 'üîß'
];

let activeEmojiPicker = null;

function renderEmojiPicker(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="emoji-grid">
            ${DOMAIN_EMOJIS.map(emoji => `
                <button type="button" class="emoji-option" onclick="selectEmoji('${containerId}', '${emoji}')">${emoji}</button>
            `).join('')}
        </div>
    `;
}

function toggleEmojiPicker(type) {
    const pickerId = `emoji-picker-${type}`;
    const picker = document.getElementById(pickerId);

    // Close any other open picker
    if (activeEmojiPicker && activeEmojiPicker !== picker) {
        activeEmojiPicker.classList.remove('open');
    }

    // Render if empty
    if (!picker.innerHTML) {
        renderEmojiPicker(pickerId);
    }

    picker.classList.toggle('open');
    activeEmojiPicker = picker.classList.contains('open') ? picker : null;
}

function selectEmoji(pickerId, emoji) {
    const type = pickerId.replace('emoji-picker-', '');
    const btn = document.getElementById(`${type}-domain-icon-btn`);
    btn.textContent = emoji;

    if (type === 'edit') {
        document.getElementById('edit-domain-icon').value = emoji;
    }

    // Close picker
    document.getElementById(pickerId).classList.remove('open');
    activeEmojiPicker = null;
}

// Close emoji picker on outside click
document.addEventListener('click', (e) => {
    if (activeEmojiPicker && !e.target.closest('.emoji-picker-wrap')) {
        activeEmojiPicker.classList.remove('open');
        activeEmojiPicker = null;
    }
});

// Google Calendar expandable section
function toggleGcalSection() {
    const expand = document.getElementById('gcal-expand');
    const chevron = document.getElementById('gcal-chevron');
    if (!expand) return;
    const wasOpen = expand.classList.contains('open');
    expand.classList.toggle('open');
    if (chevron) chevron.classList.toggle('expanded');
    // First open: ensure HTMX processes toggle elements that were hidden at page load
    if (!wasOpen && typeof htmx !== 'undefined') {
        htmx.process(expand);
    }
}

// Todoist expandable section
function toggleTodoistSection() {
    const expand = document.getElementById('todoist-expand');
    const chevron = document.getElementById('todoist-chevron');
    if (!expand) return;

    expand.classList.toggle('open');
    if (chevron) chevron.classList.toggle('expanded');
}

// Calendar visibility toggle via fetch (replaces HTMX)
async function toggleCalendarVisibility(calendarId, row) {
    const toggle = row.querySelector('.toggle-switch');
    if (!toggle) return;
    try {
        const res = await fetch(`/api/v1/calendars/${encodeURIComponent(calendarId)}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });
        if (res.ok) {
            toggle.classList.toggle('enabled');
        }
    } catch (e) {
        console.error('Calendar toggle failed:', e);
    }
}

// Disconnect Todoist
async function disconnectTodoist() {
    if (!confirm('Disconnect Todoist? You can reconnect later, but will need to re-import.')) {
        return;
    }

    try {
        const response = await fetch('/auth/todoist/disconnect', {
            method: 'POST',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to disconnect Todoist');
        }
    } catch (e) {
        alert('Failed to disconnect Todoist');
    }
}

// Domain CRUD
async function addDomain() {
    const input = document.getElementById('new-domain-name');
    const iconBtn = document.getElementById('new-domain-icon-btn');
    const name = input.value.trim();
    const icon = iconBtn.textContent.trim();
    if (!name) return;

    try {
        // Encrypt domain name if encryption is enabled
        const encryptedName = await Crypto.encryptField(name);

        const response = await fetch('/api/v1/domains', {
            method: 'POST',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ name: encryptedName, icon: icon || null }),
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to create domain');
        }
    } catch (e) {
        alert('Failed to create domain');
    }
}

async function editDomain(btn) {
    const id = btn.dataset.domainId;
    let name = btn.dataset.domainName;
    const icon = btn.dataset.domainIcon;

    // Decrypt name if encryption is enabled
    if (Crypto.canCrypto()) {
        name = await Crypto.decryptField(name);
    }

    document.getElementById('edit-domain-id').value = id;
    document.getElementById('edit-domain-name').value = name;
    document.getElementById('edit-domain-icon').value = icon || 'üìÅ';
    document.getElementById('edit-domain-icon-btn').textContent = icon || 'üìÅ';
    document.getElementById('domain-edit-overlay').classList.add('open');
    document.getElementById('edit-domain-name').focus();
}

function closeDomainEdit() {
    document.getElementById('domain-edit-overlay').classList.remove('open');
    // Close any open emoji picker
    const picker = document.getElementById('emoji-picker-edit');
    if (picker) picker.classList.remove('open');
    activeEmojiPicker = null;
}

async function saveDomainEdit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-domain-id').value;
    const name = document.getElementById('edit-domain-name').value.trim();
    const icon = document.getElementById('edit-domain-icon').value.trim();

    if (!name) return;

    try {
        // Encrypt domain name if encryption is enabled
        const encryptedName = await Crypto.encryptField(name);

        const response = await fetch(`/api/v1/domains/${id}`, {
            method: 'PUT',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ name: encryptedName, icon: icon || null }),
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to update domain');
        }
    } catch (e) {
        alert('Failed to update domain');
    }
}

async function deleteDomain(id) {
    if (!confirm('Delete this domain? Tasks will be moved to Unsorted.')) return;

    try {
        const response = await fetch(`/api/v1/domains/${id}`, {
            method: 'DELETE',
            headers: window.getCSRFHeaders(),
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to delete domain');
        }
    } catch (e) {
        alert('Failed to delete domain');
    }
}

// Enter key to add domain
document.getElementById('new-domain-name').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addDomain();
    }
});

// Escape to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDomainEdit();
});

// Todoist Import - Preview-based flow
let importPreviewData = null;

async function importFromTodoist() {
    const btn = document.getElementById('btn-import-todoist');
    const status = document.getElementById('import-status');

    btn.disabled = true;
    btn.textContent = 'Loading preview...';
    status.style.display = 'none';

    try {
        // First, fetch preview
        const previewResponse = await fetch('/api/v1/import/todoist/preview');
        const preview = await previewResponse.json();

        if (!previewResponse.ok) {
            throw new Error(preview.detail || 'Failed to load preview');
        }

        importPreviewData = preview;

        // Show preview dialog
        showImportPreview(preview);
    } catch (e) {
        status.textContent = '‚ùå ' + (e.message || 'Failed to load preview');
        status.style.display = 'block';
        status.className = 'expand-status error';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Import from Todoist';
    }
}

function showImportPreview(preview) {
    const status = document.getElementById('import-status');

    // Build preview HTML - show ALL projects
    let projectsList = '';
    if (preview.projects.length > 0) {
        projectsList = preview.projects.map(p =>
            `<span class="preview-project">${p.name} (${p.task_count})</span>`
        ).join('');
    }

    const html = `
        <div class="import-preview">
            <div class="preview-header">Ready to Import</div>
            <div class="preview-stats">
                <div class="preview-stat">
                    <span class="stat-value">${preview.projects_count}</span>
                    <span class="stat-label">Projects</span>
                </div>
                <div class="preview-stat">
                    <span class="stat-value">${preview.tasks_count}</span>
                    <span class="stat-label">Tasks</span>
                </div>
                <div class="preview-stat">
                    <span class="stat-value">${preview.subtasks_count}</span>
                    <span class="stat-label">Subtasks</span>
                </div>
                <div class="preview-stat">
                    <span class="stat-value">${preview.completed_count}</span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>
            ${projectsList ? `<div class="preview-projects">${projectsList}</div>` : ''}
            <div class="preview-options">
                <label class="preview-option">
                    <input type="checkbox" id="import-completed" checked>
                    <span>Import completed tasks (for analytics)</span>
                </label>
            </div>
            <div class="preview-note">
                Subtasks will be flattened to tasks using "Parent ‚Üí Subtask" name pattern
            </div>
            <div class="preview-actions">
                <button type="button" class="btn-sm btn-sm--ghost" onclick="cancelImportPreview()">Cancel</button>
                <button type="button" class="btn-sm btn-sm--primary" onclick="executeImport()">Import Now</button>
            </div>
        </div>
    `;

    status.innerHTML = html;
    status.style.display = 'block';
    status.className = 'expand-status preview';
}

function cancelImportPreview() {
    const status = document.getElementById('import-status');
    status.style.display = 'none';
    importPreviewData = null;
}

async function executeImport() {
    const btn = document.getElementById('btn-import-todoist');
    const status = document.getElementById('import-status');
    const includeCompleted = document.getElementById('import-completed')?.checked ?? true;

    // Show loading state
    status.innerHTML = '<div class="import-loading">Importing...</div>';
    btn.disabled = true;

    try {
        const response = await fetch('/api/v1/import/todoist', {
            method: 'POST',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({
                include_completed: includeCompleted,
                skip_existing: true,
            }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Build detailed import summary
            const lines = [];

            // Main import line
            lines.push(`‚úì Imported ${data.tasks_created} tasks, ${data.domains_created} domains`);

            // Completed tasks imported
            if (data.tasks_completed > 0) {
                lines.push(`‚Ü≥ ${data.tasks_completed} completed tasks (for analytics)`);
            }

            // Parent tasks with children
            if (data.parent_tasks_imported > 0) {
                lines.push(`‚Ü≥ ${data.parent_tasks_imported} parent tasks with subtasks`);
            }

            // Duplicates skipped
            const dupes = data.tasks_skipped + data.domains_skipped;
            if (dupes > 0) {
                lines.push(`‚äò ${dupes} already imported (skipped)`);
            }

            // Tasks needing clarity assignment
            if (data.tasks_need_clarity > 0) {
                lines.push(`‚ö† ${data.tasks_need_clarity} tasks need clarity ‚Äî use "Assign Clarity" below`);
            }

            status.innerHTML = lines.join('<br>');
            status.className = 'expand-status success';

            // E2E Encryption: Encrypt imported tasks if encryption is enabled
            // The imported tasks are stored as plaintext - encrypt using batch update
            if (Crypto.canCrypto() && (data.tasks_created > 0 || data.domains_created > 0)) {
                status.innerHTML += '<br>üîê Encrypting imported data...';
                try {
                    // Fetch all content (including newly imported)
                    const contentResponse = await fetch('/api/v1/tasks/all-content');
                    if (!contentResponse.ok) {
                        throw new Error('Failed to fetch content for encryption');
                    }
                    const allContent = await contentResponse.json();
                    const encrypted = await Crypto.encryptAllData(allContent.tasks, allContent.domains);

                    let encryptErrors = [];

                    // Update tasks
                    if (encrypted.tasks.length > 0) {
                        const taskResp = await fetch('/api/v1/tasks/batch-update', {
                            method: 'POST',
                            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify({ tasks: encrypted.tasks }),
                        });
                        if (!taskResp.ok) {
                            const err = await taskResp.json().catch(() => ({}));
                            encryptErrors.push(`Tasks: ${err.detail || 'update failed'}`);
                        }
                    }

                    // Update domains
                    if (encrypted.domains.length > 0) {
                        const domainResp = await fetch('/api/v1/domains/batch-update', {
                            method: 'POST',
                            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify({ domains: encrypted.domains }),
                        });
                        if (!domainResp.ok) {
                            const err = await domainResp.json().catch(() => ({}));
                            encryptErrors.push(`Domains: ${err.detail || 'update failed'}`);
                        }
                    }

                    if (encryptErrors.length > 0) {
                        console.error('Encryption errors:', encryptErrors);
                        status.innerHTML += '<br>‚ö† Encryption incomplete: ' + encryptErrors.join(', ');
                    } else {
                        status.innerHTML += '<br>‚úì Data encrypted';
                    }
                } catch (e) {
                    console.error('Failed to encrypt imported data:', e);
                    status.innerHTML += '<br>‚ö† Encryption failed: ' + (e.message || 'unknown error');
                }
            }
        } else {
            const errorMsg = data.errors?.join(', ') || data.detail || 'Import failed';
            status.textContent = '‚ùå ' + errorMsg;
            status.className = 'expand-status error';
        }
    } catch (e) {
        status.textContent = '‚ùå Failed to connect to server';
        status.className = 'expand-status error';
    } finally {
        btn.disabled = false;
        importPreviewData = null;
    }
}

async function wipeAllData() {
    // Require typed confirmation
    const confirmText = prompt('This will permanently delete ALL your tasks and domains.\n\nType "DELETE" to confirm:');
    if (confirmText !== 'DELETE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        return;
    }

    const btn = document.getElementById('btn-wipe-data');
    btn.disabled = true;
    btn.textContent = 'Wiping...';

    try {
        const response = await fetch('/api/v1/import/wipe', {
            method: 'POST',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
            alert(`Deleted ${data.tasks_deleted} tasks and ${data.domains_deleted} domains.`);
            window.location.reload();
        } else {
            alert(data.detail || 'Wipe failed');
        }
    } catch (e) {
        alert('Failed to connect to server');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Wipe All Data';
    }
}

// Backup functions
async function exportBackup() {
    const btn = document.getElementById('btn-export-backup');
    const statusWrap = document.getElementById('backup-status-wrap');
    const status = document.getElementById('backup-status');
    btn.disabled = true;
    btn.textContent = 'Exporting...';
    statusWrap.style.display = 'none';

    try {
        const response = await fetch('/api/v1/backup/export');

        if (!response.ok) {
            throw new Error('Export failed');
        }

        // Get filename from Content-Disposition header
        const disposition = response.headers.get('Content-Disposition');
        const filenameMatch = disposition && disposition.match(/filename="(.+)"/);
        const filename = filenameMatch ? filenameMatch[1] : 'whendoist_backup.json';

        // Download the file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        status.textContent = '‚úÖ Backup downloaded successfully';
        status.className = 'expand-status success';
        statusWrap.style.display = 'block';
    } catch (e) {
        status.textContent = '‚ùå Export failed: ' + e.message;
        status.className = 'expand-status error';
        statusWrap.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Download Backup';
    }
}

async function importBackup(input) {
    const file = input.files[0];
    if (!file) return;

    // Confirm before importing
    const confirmText = prompt('This will REPLACE all your current data with the backup.\n\nType "RESTORE" to confirm:');
    if (confirmText !== 'RESTORE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        input.value = '';
        return;
    }

    const btn = document.getElementById('btn-import-backup');
    const statusWrap = document.getElementById('backup-status-wrap');
    const status = document.getElementById('backup-status');
    btn.disabled = true;
    btn.textContent = 'Restoring...';
    statusWrap.style.display = 'none';

    try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/v1/backup/import', {
            method: 'POST',
            headers: window.getCSRFHeaders(),
            body: formData,
        });

        const data = await response.json();

        if (response.ok && data.success) {
            status.textContent = `‚úÖ Restored: ${data.domains} domains, ${data.tasks} tasks`;
            status.className = 'expand-status success';
            statusWrap.style.display = 'block';
            setTimeout(() => window.location.reload(), 1500);
        } else {
            // API returned an error response
            const errorMsg = data.detail || data.message || 'Import failed';
            throw new Error(errorMsg);
        }
    } catch (e) {
        // If response wasn't JSON, e.message will contain the parse error
        // but we want to show a more helpful message
        let errorMessage = e.message;
        if (e.message.includes('Unexpected token')) {
            errorMessage = 'Server error - check logs for details';
        }
        status.textContent = '‚ùå Restore failed: ' + errorMessage;
        status.className = 'expand-status error';
        statusWrap.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Restore Backup';
        input.value = '';
    }
}

// Show tasks needing clarity assignment
async function showUnclearTasks() {
    const container = document.getElementById('unclear-tasks-container');
    const btn = document.getElementById('btn-show-unclear');

    // Toggle visibility
    if (container.classList.contains('visible')) {
        container.classList.remove('visible');
        btn.textContent = 'Assign Clarity';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Loading...';

    try {
        const response = await fetch('/api/v1/tasks?clarity=none');
        const tasks = await response.json();

        if (tasks.length === 0) {
            container.innerHTML = '<div class="unclear-empty">All tasks have clarity assigned. Energy filtering is fully available.</div>';
        } else {
            container.innerHTML = `
                <div class="unclear-tasks__hd">
                    ${tasks.length} task${tasks.length === 1 ? '' : 's'} need clarity
                    <span class="unclear-hint">Assign clarity to enable energy-based filtering</span>
                </div>
                ${tasks.map(task => `
                    <div class="unclear-task-row" data-task-id="${task.id}">
                        <span class="unclear-task-title">${escapeHtml(task.title)}</span>
                        <div class="clarity-btns">
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'executable')" title="Clear next action, can do when tired">Exec</button>
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'defined')" title="Know what to do, needs some focus">Def</button>
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'exploratory')" title="Needs research or deep thinking">Expl</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        container.classList.add('visible');
    } catch (e) {
        container.innerHTML = '<div class="unclear-empty">Failed to load tasks</div>';
        container.classList.add('visible');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Hide';
    }
}

async function setTaskClarity(taskId, clarity) {
    try {
        const response = await fetch(`/api/v1/tasks/${taskId}`, {
            method: 'PUT',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ clarity }),
        });

        if (response.ok) {
            const item = document.querySelector(`.unclear-task-row[data-task-id="${taskId}"]`);
            if (item) {
                item.remove();
                const container = document.getElementById('unclear-tasks-container');
                const remaining = container.querySelectorAll('.unclear-task-row').length;
                if (remaining === 0) {
                    container.innerHTML = '<div class="unclear-empty">All tasks have clarity assigned.</div>';
                } else {
                    const header = container.querySelector('.unclear-tasks__hd');
                    if (header) {
                        header.textContent = `${remaining} task${remaining === 1 ? '' : 's'} without clarity`;
                    }
                }
            }
        }
    } catch (e) {
        console.error('Failed to update task clarity:', e);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// Task Display Preferences
// ============================================================================

async function updatePreference(key, value) {
    try {
        const response = await fetch('/api/v1/preferences', {
            method: 'PUT',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ [key]: value }),
        });

        if (!response.ok) {
            console.error('Failed to update preference:', key);
        }
    } catch (e) {
        console.error('Failed to update preference:', e);
    }
}

// ============================================================================
// E2E Encryption
// ============================================================================

function showEncryptionSetup() {
    const wrap = document.getElementById('encryption-setup-wrap');
    const content = document.getElementById('encryption-setup-content');

    content.innerHTML = `
        <div class="expand-label">Set Up Encryption</div>
        <p class="expand-desc">
            Create a passphrase to encrypt your data. This passphrase is never sent to the server.
            <strong>Warning:</strong> If you forget your passphrase, your data cannot be recovered.
        </p>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
            <input type="password" id="encryption-passphrase" class="add-domain-input" placeholder="Enter passphrase (8+ characters)" style="width: 100%;" aria-label="Encryption passphrase">
            <input type="password" id="encryption-passphrase-confirm" class="add-domain-input" placeholder="Confirm passphrase" style="width: 100%;" aria-label="Confirm encryption passphrase">
        </div>
        <div class="expand-actions">
            <div class="expand-actions__left">
                <button type="button" class="btn-sm btn-sm--primary" onclick="setupEncryption()">Enable Encryption</button>
                <button type="button" class="btn-sm btn-sm--ghost" onclick="hideEncryptionSetup()">Cancel</button>
            </div>
        </div>
        <div id="encryption-setup-status" class="expand-status" style="display: none;"></div>
    `;

    wrap.style.display = 'block';
    document.getElementById('encryption-passphrase').focus();
}

function hideEncryptionSetup() {
    const wrap = document.getElementById('encryption-setup-wrap');
    wrap.style.display = 'none';
}

async function setupEncryption() {
    const passphrase = document.getElementById('encryption-passphrase').value;
    const confirm = document.getElementById('encryption-passphrase-confirm').value;
    const status = document.getElementById('encryption-setup-status');

    // Validate
    if (passphrase.length < 8) {
        status.textContent = 'Passphrase must be at least 8 characters';
        status.className = 'expand-status error';
        status.style.display = 'block';
        return;
    }

    if (passphrase !== confirm) {
        status.textContent = 'Passphrases do not match';
        status.className = 'expand-status error';
        status.style.display = 'block';
        return;
    }

    status.textContent = 'Setting up encryption...';
    status.className = 'expand-status';
    status.style.display = 'block';

    try {
        // Generate salt, derive key, create test value (v2 = 600k iterations)
        const { salt, testValue, version } = await Crypto.setupEncryption(passphrase);

        // Fetch all content to encrypt
        status.textContent = 'Fetching data to encrypt...';
        const contentResponse = await fetch('/api/v1/tasks/all-content');
        if (!contentResponse.ok) {
            throw new Error('Failed to fetch data');
        }
        const allContent = await contentResponse.json();

        // Encrypt all content
        status.textContent = `Encrypting ${allContent.tasks.length} tasks and ${allContent.domains.length} domains...`;
        const encrypted = await Crypto.encryptAllData(allContent.tasks, allContent.domains);

        // Save encrypted data to server
        status.textContent = 'Saving encrypted data...';

        // Batch update tasks
        if (encrypted.tasks.length > 0) {
            const taskResponse = await fetch('/api/v1/tasks/batch-update', {
                method: 'POST',
                headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ tasks: encrypted.tasks }),
            });
            if (!taskResponse.ok) {
                throw new Error('Failed to save encrypted tasks');
            }
        }

        // Batch update domains
        if (encrypted.domains.length > 0) {
            const domainResponse = await fetch('/api/v1/domains/batch-update', {
                method: 'POST',
                headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ domains: encrypted.domains }),
            });
            if (!domainResponse.ok) {
                throw new Error('Failed to save encrypted domains');
            }
        }

        // Enable encryption on server
        const response = await fetch('/api/v1/preferences/encryption/setup', {
            method: 'POST',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify({ salt, test_value: testValue, version }),
        });

        if (response.ok) {
            status.textContent = 'Encryption complete! Refreshing page...';
            status.className = 'expand-status success';
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to enable encryption');
        }
    } catch (e) {
        status.textContent = 'Error: ' + e.message;
        status.className = 'expand-status error';
    }
}

async function disableEncryption() {
    // Verify we have the key to decrypt
    if (!Crypto.hasStoredKey()) {
        alert('Please unlock your data first before disabling encryption.');
        return;
    }

    const confirmText = prompt(
        'Disabling encryption will:\n' +
        '1. Decrypt all your tasks and domains\n' +
        '2. Store them as plaintext on the server\n\n' +
        'Type "DISABLE" to confirm:'
    );

    if (confirmText !== 'DISABLE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        return;
    }

    try {
        // Fetch all encrypted content
        const contentResponse = await fetch('/api/v1/tasks/all-content');
        if (!contentResponse.ok) {
            throw new Error('Failed to fetch data');
        }
        const allContent = await contentResponse.json();

        // Decrypt all content
        const decrypted = await Crypto.decryptAllData(allContent.tasks, allContent.domains);

        // Save decrypted data to server
        if (decrypted.tasks.length > 0) {
            const taskResponse = await fetch('/api/v1/tasks/batch-update', {
                method: 'POST',
                headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ tasks: decrypted.tasks }),
            });
            if (!taskResponse.ok) {
                throw new Error('Failed to save decrypted tasks');
            }
        }

        if (decrypted.domains.length > 0) {
            const domainResponse = await fetch('/api/v1/domains/batch-update', {
                method: 'POST',
                headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
                body: JSON.stringify({ domains: decrypted.domains }),
            });
            if (!domainResponse.ok) {
                throw new Error('Failed to save decrypted domains');
            }
        }

        // Disable encryption on server
        const response = await fetch('/api/v1/preferences/encryption/disable', {
            method: 'POST',
            headers: window.getCSRFHeaders({ 'Content-Type': 'application/json' }),
        });

        if (response.ok) {
            Crypto.clearStoredKey();
            alert('Encryption disabled. Your data is now stored as plaintext.');
            window.location.reload();
        } else {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to disable encryption');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============================================================================
// Lock Status Management
// ============================================================================

function updateLockStatus() {
    const unlockedEl = document.getElementById('lock-status-unlocked');
    const lockedEl = document.getElementById('lock-status-locked');
    const reauthBtn = document.getElementById('btn-reauth');

    if (!unlockedEl || !lockedEl) return;  // Not on encryption-enabled page

    const isUnlocked = Crypto.hasStoredKey();

    if (isUnlocked) {
        unlockedEl.style.display = 'inline';
        lockedEl.style.display = 'none';
        if (reauthBtn) reauthBtn.style.display = 'none';
    } else {
        unlockedEl.style.display = 'none';
        lockedEl.style.display = 'inline';
        if (reauthBtn) reauthBtn.style.display = 'inline-block';
    }
}

function showReauthenticate() {
    // Show the unlock modal from base.html
    const modal = document.getElementById('passphrase-modal');
    if (modal) {
        modal.style.display = 'flex';

        // Show passkey section if passkeys are registered
        const passkeySection = document.getElementById('passkey-unlock-section');
        if (passkeySection && window.WHENDOIST?.hasPasskeys) {
            passkeySection.style.display = 'block';
        }
    }
}

// Update lock status on page load
document.addEventListener('DOMContentLoaded', function() {
    if (window.WHENDOIST?.encryptionEnabled) {
        updateLockStatus();
    }
});

// ============================================================================
// Passkey Management
// ============================================================================

function showAddPasskeyForm() {
    const wrap = document.getElementById('add-passkey-wrap');
    wrap.style.display = 'block';
    document.getElementById('passkey-name').focus();
}

function hideAddPasskeyForm() {
    const wrap = document.getElementById('add-passkey-wrap');
    wrap.style.display = 'none';
    document.getElementById('passkey-name').value = '';
    document.getElementById('passkey-setup-status').style.display = 'none';
}

async function registerPasskey() {
    const nameInput = document.getElementById('passkey-name');
    const statusEl = document.getElementById('passkey-setup-status');
    const btn = document.getElementById('btn-register-passkey');

    const name = nameInput.value.trim();
    if (!name) {
        statusEl.className = 'expand-status error';
        statusEl.textContent = 'Please enter a name for this passkey';
        statusEl.style.display = 'block';
        return;
    }

    if (!Passkey.isSupported()) {
        statusEl.className = 'expand-status error';
        statusEl.textContent = 'Your browser does not support passkeys';
        statusEl.style.display = 'block';
        return;
    }

    // Show loading state
    btn.disabled = true;
    btn.textContent = 'Registering...';
    statusEl.className = 'expand-status';
    statusEl.textContent = 'Follow your browser\'s prompts to create a passkey...';
    statusEl.style.display = 'block';

    try {
        const result = await Passkey.registerPasskey(name);

        if (result.success) {
            statusEl.className = 'expand-status success';
            statusEl.textContent = 'Passkey registered successfully! Reloading...';
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            statusEl.className = 'expand-status error';
            statusEl.textContent = result.error || 'Failed to register passkey';
            btn.disabled = false;
            btn.textContent = 'Register Passkey';
        }
    } catch (e) {
        statusEl.className = 'expand-status error';
        statusEl.textContent = 'Error: ' + e.message;
        btn.disabled = false;
        btn.textContent = 'Register Passkey';
    }
}

async function deletePasskey(passkeyId, passkeyName) {
    const confirmDelete = confirm(`Remove passkey "${passkeyName}"?\n\nYou can still unlock with your passphrase or other passkeys.`);

    if (!confirmDelete) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/passkeys/${passkeyId}`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: window.getCSRFHeaders(),
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Failed to delete passkey: ' + (error.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============================================================================
// Wizard
// ============================================================================

async function rerunWizard() {
    if (!confirm('Re-run the setup wizard?\n\nThis will reset your wizard status and show the setup wizard again.')) {
        return;
    }

    try {
        const response = await fetch('/api/v1/wizard/reset', {
            method: 'POST',
            credentials: 'same-origin',
            headers: window.getCSRFHeaders(),
        });

        if (response.ok) {
            // Redirect to dashboard to show wizard
            window.location.href = '/dashboard';
        } else {
            const error = await response.json();
            alert('Failed to reset wizard: ' + (error.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============================================================================
// Build Info
// ============================================================================

async function loadBuildInfo() {
    try {
        const response = await fetch('/api/v1/build/info');
        if (response.ok) {
            const buildInfo = await response.json();
            const versionEl = document.getElementById('build-version');
            const commitEl = document.getElementById('build-commit');
            if (versionEl) versionEl.textContent = `Whendoist ${buildInfo.version}`;
            if (commitEl) commitEl.textContent = (buildInfo.commit || {}).short || '';
        }
    } catch (e) {
        console.error('Failed to load build info:', e);
    }
}

document.addEventListener('DOMContentLoaded', loadBuildInfo);

// ============================================================================
// Theme Toggle
// ============================================================================

function setTheme(preference) {
    if (typeof Theme !== 'undefined') {
        Theme.setPreference(preference);
        updateThemeToggleUI();
    }
}

function updateThemeToggleUI() {
    if (typeof Theme === 'undefined') return;

    const preference = Theme.getPreference();
    const buttons = document.querySelectorAll('.theme-btn');

    buttons.forEach(btn => {
        const btnTheme = btn.dataset.theme;
        if (btnTheme === preference) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

// Initialize theme toggle UI on page load
document.addEventListener('DOMContentLoaded', updateThemeToggleUI);

// Decrypt domain names on page load
(async function decryptDomainNames() {
    if (!Crypto.canCrypto()) return;

    /**
     * Check if a value looks like encrypted data (base64 with min length).
     * AES-256-GCM: 12 bytes IV + ciphertext + 16 bytes tag = min 28 bytes = ~38 base64 chars
     */
    function looksEncrypted(value) {
        if (!value || value.length < 38) return false;
        return /^[A-Za-z0-9+/]+=*$/.test(value);
    }

    const domainRows = document.querySelectorAll('#domain-list [data-domain-name]');
    for (const row of domainRows) {
        const name = row.dataset.domainName;
        if (!name) continue;

        try {
            // If it doesn't look encrypted, use as-is (plaintext)
            const displayName = looksEncrypted(name)
                ? await Crypto.decryptField(name)
                : name;

            if (!displayName) continue;

            // Update the displayed name
            const nameEl = row.querySelector('.domain-name');
            if (nameEl) {
                nameEl.textContent = displayName;
                nameEl.title = displayName;
            }
        } catch (e) {
            // On error, display original value (it's likely plaintext)
            console.error('Failed to decrypt domain name:', e);
            const nameEl = row.querySelector('.domain-name');
            if (nameEl) {
                nameEl.textContent = name;
                nameEl.title = name;
            }
        }
    }
})();

// =============================================================================
// Google Calendar Sync
// =============================================================================

async function toggleGcalSync(btn) {
    const isEnabled = btn.classList.contains('enabled');

    if (isEnabled) {
        // Disable sync
        if (!confirm('Disable Google Calendar sync? You can choose to keep or delete synced events.')) {
            return;
        }
        const deleteEvents = confirm('Delete all synced events from Google Calendar?\n\nClick OK to delete, Cancel to keep them.');
        try {
            const res = await fetch('/api/v1/gcal-sync/disable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({ delete_events: deleteEvents })
            });
            if (res.ok) {
                location.reload();
            } else {
                alert('Failed to disable sync. Please try again.');
                location.reload();
            }
        } catch (e) {
            console.error('Failed to disable sync:', e);
            alert('Failed to disable sync. Please try again.');
            location.reload();
        }
    } else {
        // Enable sync
        btn.disabled = true;
        btn.style.opacity = '0.5';
        try {
            const res = await fetch('/api/v1/gcal-sync/enable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            });
            const data = await res.json();
            if (data.needs_reauth) {
                // Redirect to Google OAuth with write scope
                window.location.href = data.reauth_url;
                return;
            }
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to enable sync.');
                location.reload();
            }
        } catch (e) {
            console.error('Failed to enable sync:', e);
            alert('Failed to enable sync. Please try again.');
            btn.disabled = false;
            btn.style.opacity = '';
        }
    }
}

async function toggleGcalSyncAllDay(btn) {
    const newValue = !btn.classList.contains('enabled');
    try {
        const res = await fetch('/api/v1/preferences', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({ gcal_sync_all_day: newValue })
        });
        if (res.ok) {
            btn.classList.toggle('enabled', newValue);
            // Trigger re-sync to apply the change (ignore errors ‚Äî sync may be disabled)
            fetch('/api/v1/gcal-sync/full-sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            }).catch(() => {});
        }
    } catch (e) {
        console.error('Failed to update all-day preference:', e);
    }
}

async function resyncAllTasks() {
    const btn = document.getElementById('btn-resync');
    btn.disabled = true;
    btn.textContent = 'Syncing...';
    try {
        const res = await fetch('/api/v1/gcal-sync/full-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });
        const data = await res.json();
        if (data.success) {
            // Poll status until sync finishes
            _pollSyncStatus(btn);
        } else {
            btn.textContent = 'Failed';
            setTimeout(() => { btn.textContent = 'Re-sync'; btn.disabled = false; }, 2000);
        }
    } catch (e) {
        console.error('Re-sync failed:', e);
        btn.textContent = 'Failed';
        setTimeout(() => { btn.textContent = 'Re-sync'; btn.disabled = false; }, 2000);
    }
}

function _pollSyncStatus(btn) {
    const poll = setInterval(async () => {
        try {
            const res = await fetch('/api/v1/gcal-sync/status');
            const data = await res.json();
            btn.textContent = `Syncing... (${data.synced_count} events)`;
            if (!data.syncing) {
                clearInterval(poll);
                if (data.sync_error) {
                    location.reload();
                } else {
                    btn.textContent = `Done (${data.synced_count} events)`;
                    setTimeout(() => { btn.textContent = 'Re-sync'; btn.disabled = false; }, 3000);
                }
            }
        } catch {
            clearInterval(poll);
            btn.textContent = 'Re-sync';
            btn.disabled = false;
        }
    }, 3000);
}

// On page load: if sync is running, show progress on re-sync button
(async function checkSyncOnLoad() {
    const btn = document.getElementById('btn-resync');
    if (!btn) return;
    try {
        const res = await fetch('/api/v1/gcal-sync/status');
        const data = await res.json();
        if (data.syncing) {
            btn.disabled = true;
            btn.textContent = `Syncing... (${data.synced_count} events)`;
            _pollSyncStatus(btn);
        }
    } catch { /* ignore */ }
})();
</script>
{% endblock %}
