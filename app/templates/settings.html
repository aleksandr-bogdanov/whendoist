{% extends "base.html" %}

{% block title %}Settings - Whendoist{% endblock %}

{% block extra_css %}
<style>
/* =============================================================================
   Settings v0.6 - Final polish
   User-defined labels preserved, aligned controls, proper integrations
   ============================================================================= */

/* 1) Page wrapper */
.settings-page {
    min-height: calc(100vh - 80px);
    padding: 0 24px 24px;
    display: flex;
    justify-content: center;
}

/* 2) Page surface - shared container style */
.page-surface {
    width: 100%;
    max-width: 1100px;
    background: var(--grey-bg);
    border: 1px solid var(--border-hair);
    border-radius: 12px;
    padding: 32px 36px 44px;
    box-sizing: border-box;
}

/* 3) Page title - ALL CAPS */
.settings-title {
    margin: 0 0 28px 0;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    font-weight: 700;
    font-size: 1.5rem;
    line-height: 1;
    color: var(--text);
}

/* 4) Two-column grid */
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.settings-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 0;
    overflow: hidden;
}

/* =============================================================================
   Panel component
   ============================================================================= */

.settings-panel {
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    min-width: 0;
}

.settings-panel__hd {
    background: var(--grey-bg);
    border-bottom: 1px solid var(--border-hair);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
}

.panel-hd-left {
    flex: 1;
}

.panel-title {
    text-transform: uppercase;
    letter-spacing: 0.14em;
    font-weight: 700;
    font-size: 0.62rem;
    color: var(--text-muted);
    margin: 0 0 4px 0;
}

.panel-desc {
    font-size: 0.72rem;
    color: var(--text-faint);
    line-height: 1.4;
    margin: 0;
}

.panel-hd-right {
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.55rem;
    font-weight: 600;
    color: var(--text-faint);
    padding-top: 2px;
    flex-shrink: 0;
}

/* Disabled panel state */
.settings-panel--disabled .settings-panel__bd {
    opacity: 0.5;
    pointer-events: none;
}

.panel-disabled-notice {
    padding: 12px 16px;
    font-size: 0.75rem;
    color: var(--text-muted);
    background: rgba(15, 23, 42, 0.02);
    border-bottom: 1px solid var(--border-hair);
}

/* =============================================================================
   Unified Row component
   ============================================================================= */

.settings-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-hair);
    background: var(--light-bg);
    transition: background 0.1s ease;
    min-height: 44px;
    box-sizing: border-box;
}

.settings-row:last-child {
    border-bottom: none;
}

.settings-row:hover {
    background: var(--row-hover);
}

/* Right-aligned column for actions/toggles - fixed width for alignment */
.settings-row__right {
    margin-left: auto;
    min-width: 80px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

/* Row actions - hidden until hover */
.row-actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.12s ease;
    flex-shrink: 0;
}

.settings-row:hover .row-actions,
.settings-row:focus-within .row-actions {
    opacity: 1;
    pointer-events: auto;
}

/* Add row variant */
.settings-row--add {
    background: var(--grey-bg);
    border-bottom: none;
    gap: 8px;
}

.settings-row--add:hover {
    background: var(--grey-bg);
}

.settings-row--add .settings-row__right {
    min-width: 0;
}

/* Clickable row */
.settings-row--clickable {
    cursor: pointer;
}

/* =============================================================================
   Icon buttons
   ============================================================================= */

.icon-btn {
    all: unset;
    box-sizing: border-box;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    border: 1px solid var(--border-hair);
    background: rgba(255, 255, 255, 0.85);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.1s ease, border-color 0.1s ease, color 0.1s ease;
}

.icon-btn svg {
    display: block;
    flex-shrink: 0;
}

.icon-btn:hover {
    border-color: var(--border);
    background: var(--grey-bg);
    color: var(--text);
}

.icon-btn.edit:hover {
    border-color: rgba(109, 94, 246, 0.35);
    background: rgba(109, 94, 246, 0.08);
    color: var(--primary);
}

.icon-btn.delete:hover {
    border-color: rgba(220, 38, 38, 0.25);
    background: rgba(220, 38, 38, 0.06);
    color: var(--danger);
}

/* Chevron for expandable rows */
.row-chevron {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-faint);
    transition: transform 0.15s ease;
    flex-shrink: 0;
}

.row-chevron.expanded {
    transform: rotate(180deg);
}

/* =============================================================================
   Provider/Integration rows
   ============================================================================= */

.provider-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--grey-bg);
    border: 1px solid var(--border-hair);
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-muted);
    flex-shrink: 0;
}

.provider-info {
    flex: 1;
    min-width: 0;
}

.provider-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    line-height: 1.2;
}

.provider-status {
    font-size: 0.7rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 2px;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-faint);
    flex-shrink: 0;
}

.status-dot.connected {
    background: #16a34a;
}

/* Muted label for locked state */
.muted-label {
    font-size: 0.6rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-faint);
    white-space: nowrap;
}

/* =============================================================================
   Expandable section (for Todoist actions)
   ============================================================================= */

.expand-section {
    display: none;
    background: rgba(15, 23, 42, 0.02);
    border-bottom: 1px solid var(--border-hair);
}

.expand-section.open {
    display: block;
}

.expand-content {
    padding: 12px 16px 14px;
    min-width: 0;
    overflow: hidden;
}

.expand-label {
    font-size: 0.55rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    color: var(--text-faint);
    margin-bottom: 6px;
}

.expand-desc {
    font-size: 0.7rem;
    color: var(--text-faint);
    line-height: 1.45;
    margin-bottom: 10px;
}

.expand-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}

.expand-actions__left {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
}

.expand-status {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-hair);
}

.expand-status.success {
    color: #16a34a;
}

.expand-status.error {
    color: var(--danger);
}

.btn-text-danger {
    all: unset;
    box-sizing: border-box;
    font-size: 0.68rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--danger);
    cursor: pointer;
    transition: opacity 0.15s ease;
}

.btn-text-danger:hover {
    opacity: 0.7;
}

/* Ghost/secondary button variant */
.btn-sm--ghost {
    background: transparent;
    border: 1px solid var(--border-hair);
    color: var(--text-muted);
}

.btn-sm--ghost:hover {
    background: rgba(15, 23, 42, 0.04);
    border-color: var(--border);
    color: var(--text);
}

/* =============================================================================
   Calendar row
   ============================================================================= */

.calendar-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
}

.calendar-info {
    flex: 1;
    min-width: 0;
}

.calendar-name {
    font-size: 0.875rem;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}

.calendar-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 2px;
}

.calendar-badge {
    font-size: 0.55rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--grey-bg);
    color: var(--text-muted);
    padding: 2px 6px;
    border-radius: 3px;
    flex-shrink: 0;
}

/* Panel legend text */
.panel-legend {
    font-size: 0.68rem;
    color: var(--text-faint);
    font-style: italic;
    margin-top: 4px;
}

/* Calendar row - compact variant */
.settings-row--calendar {
    padding: 8px 16px;
    min-height: 36px;
}

.settings-row--calendar .calendar-name {
    font-size: 0.8125rem;
}

.settings-row--calendar .calendar-badge {
    font-size: 0.5rem;
}

/* Toggle switch */
.toggle-switch {
    all: unset;
    box-sizing: border-box;
    position: relative;
    display: inline-block;
    width: 32px;
    height: 18px;
    background: var(--border);
    border-radius: 9px;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
    vertical-align: middle;
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.15s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.12);
}

.toggle-switch.enabled {
    background: var(--primary);
}

.toggle-switch.enabled::after {
    transform: translateX(14px);
}

/* =============================================================================
   Domain row
   ============================================================================= */

.domain-icon {
    font-size: 1rem;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
}

.domain-name {
    flex: 1;
    font-size: 0.875rem;
    color: var(--text);
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Imported domain badge */
.domain-imported {
    font-size: 0.55rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-faint);
    flex-shrink: 0;
}

/* Emoji picker */
.emoji-picker-btn {
    all: unset;
    box-sizing: border-box;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid var(--border-hair);
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: border-color 0.15s, background 0.15s;
    flex-shrink: 0;
}

.emoji-picker-btn:hover {
    border-color: var(--border);
    background: var(--grey-bg);
}

.emoji-picker-btn:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(109, 94, 246, 0.12);
}

.emoji-picker-wrap {
    position: relative;
}

.emoji-picker-popover {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 4px;
    background: var(--light-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    box-shadow: var(--shadow-overlay);
    z-index: 100;
    display: none;
    width: 220px;
}

.emoji-picker-popover.open {
    display: block;
}

/* In modal, open downward */
.modal .emoji-picker-popover {
    bottom: auto;
    top: 100%;
    margin-bottom: 0;
    margin-top: 4px;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.emoji-option {
    all: unset;
    box-sizing: border-box;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s;
}

.emoji-option:hover {
    background: var(--grey-bg);
}

/* Add domain input row */
.settings-row--add {
    align-items: center;
}

input.add-domain-input,
input.add-domain-input[type="text"] {
    all: unset;
    box-sizing: border-box;
    flex: 1;
    height: 32px;
    padding: 0 10px;
    margin: 0;
    border: 1px solid var(--border-hair);
    border-radius: 6px;
    font-size: 0.8125rem;
    background: #fff;
    color: var(--text);
    line-height: 32px;
}

input.add-domain-input:focus,
input.add-domain-input[type="text"]:focus {
    outline: none;
    border-color: var(--border);
    box-shadow: 0 0 0 2px rgba(109, 94, 246, 0.12);
}

input.add-domain-input::placeholder {
    color: var(--text-faint);
}

/* =============================================================================
   Buttons
   ============================================================================= */

.btn-sm {
    all: unset;
    box-sizing: border-box;
    padding: 0 12px;
    margin: 0;
    border-radius: 5px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: all 0.15s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    height: 28px;
    line-height: 1;
}

.btn-sm--primary {
    background: var(--primary);
    color: #fff;
}

.btn-sm--primary:hover {
    background: var(--primary-hover);
}

.btn-sm--secondary {
    background: var(--grey-bg);
    border: 1px solid var(--border-hair);
    color: var(--text);
}

.btn-sm--secondary:hover {
    background: rgba(15, 23, 42, 0.06);
    border-color: var(--border);
}

.btn-sm:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* =============================================================================
   Maintenance panel (danger only)
   ============================================================================= */

.maintenance-content {
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.maintenance-info {
    flex: 1;
}

.maintenance-warning {
    font-size: 0.72rem;
    color: var(--danger);
    font-weight: 500;
    margin-bottom: 4px;
}

.maintenance-desc {
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.4;
}

.btn-sm--danger {
    background: rgba(220, 38, 38, 0.08);
    border: 1px solid rgba(220, 38, 38, 0.2);
    color: var(--danger);
    flex-shrink: 0;
}

.btn-sm--danger:hover {
    background: rgba(220, 38, 38, 0.14);
    border-color: rgba(220, 38, 38, 0.3);
}

/* =============================================================================
   Segmented Control
   ============================================================================= */

.segmented-control {
    display: flex;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
}

.segmented-btn {
    all: unset;
    box-sizing: border-box;
    padding: 5px 10px;
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--text-muted);
    background: var(--light-bg);
    cursor: pointer;
    border-right: 1px solid var(--border-hair);
    transition: background 0.1s, color 0.1s;
    white-space: nowrap;
}

.segmented-btn:last-child {
    border-right: none;
}

.segmented-btn:hover {
    background: var(--grey-bg);
}

.segmented-btn.active {
    background: var(--primary);
    color: #fff;
}

.segmented-btn.active:hover {
    background: var(--primary-hover);
}

/* Task Display row label */
.pref-label {
    flex: 1;
    font-size: 0.8125rem;
    color: var(--text);
    min-width: 0;
}

.backup-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.backup-info .pref-label {
    flex: none;
}

.pref-desc {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* =============================================================================
   Unclear tasks container
   ============================================================================= */

.unclear-tasks {
    border-top: 1px solid var(--border-hair);
    display: none;
    margin-top: 12px;
    max-height: 300px;
    overflow-y: auto;
}

.unclear-tasks.visible {
    display: block;
}

.unclear-tasks__hd {
    padding: 10px 0;
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    color: var(--text-muted);
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
}

.unclear-hint {
    font-weight: 500;
    text-transform: none;
    letter-spacing: 0.02em;
    color: var(--text-faint);
    font-size: 0.68rem;
}

.unclear-task-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 0;
    border-bottom: 1px solid var(--border-hair);
}

.unclear-task-row:last-child {
    border-bottom: none;
}

.unclear-task-title {
    flex: 1;
    min-width: 0;
    font-size: 0.8125rem;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.clarity-btns {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}

.clarity-btn {
    all: unset;
    box-sizing: border-box;
    padding: 4px 10px;
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    border: 1px solid var(--border-hair);
    border-radius: 4px;
    background: #fff;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
}

.clarity-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: rgba(109, 94, 246, 0.05);
}

.unclear-empty {
    padding: 16px 0;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8125rem;
}

/* =============================================================================
   Empty states
   ============================================================================= */

.empty-state {
    padding: 28px 16px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.8125rem;
}

/* =============================================================================
   Domain Edit Modal
   ============================================================================= */

.modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 200;
    justify-content: center;
    align-items: center;
}

.modal-overlay.open {
    display: flex;
}

.modal {
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
    width: 320px;
    box-shadow: var(--shadow-overlay);
}

.modal__title {
    margin: 0 0 16px;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text);
}

.modal__form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.modal__row {
    display: flex;
    gap: 8px;
}

.modal__row input {
    flex: 1;
    height: 38px;
    padding: 0 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--text);
}

.modal__row input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(109, 94, 246, 0.15);
}

.modal__row .icon-input {
    width: 54px;
    flex: none;
    text-align: center;
}

.modal__actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 8px;
}

/* =============================================================================
   Mobile responsive
   ============================================================================= */

@media (max-width: 900px) {
    .settings-page {
        padding: 16px;
    }

    .page-surface {
        padding: 24px;
    }

    .settings-title {
        font-size: 1.25rem;
        margin-bottom: 20px;
    }

    .settings-grid {
        grid-template-columns: 1fr;
    }

    /* Show actions always on mobile */
    .row-actions {
        opacity: 1;
        pointer-events: auto;
    }
}

@media (max-width: 600px) {
    .settings-page {
        padding: 12px;
    }

    .page-surface {
        padding: 16px;
        border-radius: 10px;
    }

    .settings-panel__hd {
        padding: 12px 14px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .panel-hd-right {
        align-self: flex-end;
    }

    .settings-row {
        padding: 12px 14px;
        min-height: 48px;
    }

    .settings-row__right {
        min-width: 60px;
    }

    .expand-content {
        padding: 14px;
    }

    .maintenance-content {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 14px;
    }

    .maintenance-info {
        text-align: center;
    }

    .btn-sm--danger {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="page-surface">
        <h1 class="settings-title">Settings</h1>

        <div class="settings-grid">
            <!-- LEFT COLUMN: Integrations + Calendars -->
            <div class="settings-column">

                <!-- INTEGRATIONS Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Integrations</p>
                            <p class="panel-desc">Connect external accounts used to sync tasks and events.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Google Calendar row -->
                        <div class="settings-row">
                            <div class="provider-icon">G</div>
                            <div class="provider-info">
                                <div class="provider-name">Google Calendar</div>
                                <div class="provider-status">
                                    <span class="status-dot {% if google_connected %}connected{% endif %}"></span>
                                    {% if google_connected %}Connected{% else %}Not connected{% endif %}
                                </div>
                            </div>
                            <div class="settings-row__right">
                                {% if google_connected %}
                                <span class="muted-label">Linked to login</span>
                                {% else %}
                                <a href="/auth/google" class="btn-sm btn-sm--primary">Connect</a>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Todoist row (expandable when connected) -->
                        {% if todoist_connected %}
                        <div class="settings-row settings-row--clickable" onclick="toggleTodoistSection()" id="todoist-row">
                            <div class="provider-icon">T</div>
                            <div class="provider-info">
                                <div class="provider-name">Todoist</div>
                                <div class="provider-status">
                                    <span class="status-dot connected"></span>
                                    Connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <div class="row-chevron" id="todoist-chevron">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <!-- Todoist expanded section -->
                        <div class="expand-section" id="todoist-expand">
                            <div class="expand-content">
                                <div class="expand-label">Todoist Integration</div>
                                <p class="expand-desc">
                                    Import projects and tasks from Todoist. Projects become domains; tasks keep due dates and priorities. After import, assign clarity levels to enable energy-based filtering.
                                </p>
                                <div class="expand-actions">
                                    <div class="expand-actions__left">
                                        <button type="button" class="btn-sm btn-sm--primary" id="btn-import-todoist" onclick="event.stopPropagation(); importFromTodoist()">
                                            Import from Todoist
                                        </button>
                                        <button type="button" class="btn-sm btn-sm--ghost" id="btn-show-unclear" onclick="event.stopPropagation(); showUnclearTasks()">
                                            Assign Clarity
                                        </button>
                                    </div>
                                    <button type="button" class="btn-text-danger" onclick="event.stopPropagation(); disconnectTodoist()">
                                        Disconnect
                                    </button>
                                </div>
                                <div id="import-status" class="expand-status" style="display: none;"></div>
                                <div id="unclear-tasks-container" class="unclear-tasks"></div>
                            </div>
                        </div>
                        {% else %}
                        <div class="settings-row">
                            <div class="provider-icon">T</div>
                            <div class="provider-info">
                                <div class="provider-name">Todoist</div>
                                <div class="provider-status">
                                    <span class="status-dot"></span>
                                    Not connected
                                </div>
                            </div>
                            <div class="settings-row__right">
                                <a href="/auth/todoist" class="btn-sm btn-sm--primary">Connect</a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- GOOGLE CALENDARS Panel -->
                <div class="settings-panel {% if not google_connected %}settings-panel--disabled{% endif %}">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Google Calendars</p>
                            <p class="panel-desc">Choose which calendars are visible in the day view. Hidden calendars won't block time.</p>
                        </div>
                        {% if google_connected and calendars %}
                        <span class="panel-hd-right">Toggle to show</span>
                        {% endif %}
                    </div>
                    <div class="settings-panel__bd">
                        {% if not google_connected %}
                        <div class="panel-disabled-notice">
                            Connect Google Calendar to choose calendars.
                        </div>
                        <div class="empty-state">‚Äî</div>
                        {% elif calendars %}
                            {% for cal in calendars %}
                            <div class="settings-row settings-row--clickable settings-row--calendar" onclick="toggleCalendar(this, '{{ cal.id }}')">
                                <div class="calendar-dot" style="background-color: {{ cal.background_color }};"></div>
                                <div class="calendar-info">
                                    <span class="calendar-name" title="{{ cal.summary }}">{{ cal.summary }}</span>
                                    {% if cal.primary %}
                                    <div class="calendar-meta">
                                        <span class="calendar-badge">Primary</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="settings-row__right">
                                    <button
                                        type="button"
                                        class="toggle-switch {% if cal.enabled %}enabled{% endif %}"
                                        data-calendar-id="{{ cal.id }}"
                                        onclick="event.stopPropagation()"
                                        hx-post="/api/calendars/{{ cal.id }}/toggle"
                                        hx-swap="none"
                                        hx-on::after-request="handleCalendarToggle(this)"
                                        aria-label="Toggle calendar"
                                    ></button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">No calendars found</div>
                        {% endif %}
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Domains + Maintenance -->
            <div class="settings-column">

                <!-- LIFE DOMAINS Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Life Domains</p>
                            <p class="panel-desc">Domains group tasks in Whendoist. They can be imported from Todoist projects or created manually.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd" id="domain-list">
                        {% if domains %}
                            {% for domain in domains|sort(attribute='name') %}
                            <div class="settings-row" data-domain-id="{{ domain.id }}">
                                <span class="domain-icon">{{ domain.icon or 'üìÅ' }}</span>
                                <span class="domain-name" title="{{ domain.name }}">{{ domain.name }}</span>
                                {% if domain.external_id %}
                                <span class="domain-imported">Imported</span>
                                {% endif %}
                                <div class="row-actions">
                                    <button type="button" class="icon-btn edit" onclick="editDomain({{ domain.id }}, '{{ domain.name|e }}', '{{ domain.icon or '' }}')" title="Edit">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="icon-btn delete" onclick="deleteDomain({{ domain.id }})" title="Delete">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <path d="M18 6L6 18M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state" id="domains-empty">No domains yet</div>
                        {% endif %}
                        <!-- Add domain row -->
                        <div class="settings-row settings-row--add">
                            <div class="emoji-picker-wrap">
                                <button type="button" class="emoji-picker-btn" id="new-domain-icon-btn" onclick="toggleEmojiPicker('new')">üìÅ</button>
                                <div class="emoji-picker-popover" id="emoji-picker-new"></div>
                            </div>
                            <input type="text" id="new-domain-name" class="add-domain-input" placeholder="Add new domain..." maxlength="100">
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" onclick="addDomain()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TASK DISPLAY Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Completed Tasks</p>
                            <p class="panel-desc">Control how completed tasks appear in the Task List.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Show completed in task list -->
                        <div class="settings-row">
                            <span class="pref-label">Show in Task List</span>
                            <div class="settings-row__right">
                                <button
                                    type="button"
                                    class="toggle-switch{% if user_prefs.show_completed_in_list %} enabled{% endif %}"
                                    onclick="togglePreference(this, 'show_completed_in_list')"
                                    aria-label="Toggle show in list"
                                ></button>
                            </div>
                        </div>

                        <!-- Retention window -->
                        <div class="settings-row">
                            <span class="pref-label">Keep visible for</span>
                            <div class="settings-row__right">
                                <div class="segmented-control" data-pref="completed_retention_days">
                                    <button type="button" class="segmented-btn{% if user_prefs.completed_retention_days == 1 %} active{% endif %}" data-value="1" onclick="setRetention(1)">1 day</button>
                                    <button type="button" class="segmented-btn{% if user_prefs.completed_retention_days == 3 %} active{% endif %}" data-value="3" onclick="setRetention(3)">3 days</button>
                                    <button type="button" class="segmented-btn{% if user_prefs.completed_retention_days == 7 %} active{% endif %}" data-value="7" onclick="setRetention(7)">7 days</button>
                                </div>
                            </div>
                        </div>

                        <!-- Move to bottom -->
                        <div class="settings-row">
                            <span class="pref-label">Position in Task List</span>
                            <div class="settings-row__right">
                                <div class="segmented-control" data-pref="completed_move_to_bottom">
                                    <button type="button" class="segmented-btn{% if user_prefs.completed_move_to_bottom %} active{% endif %}" data-value="true" onclick="setPlacement(true)">Move to bottom</button>
                                    <button type="button" class="segmented-btn{% if not user_prefs.completed_move_to_bottom %} active{% endif %}" data-value="false" onclick="setPlacement(false)">Keep in place</button>
                                </div>
                            </div>
                        </div>

                        <!-- Hide recurring after completion -->
                        <div class="settings-row">
                            <span class="pref-label">Hide recurring after completing today</span>
                            <div class="settings-row__right">
                                <button
                                    type="button"
                                    class="toggle-switch{% if user_prefs.hide_recurring_after_completion %} enabled{% endif %}"
                                    onclick="togglePreference(this, 'hide_recurring_after_completion')"
                                    aria-label="Toggle hide recurring"
                                ></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BACKUP Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Backup</p>
                            <p class="panel-desc">Export and restore your data as JSON.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <!-- Export -->
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Export Data</span>
                                <span class="pref-desc">Download all tasks, domains, and settings as JSON</span>
                            </div>
                            <div class="settings-row__right">
                                <button type="button" class="btn-sm btn-sm--primary" id="btn-export-backup" onclick="exportBackup()">
                                    Download Backup
                                </button>
                            </div>
                        </div>
                        <!-- Import -->
                        <div class="settings-row">
                            <div class="backup-info">
                                <span class="pref-label">Import Data</span>
                                <span class="pref-desc">Restore from a backup file (replaces current data)</span>
                            </div>
                            <div class="settings-row__right">
                                <input type="file" id="backup-file-input" accept=".json" style="display: none;" onchange="importBackup(this)">
                                <button type="button" class="btn-sm btn-sm--ghost" id="btn-import-backup" onclick="document.getElementById('backup-file-input').click()">
                                    Restore Backup
                                </button>
                            </div>
                        </div>
                        <div id="backup-status-wrap" class="expand-content" style="display: none; padding-top: 0;">
                            <div id="backup-status" class="expand-status" style="margin-top: 0;"></div>
                        </div>
                    </div>
                </div>

                <!-- MAINTENANCE Panel -->
                <div class="settings-panel">
                    <div class="settings-panel__hd">
                        <div class="panel-hd-left">
                            <p class="panel-title">Maintenance</p>
                            <p class="panel-desc">Delete local Whendoist data. This cannot be undone.</p>
                        </div>
                    </div>
                    <div class="settings-panel__bd">
                        <div class="maintenance-content">
                            <div class="maintenance-info">
                                <div class="maintenance-warning">Danger Zone</div>
                                <div class="maintenance-desc">Permanently delete all tasks and domains from Whendoist.</div>
                            </div>
                            <button type="button" class="btn-sm btn-sm--danger" id="btn-wipe-data" onclick="wipeAllData()">
                                Wipe All Data
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Domain Edit Modal -->
<div class="modal-overlay" id="domain-edit-overlay" onclick="if(event.target === this) closeDomainEdit()">
    <div class="modal">
        <h3 class="modal__title">Edit Domain</h3>
        <form class="modal__form" onsubmit="saveDomainEdit(event)">
            <input type="hidden" id="edit-domain-id">
            <input type="hidden" id="edit-domain-icon">
            <div class="modal__row">
                <div class="emoji-picker-wrap">
                    <button type="button" class="emoji-picker-btn" id="edit-domain-icon-btn" onclick="toggleEmojiPicker('edit')">üìÅ</button>
                    <div class="emoji-picker-popover" id="emoji-picker-edit"></div>
                </div>
                <input type="text" id="edit-domain-name" placeholder="Domain name" required maxlength="100">
            </div>
            <div class="modal__actions">
                <button type="button" class="btn-sm btn-sm--secondary" onclick="closeDomainEdit()">Cancel</button>
                <button type="submit" class="btn-sm btn-sm--primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
// Emoji picker
const DOMAIN_EMOJIS = [
    'üìÅ', 'üíº', 'üè†', 'üë§', 'üë•', 'üí™', 'üßò',
    'üìö', 'üéì', 'üíª', 'üé®', 'üéµ', 'üéÆ', 'üì∑',
    '‚úàÔ∏è', 'üöó', 'üèÉ', '‚öΩ', 'üéØ', 'üí∞', 'üìà',
    '‚ù§Ô∏è', 'üåü', 'üî•', '‚ú®', 'üéâ', 'üéÅ', 'üèÜ',
    'üçé', 'ü•ó', '‚òï', 'üç≥', 'üõí', 'üè•', 'üíä',
    'üêï', 'üå±', 'üåç', '‚òÄÔ∏è', 'üåô', '‚ö°', 'üîß'
];

let activeEmojiPicker = null;

function renderEmojiPicker(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="emoji-grid">
            ${DOMAIN_EMOJIS.map(emoji => `
                <button type="button" class="emoji-option" onclick="selectEmoji('${containerId}', '${emoji}')">${emoji}</button>
            `).join('')}
        </div>
    `;
}

function toggleEmojiPicker(type) {
    const pickerId = `emoji-picker-${type}`;
    const picker = document.getElementById(pickerId);

    // Close any other open picker
    if (activeEmojiPicker && activeEmojiPicker !== picker) {
        activeEmojiPicker.classList.remove('open');
    }

    // Render if empty
    if (!picker.innerHTML) {
        renderEmojiPicker(pickerId);
    }

    picker.classList.toggle('open');
    activeEmojiPicker = picker.classList.contains('open') ? picker : null;
}

function selectEmoji(pickerId, emoji) {
    const type = pickerId.replace('emoji-picker-', '');
    const btn = document.getElementById(`${type}-domain-icon-btn`);
    btn.textContent = emoji;

    if (type === 'edit') {
        document.getElementById('edit-domain-icon').value = emoji;
    }

    // Close picker
    document.getElementById(pickerId).classList.remove('open');
    activeEmojiPicker = null;
}

// Close emoji picker on outside click
document.addEventListener('click', (e) => {
    if (activeEmojiPicker && !e.target.closest('.emoji-picker-wrap')) {
        activeEmojiPicker.classList.remove('open');
        activeEmojiPicker = null;
    }
});

// Todoist expandable section
function toggleTodoistSection() {
    const expand = document.getElementById('todoist-expand');
    const chevron = document.getElementById('todoist-chevron');
    if (!expand) return;

    expand.classList.toggle('open');
    if (chevron) chevron.classList.toggle('expanded');
}

// Calendar toggle via row click
function toggleCalendar(row, calendarId) {
    const toggle = row.querySelector('.toggle-switch');
    if (toggle) {
        toggle.click();
    }
}

// Handle calendar toggle response
function handleCalendarToggle(toggle) {
    toggle.classList.toggle('enabled');
}

// Disconnect Todoist
async function disconnectTodoist() {
    if (!confirm('Disconnect Todoist? You can reconnect later, but will need to re-import.')) {
        return;
    }

    try {
        const response = await fetch('/auth/todoist/disconnect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to disconnect Todoist');
        }
    } catch (e) {
        alert('Failed to disconnect Todoist');
    }
}

// Domain CRUD
async function addDomain() {
    const input = document.getElementById('new-domain-name');
    const iconBtn = document.getElementById('new-domain-icon-btn');
    const name = input.value.trim();
    const icon = iconBtn.textContent.trim();
    if (!name) return;

    try {
        const response = await fetch('/api/domains', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, icon: icon || null })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to create domain');
        }
    } catch (e) {
        alert('Failed to create domain');
    }
}

function editDomain(id, name, icon) {
    document.getElementById('edit-domain-id').value = id;
    document.getElementById('edit-domain-name').value = name;
    document.getElementById('edit-domain-icon').value = icon || 'üìÅ';
    document.getElementById('edit-domain-icon-btn').textContent = icon || 'üìÅ';
    document.getElementById('domain-edit-overlay').classList.add('open');
    document.getElementById('edit-domain-name').focus();
}

function closeDomainEdit() {
    document.getElementById('domain-edit-overlay').classList.remove('open');
    // Close any open emoji picker
    const picker = document.getElementById('emoji-picker-edit');
    if (picker) picker.classList.remove('open');
    activeEmojiPicker = null;
}

async function saveDomainEdit(e) {
    e.preventDefault();
    const id = document.getElementById('edit-domain-id').value;
    const name = document.getElementById('edit-domain-name').value.trim();
    const icon = document.getElementById('edit-domain-icon').value.trim();

    if (!name) return;

    try {
        const response = await fetch(`/api/domains/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, icon: icon || null })
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to update domain');
        }
    } catch (e) {
        alert('Failed to update domain');
    }
}

async function deleteDomain(id) {
    if (!confirm('Delete this domain? Tasks will be moved to Unsorted.')) return;

    try {
        const response = await fetch(`/api/domains/${id}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            window.location.reload();
        } else {
            const err = await response.json();
            alert(err.detail || 'Failed to delete domain');
        }
    } catch (e) {
        alert('Failed to delete domain');
    }
}

// Enter key to add domain
document.getElementById('new-domain-name').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addDomain();
    }
});

// Escape to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDomainEdit();
});

// Todoist Import
async function importFromTodoist() {
    const btn = document.getElementById('btn-import-todoist');
    const status = document.getElementById('import-status');

    btn.disabled = true;
    btn.textContent = 'Importing...';
    status.textContent = 'Connecting to Todoist...';
    status.style.display = 'block';
    status.className = 'expand-status';

    try {
        const response = await fetch('/api/import/todoist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Build detailed import summary
            const lines = [];

            // Main import line
            lines.push(`‚úì Imported ${data.tasks_created} tasks, ${data.domains_created} domains`);

            // Completed tasks imported
            if (data.tasks_completed > 0) {
                lines.push(`‚Ü≥ ${data.tasks_completed} completed tasks (for analytics)`);
            }

            // Parent tasks flattened (expected behavior)
            if (data.parents_flattened > 0) {
                lines.push(`‚Ü≥ ${data.parents_flattened} parent tasks merged into subtasks`);
            }

            // Duplicates skipped
            const dupes = data.tasks_skipped + data.domains_skipped;
            if (dupes > 0) {
                lines.push(`‚äò ${dupes} already imported (skipped)`);
            }

            // Tasks needing clarity assignment
            if (data.tasks_need_clarity > 0) {
                lines.push(`‚ö† ${data.tasks_need_clarity} tasks need clarity ‚Äî use "Assign Clarity" below`);
            }

            status.innerHTML = lines.join('<br>');
            status.className = 'expand-status success';
        } else {
            const errorMsg = data.errors?.join(', ') || data.detail || 'Import failed';
            status.textContent = errorMsg;
            status.className = 'expand-status error';
        }
    } catch (e) {
        status.textContent = 'Failed to connect to server';
        status.className = 'expand-status error';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Import from Todoist';
    }
}

async function wipeAllData() {
    // Require typed confirmation
    const confirmText = prompt('This will permanently delete ALL your tasks and domains.\n\nType "DELETE" to confirm:');
    if (confirmText !== 'DELETE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        return;
    }

    const btn = document.getElementById('btn-wipe-data');
    btn.disabled = true;
    btn.textContent = 'Wiping...';

    try {
        const response = await fetch('/api/import/wipe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok && data.success) {
            alert(`Deleted ${data.tasks_deleted} tasks and ${data.domains_deleted} domains.`);
            window.location.reload();
        } else {
            alert(data.detail || 'Wipe failed');
        }
    } catch (e) {
        alert('Failed to connect to server');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Wipe All Data';
    }
}

// Backup functions
async function exportBackup() {
    const btn = document.getElementById('btn-export-backup');
    const statusWrap = document.getElementById('backup-status-wrap');
    const status = document.getElementById('backup-status');
    btn.disabled = true;
    btn.textContent = 'Exporting...';
    statusWrap.style.display = 'none';

    try {
        const response = await fetch('/api/backup/export');

        if (!response.ok) {
            throw new Error('Export failed');
        }

        // Get filename from Content-Disposition header
        const disposition = response.headers.get('Content-Disposition');
        const filenameMatch = disposition && disposition.match(/filename="(.+)"/);
        const filename = filenameMatch ? filenameMatch[1] : 'whendoist_backup.json';

        // Download the file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        status.textContent = '‚úÖ Backup downloaded successfully';
        status.className = 'expand-status success';
        statusWrap.style.display = 'block';
    } catch (e) {
        status.textContent = '‚ùå Export failed: ' + e.message;
        status.className = 'expand-status error';
        statusWrap.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Download Backup';
    }
}

async function importBackup(input) {
    const file = input.files[0];
    if (!file) return;

    // Confirm before importing
    const confirmText = prompt('This will REPLACE all your current data with the backup.\n\nType "RESTORE" to confirm:');
    if (confirmText !== 'RESTORE') {
        if (confirmText !== null) {
            alert('Confirmation text did not match. Operation cancelled.');
        }
        input.value = '';
        return;
    }

    const btn = document.getElementById('btn-import-backup');
    const statusWrap = document.getElementById('backup-status-wrap');
    const status = document.getElementById('backup-status');
    btn.disabled = true;
    btn.textContent = 'Restoring...';
    statusWrap.style.display = 'none';

    try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/backup/import', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            status.textContent = `‚úÖ Restored: ${data.domains} domains, ${data.tasks} tasks`;
            status.className = 'expand-status success';
            statusWrap.style.display = 'block';
            setTimeout(() => window.location.reload(), 1500);
        } else {
            // API returned an error response
            const errorMsg = data.detail || data.message || 'Import failed';
            throw new Error(errorMsg);
        }
    } catch (e) {
        // If response wasn't JSON, e.message will contain the parse error
        // but we want to show a more helpful message
        let errorMessage = e.message;
        if (e.message.includes('Unexpected token')) {
            errorMessage = 'Server error - check logs for details';
        }
        status.textContent = '‚ùå Restore failed: ' + errorMessage;
        status.className = 'expand-status error';
        statusWrap.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Restore Backup';
        input.value = '';
    }
}

// Show tasks needing clarity assignment
async function showUnclearTasks() {
    const container = document.getElementById('unclear-tasks-container');
    const btn = document.getElementById('btn-show-unclear');

    // Toggle visibility
    if (container.classList.contains('visible')) {
        container.classList.remove('visible');
        btn.textContent = 'Assign Clarity';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Loading...';

    try {
        const response = await fetch('/api/tasks?clarity=none');
        const tasks = await response.json();

        if (tasks.length === 0) {
            container.innerHTML = '<div class="unclear-empty">All tasks have clarity assigned. Energy filtering is fully available.</div>';
        } else {
            container.innerHTML = `
                <div class="unclear-tasks__hd">
                    ${tasks.length} task${tasks.length === 1 ? '' : 's'} need clarity
                    <span class="unclear-hint">Assign clarity to enable energy-based filtering</span>
                </div>
                ${tasks.map(task => `
                    <div class="unclear-task-row" data-task-id="${task.id}">
                        <span class="unclear-task-title">${escapeHtml(task.title)}</span>
                        <div class="clarity-btns">
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'executable')" title="Clear next action, can do when tired">Exec</button>
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'defined')" title="Know what to do, needs some focus">Def</button>
                            <button type="button" class="clarity-btn" onclick="setTaskClarity(${task.id}, 'exploratory')" title="Needs research or deep thinking">Expl</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        container.classList.add('visible');
    } catch (e) {
        container.innerHTML = '<div class="unclear-empty">Failed to load tasks</div>';
        container.classList.add('visible');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Hide';
    }
}

async function setTaskClarity(taskId, clarity) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clarity })
        });

        if (response.ok) {
            const item = document.querySelector(`.unclear-task-row[data-task-id="${taskId}"]`);
            if (item) {
                item.remove();
                const container = document.getElementById('unclear-tasks-container');
                const remaining = container.querySelectorAll('.unclear-task-row').length;
                if (remaining === 0) {
                    container.innerHTML = '<div class="unclear-empty">All tasks have clarity assigned.</div>';
                } else {
                    const header = container.querySelector('.unclear-tasks__hd');
                    if (header) {
                        header.textContent = `${remaining} task${remaining === 1 ? '' : 's'} without clarity`;
                    }
                }
            }
        }
    } catch (e) {
        console.error('Failed to update task clarity:', e);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// Task Display Preferences
// ============================================================================

async function updatePreference(key, value) {
    try {
        const response = await fetch('/api/preferences', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [key]: value })
        });

        if (!response.ok) {
            console.error('Failed to update preference:', key);
        }
    } catch (e) {
        console.error('Failed to update preference:', e);
    }
}

function togglePreference(toggle, key) {
    const isEnabled = toggle.classList.contains('enabled');
    const newValue = !isEnabled;

    toggle.classList.toggle('enabled');
    updatePreference(key, newValue);
}

function setRetention(days) {
    const control = document.querySelector('[data-pref="completed_retention_days"]');
    control.querySelectorAll('.segmented-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.value) === days);
    });
    updatePreference('completed_retention_days', days);
}

function setPlacement(moveToBottom) {
    const control = document.querySelector('[data-pref="completed_move_to_bottom"]');
    control.querySelectorAll('.segmented-btn').forEach(btn => {
        btn.classList.toggle('active', (btn.dataset.value === 'true') === moveToBottom);
    });
    updatePreference('completed_move_to_bottom', moveToBottom);
}
</script>
{% endblock %}
